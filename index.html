<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>사랑방 띵곡 플레이어</title>
  <style>
    body{font-family:system-ui,-apple-apple-system,Segoe UI,Roboto,sans-serif;background:#111;color:#eee;margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh}
    .wrap{max-width:900px;margin:24px auto;padding:0 16px;width:100%}
    .card{border:1px solid #444;border-radius:10px;padding:16px;margin:12px 0;background:#222;box-shadow:0 4px 6px rgba(0,0,0,.1)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{background:#63b3ed;color:#fff;border:0;border-radius:999px;padding:.6rem 1rem;cursor:pointer;transition:background .2s}
    .btn:hover{background:#4299e1}
    .btn:disabled{background:#4a5568;cursor:not-allowed}
    .btn-toggle{background:#555}
    .btn-toggle.active{background:#fc8181}
    .muted{color:#a0aec0}
    input{background:#1f2937;color:#eee;border:1px solid #374151;border-radius:8px;padding:.55rem .7rem;flex:1;min-width:220px;outline:none;transition:border-color .2s}
    input:focus{border-color:#63b3ed}
    .item{display:flex;justify-content:space-between;align-items:center;padding:.5rem .6rem;border-bottom:1px solid #2f3743;cursor:pointer;transition:background .2s}
    .item:hover{background:#2a3340}
    .item:last-child{border-bottom:none}
    .item .delete-btn{background:none;border:none;color:#fc8181;cursor:pointer;font-size:1.2em;line-height:1;margin-left:10px;opacity:.7;transition:opacity .2s}
    .item .delete-btn:hover{opacity:1}
    .item .info-icon{background:none;border:none;color:#63b3ed;cursor:pointer;font-size:1.2em;margin-right:5px}
    .video-player{aspect-ratio:16/9;width:100%;max-width:800px;margin:8px auto;border-radius:8px;overflow:hidden;position:relative}
    .main-title{text-align:center}
    .sub-title{text-align:center;font-size:.9em;margin-top:-15px;color:#a0aec0}
    .message-box{display:none;background:#2d3748;color:#fff;padding:12px;border-radius:8px;text-align:center;position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:1000}
    #player{height:100%;width:100%}
    .player-controls{display:none}
    .modal{display:none;position:fixed;z-index:1001;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.4);justify-content:center;align-items:center}
    .modal-content{background-color:#222;padding:20px;border:1px solid #444;width:80%;max-width:500px;border-radius:10px;position:relative}
    .modal-content .modal-section{margin-bottom:15px}
    .modal-content .modal-section label{display:block;margin-bottom:5px;font-weight:bold}
    .modal-content input[type="text"],.modal-content textarea{width:100%;box-sizing:border-box;background:#1f2937;color:#eee;border:1px solid #374151;border-radius:8px;padding:10px;outline:none}
    .modal-content textarea{height:100px;resize:vertical}
    .modal-content .close-btn{color:#aaa;float:right;font-size:28px;font-weight:bold}
    .modal-content .close-btn:hover,.modal-content .close-btn:focus{color:#fff;text-decoration:none;cursor:pointer}
    .modal-content .save-btn{background:#38b2ac;color:#fff;border:0;border-radius:999px;padding:.6rem 1rem;margin-top:10px;cursor:pointer}
    .confirm-modal{display:none;position:fixed;z-index:1002;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.4);justify-content:center;align-items:center}
    .confirm-modal-content{background-color:#222;padding:20px;border:1px solid #444;width:80%;max-width:350px;border-radius:10px;text-align:center}
    .confirm-modal-buttons{display:flex;justify-content:space-around}
    .confirm-modal-buttons .btn{min-width:100px}
    #currentSongNotes{border-top:1px solid #444;margin-top:10px;padding-top:10px}
    .song-details{flex:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;display:flex;align-items:center}
    .buster-call-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.8);color:#fff;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;font-weight:bold;text-shadow:2px 2px 4px rgba(0,0,0,.5);z-index:999;transition:opacity .5s ease-in-out;opacity:0;pointer-events:none}
    .buster-call-overlay.show{opacity:1}
    .song-info-container{display:flex;align-items:center;justify-content:center;margin-top:10px;gap:10px;font-size:1.2em;font-weight:bold;text-align:center}
    .song-info-text{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:calc(100% - 120px);display:flex;align-items:center;justify-content:center}
    .current-info-btn{background:none;border:none;color:#63b3ed;cursor:pointer;font-size:1.2em;margin-right:5px;padding:0;width:40px;height:40px;display:flex;justify-content:center;align-items:center}
    .new-tag{background-color:#f6ad55;color:#fff;font-size:.7em;font-weight:bold;padding:2px 6px;border-radius:999px;margin-left:8px;vertical-align:middle;text-transform:uppercase}
  </style>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
<div id="message-box" class="message-box"></div>
<div class="wrap">
  <div class="main-title">
    <h1>사랑방 띵곡 플레이어</h1>
    <p class="sub-title">작가님들의 띵곡을 추천해주세요</p>
  </div>

  <div class="card">
    <div id="player-container" class="video-player">
      <div id="player"></div>
      <div class="player-controls">
        <button id="prev-song-btn" class="prev">&lt;</button>
        <button id="next-song-btn" class="next">&gt;</button>
      </div>
      <div id="buster-call-overlay" class="buster-call-overlay">
        <h2>버스터콜!!!</h2>
        <p>모두집중!!!</p>
      </div>
    </div>

    <div class="song-info-container">
      <button id="prev-song-btn-inline" class="btn">&lt;</button>
      <div id="currentSongInfo" class="song-info-text">
        <span class="muted">현재 재생 중인 곡이 없습니다.</span>
      </div>
      <button id="next-song-btn-inline" class="btn">&gt;</button>
    </div>

    <div id="currentSongNotes"><span class="muted"></span></div>

    <div class="row" style="margin-top:10px">
      <input id="url" placeholder="유튜브 링크 또는 ID를 붙여넣기" />
      <button id="add" class="btn">추가</button>
      <button id="shuffleBtn" class="btn">셔플</button>
      <button id="togglePlayerBtn" class="btn">화면 숨기기</button>
      <button id="busterCallToggle" class="btn btn-toggle">버스터콜</button>
    </div>

    <div id="manual-input" style="display:none;margin-top:10px">
      <div class="row"><input id="manualTitle" placeholder="제목을 수동으로 입력해주세요" /></div>
      <div class="row" style="margin-top:10px"><input id="manualArtist" placeholder="아티스트를 수동으로 입력해주세요" /></div>
    </div>

    <div id="playlist" class="card" style="margin:10px 0 0 0">
      <div class="muted">재생목록이 비어있습니다.</div>
    </div>
  </div>
</div>

<!-- 정보 모달 -->
<div id="infoModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h3>노래 정보</h3>
    <div class="modal-section">
      <label for="songTitleInput">노래 제목</label>
      <input type="text" id="songTitleInput" placeholder="노래 제목을 입력하세요..." />
    </div>
    <div class="modal-section">
      <label for="artistInput">아티스트</label>
      <input type="text" id="artistInput" placeholder="아티스트 이름을 입력하세요..." />
    </div>
    <div class="modal-section">
      <label for="uploaderInput">올린 사람</label>
      <input type="text" id="uploaderInput" placeholder="이름을 입력하세요..." />
    </div>
    <div class="modal-section">
      <label for="infoTextarea">노래에 대한 정보</label>
      <textarea id="infoTextarea" placeholder="노트에 메모를 입력하세요..."></textarea>
    </div>
    <div class="modal-section">
      <label for="commentTextarea">댓글</label>
      <textarea id="commentTextarea" placeholder="댓글을 입력하세요..."></textarea>
    </div>
    <button id="saveInfoBtn" class="save-btn">저장</button>
  </div>
</div>

<!-- 삭제 확인 모달 -->
<div id="confirmModal" class="confirm-modal">
  <div class="confirm-modal-content">
    <p>정말로 삭제하시겠습니까?</p>
    <div class="confirm-modal-buttons">
      <button id="confirmYes" class="btn">예</button>
      <button id="confirmNo" class="btn btn-toggle">아니오</button>
    </div>
  </div>
</div>

<script>
  // --- 설정 ---
  const YOUTUBE_API_KEY = "AIzaSyB2GymrywkBYx4Mbt_xHNiYEV44MbfKY2w";
  const firebaseConfig = {
    apiKey: "AIzaSyDz6xGJNKXinG5rREjdrPz7toIYGZXzilU",
    authDomain: "sarangbangmusicplaylist.firebaseapp.com",
    projectId: "sarangbangmusicplaylist",
    storageBucket: "sarangbangmusicplaylist.apppt.com",
    messagingSenderId: "193412502606",
    appId: "1:193412502606:web:0f7f9ddbef1ee6711d1ff",
    measurementId: "G-L14GH3BHYD"
  };

  // --- 요소 ---
  const urlInput = document.getElementById('url');
  const addBtn = document.getElementById('add');
  const shuffleBtn = document.getElementById('shuffleBtn');
  const listEl = document.getElementById('playlist');
  const messageBox = document.getElementById('message-box');
  const manualInputDiv = document.getElementById('manual-input');
  const manualTitleInput = document.getElementById('manualTitle');
  const manualArtistInput = document.getElementById('manualArtist');
  const busterCallToggleBtn = document.getElementById('busterCallToggle');
  const prevSongBtn = document.getElementById('prev-song-btn-inline');
  const nextSongBtn = document.getElementById('next-song-btn-inline');
  const currentSongInfoEl = document.getElementById('currentSongInfo');
  const currentSongNotesEl = document.getElementById('currentSongNotes');
  const busterCallOverlay = document.getElementById('buster-call-overlay');
  const togglePlayerBtn = document.getElementById('togglePlayerBtn');
  const playerContainer = document.getElementById('player-container');

  // 모달
  const infoModal = document.getElementById('infoModal');
  const songTitleInput = document.getElementById('songTitleInput');
  const artistInput = document.getElementById('artistInput');
  const uploaderInput = document.getElementById('uploaderInput');
  const infoTextarea = document.getElementById('infoTextarea');
  const commentTextarea = document.getElementById('commentTextarea');
  const saveInfoBtn = document.getElementById('saveInfoBtn');
  const modalCloseBtn = document.querySelector('.modal .close-btn');
  let currentInfoVideoId = null;

  // 확인 모달
  const confirmModal = document.getElementById('confirmModal');
  const confirmYesBtn = document.getElementById('confirmYes');
  const confirmNoBtn = document.getElementById('confirmNo');

  // --- 상태 ---
  const appId = 'default-app-id';
  const clientId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Math.random());
  let userId = null;
  const globalState = {
    playlist: [],            // Firestore에 저장되는 원본 목록
    shuffledPlaylist: [],    // 로컬 전용 셔플 목록(업로드 안 함)
    isShuffled: false,
    videoId: '',
    timestamp: 0,
    lastUpdatedBy: null,
    currentPlayingIndex: -1,
    isBusterCallMode: false,
    lastBusterCallTimestamp: 0,
    busterCallCoolDown: 30 * 1000,
    isPlayerVisible: true
  };

  let authed = false;
  let player, playerReady = false;
  let isManuallyAdding = false;

  // --- 공통 UI 함수 ---
  function showMessage(message, type='info'){
    messageBox.textContent = message;
    messageBox.style.background = (type === 'error') ? '#fc8181' : '#2d3748';
    messageBox.style.display = 'block';
    setTimeout(()=>{ messageBox.style.display='none'; }, 2000);
  }
  function showConfirm(message){
    document.querySelector('#confirmModal p').textContent = message;
    confirmModal.style.display = 'flex';
    return new Promise(resolve=>{
      confirmYesBtn.onclick = ()=>{ confirmModal.style.display='none'; resolve(true); };
      confirmNoBtn.onclick = ()=>{ confirmModal.style.display='none'; resolve(false); };
    });
  }

  // --- 부팅 ---
  async function boot(){
    try{ firebase.initializeApp(firebaseConfig); }catch(e){ console.error(e); return; }
    try{ await firebase.auth().signInAnonymously(); authed=true; userId=firebase.auth().currentUser.uid; }catch(e){ console.error(e); return; }

    // 핑
    const db=firebase.firestore();
    try{
      await db.collection('artifacts').doc(appId).collection('public').doc('_ping')
        .set({ pong:true, by:clientId, at:new Date() }, { merge:true });
    }catch(e){ console.error(e); }

    startRealtime();
    wireUI();
  }

  // --- YouTube ---
  function onYouTubeIframeAPIReady(){
    playerReady = true;
    player = new YT.Player('player', {
      height:'100%', width:'100%', videoId:'',
      playerVars:{ autoplay:0, controls:1, disablekb:1, fs:0, iv_load_policy:3, modestbranding:1, rel:0, showinfo:0 },
      events:{ onStateChange:onPlayerStateChange, onReady:onPlayerReady }
    });
  }
  function onPlayerReady(){}
  function onPlayerStateChange(e){
    switch(e.data){
      case YT.PlayerState.ENDED: playNext(); break;
      case YT.PlayerState.PLAYING:
        const vid = player.getVideoData().video_id;
        if (vid && vid.length===11) updatePlayingSong(vid);
        break;
      case YT.PlayerState.PAUSED: globalState.timestamp = player.getCurrentTime(); break;
    }
  }

  // --- Firestore 실시간 ---
  function startRealtime(){
    const db = firebase.firestore();

    // 버스터콜 상태
    db.collection('artifacts').doc(appId).collection('public')
      .collection('buster_call_state').doc('main_state')
      .onSnapshot(snap=>{
        if (!snap.exists) return;
        const s = snap.data();
        if (s && s.lastBusterCallTimestamp){
          globalState.lastBusterCallTimestamp = s.lastBusterCallTimestamp.toMillis();
          checkBusterCallCooldown();
        }
      });

    // 재생 상태
    db.collection('artifacts').doc(appId).collection('public')
      .collection('playback_state').doc('main_state')
      .onSnapshot(snap=>{
        if (!snap.exists) return;
        const s = snap.data()||{};
        if (s.lastUpdatedBy === clientId) return;
        try{
          if (playerReady && s.videoId && globalState.videoId !== s.videoId){
            player.loadVideoById(s.videoId);
            player.seekTo(s.timestamp||0, true);
          }
        }catch(e){ console.error(e); }
      });

    // 재생 목록
    db.collection('artifacts').doc(appId).collection('public')
      .collection('playlist_state').doc('main_playlist')
      .onSnapshot(snap=>{
        if (!snap.exists){ savePlaylistState(); return; }
        const data = snap.data()||{};
        const sorted = Array.isArray(data.playlist) ? data.playlist.sort((a,b)=>{
          const A=(a.artist||'').toLowerCase(), B=(b.artist||'').toLowerCase();
          return A<B?-1:A>B?1:0;
        }) : [];
        globalState.playlist = sorted;

        // 셔플은 로컬 전용
        if (globalState.isShuffled){
          const now=Date.now(), day=24*60*60*1000;
          const isNewSong = it=>{
            const t = it.createdAt?.toDate ? it.createdAt.toDate().getTime() : it.createdAt?.getTime?.();
            return t && (now - t) < day;
          };
          const newSongs = sorted.filter(isNewSong);
          const oldSongs = sorted.filter(it=>!isNewSong(it));
          const shuffledOld = [...oldSongs].sort(()=>Math.random()-0.5);
          globalState.shuffledPlaylist = [...newSongs, ...shuffledOld];
        }else{
          globalState.shuffledPlaylist = [];
        }

        renderList();
        if (player && player.getPlayerState() === YT.PlayerState.PLAYING){
          updatePlayingSong(player.getVideoData().video_id);
        }
      });

    // 노트 변경 시 현재 곡 노트 갱신(공유 경로)
    db.collection('artifacts').doc(appId).collection('public')
      .collection('notes')
      .onSnapshot(()=>{ renderCurrentSongNotes(); });
  }

  // --- 파이어스토어 저장(원본 playlist만) ---
  let playlistSaveTimer=null;
  function savePlaylistState(){
    if (!authed) return;
    if (playlistSaveTimer) clearTimeout(playlistSaveTimer);
    playlistSaveTimer = setTimeout(async ()=>{
      try{
        const db=firebase.firestore();
        const ref=db.collection('artifacts').doc(appId).collection('public')
          .collection('playlist_state').doc('main_playlist');
        const valid = globalState.playlist.map(x=>({...x, createdAt:x.createdAt||new Date()}));
        await ref.set({
          playlist: valid,
          lastUpdatedBy: clientId,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
      }catch(e){ console.error(e); }
    }, 300);
  }
  function updatePlaylist(newPlaylist){
    globalState.playlist = newPlaylist; // 셔플 순서 아님
    savePlaylistState();
  }

  // --- NEW 판정 + 가시 리스트 ---
  function isNew(item){
    const t = item?.createdAt?.toDate ? item.createdAt.toDate().getTime()
            : item?.createdAt?.getTime?.();
    if (!t) return false;
    return (Date.now() - t) < 24*60*60*1000;
  }
  function getVisibleList(){
    if (globalState.isShuffled) return globalState.shuffledPlaylist;
    return [...globalState.playlist].sort((a,b)=>{
      const an=isNew(a), bn=isNew(b);
      if (an && !bn) return -1;
      if (!an && bn) return 1;
      const A=(a.artist||'').toLowerCase(), B=(b.artist||'').toLowerCase();
      return A<B?-1:A>B?1:0;
    });
  }

  // --- 렌더 ---
  function renderList(){
    listEl.innerHTML='';
    const vis = getVisibleList();
    if (!vis.length){
      listEl.innerHTML='<div class="muted">재생목록이 비어있습니다.</div>';
      renderCurrentSongInfo();
      return;
    }

    vis.forEach((item, index)=>{
      const div=document.createElement('div');
      div.className='item';
      div.dataset.videoId=item.videoId;
      div.dataset.index=index;

      const songDetails=document.createElement('div');
      songDetails.className='song-details';

      const infoIcon=document.createElement('button');
      infoIcon.className='info-icon';
      infoIcon.innerHTML='&#x24D8;';
      infoIcon.addEventListener('click',e=>{
        e.stopPropagation();
        openInfoModal(item.videoId);
      });
      songDetails.appendChild(infoIcon);

      const titleSpan=document.createElement('span');
      titleSpan.textContent=`${item.artist} - ${item.title}`;
      songDetails.appendChild(titleSpan);

      if (isNew(item)){
        const tag=document.createElement('span');
        tag.className='new-tag';
        tag.textContent='new';
        titleSpan.prepend(tag,' ');
      }

      const deleteBtn=document.createElement('button');
      deleteBtn.className='delete-btn';
      deleteBtn.innerHTML='&#x2715;';
      deleteBtn.addEventListener('click',async e=>{
        e.stopPropagation();
        if (await showConfirm("정말로 삭제하시겠습니까?")){
          const np=[...globalState.playlist].filter(s=>s.videoId!==item.videoId);
          updatePlaylist(np);
        }
      });

      div.appendChild(songDetails);
      div.appendChild(deleteBtn);

      div.addEventListener('click',()=>{
        if (globalState.isBusterCallMode){
          const now=Date.now(), last=globalState.lastBusterCallTimestamp;
          if (now-last>globalState.busterCallCoolDown){
            busterCall(item.videoId);
            globalState.isBusterCallMode=false;
            busterCallToggleBtn.classList.remove('active');
          }else{
            const remain=Math.ceil((globalState.busterCallCoolDown-(now-last))/1000);
            showMessage(`버스터콜은 ${remain}초 후에 다시 사용할 수 있습니다.`);
            globalState.isBusterCallMode=false;
            busterCallToggleBtn.classList.remove('active');
          }
        }else{
          playVideo(index); // 가시 리스트 인덱스 사용
          showMessage("해당 곡을 재생합니다.");
        }
      });

      listEl.appendChild(div);
    });

    if (vis.length>0 && (!player || !player.getVideoData())) playVideo(0);
    renderCurrentSongInfo();
  }

  function renderCurrentSongInfo(){
    const vis=getVisibleList();
    const cur=vis[globalState.currentPlayingIndex];
    if (cur){
      const btn=`<button class="current-info-btn" onclick="openInfoModal('${cur.videoId}')">&#x24D8;</button>`;
      const txt=`<span style="font-weight:bold">${cur.title}</span><span class="muted" style="margin-left:5px"> - ${cur.artist}</span>`;
      currentSongInfoEl.innerHTML = btn+txt;
      renderCurrentSongNotes();
    }else{
      currentSongInfoEl.innerHTML='<span class="muted">현재 재생 중인 곡이 없습니다.</span>';
      currentSongNotesEl.innerHTML='';
    }
  }

  async function renderCurrentSongNotes(){
    currentSongNotesEl.innerHTML='<span class="muted">정보를 불러오는 중...</span>';
    const videoId=globalState.videoId;
    if (!videoId){
      currentSongNotesEl.innerHTML='<span class="muted">작성된 정보가 없습니다.</span>'; return;
    }
    const db=firebase.firestore();
    const docRef=db.collection('artifacts').doc(appId).collection('public').collection('notes').doc(videoId);
    try{
      const snap=await docRef.get();
      if (!snap.exists){
        currentSongNotesEl.innerHTML='<span class="muted">작성된 정보가 없습니다.</span>'; return;
      }
      const d=snap.data()||{};
      currentSongNotesEl.innerHTML = `
        <p><strong>올린 사람:</strong> ${d.uploader||'알 수 없음'}</p>
        <p><strong>노래 정보:</strong> ${d.info||'작성된 정보가 없습니다.'}</p>
        <p><strong>댓글:</strong> ${d.comment||'작성된 댓글이 없습니다.'}</p>
      `;
    }catch(e){
      console.error(e);
      currentSongNotesEl.innerHTML='<span class="muted">정보를 불러오는 데 실패했습니다.</span>';
    }
  }

  function updatePlayingSong(videoId){
    const vis=getVisibleList();
    const idx=vis.findIndex(it=>it.videoId===videoId);
    if (idx!==-1){
      globalState.currentPlayingIndex=idx;
      globalState.videoId=videoId;
      renderCurrentSongInfo();
    }else{
      globalState.currentPlayingIndex=-1;
      globalState.videoId='';
      currentSongInfoEl.innerHTML='<span class="muted">재생목록에 없는 곡입니다.</span>';
      currentSongNotesEl.innerHTML='';
    }
  }

  // --- 재생 ---
  function playVideo(index){
    const vis=getVisibleList();
    if (!vis.length) return;
    if (index>=vis.length) index=0; else if (index<0) index=vis.length-1;
    const next=vis[index];
    if (next && player){
      try{
        player.loadVideoById(next.videoId,0);
        player.playVideo();
        updatePlayingSong(next.videoId);
      }catch(e){ console.error(e); }
    }
  }
  function playNext(){
    const vis=getVisibleList(); if (!vis.length) return;
    playVideo((globalState.currentPlayingIndex+1)%vis.length);
  }
  function playPrev(){
    const vis=getVisibleList(); if (!vis.length) return;
    playVideo((globalState.currentPlayingIndex-1+vis.length)%vis.length);
  }

  function togglePlayerVisibility(){
    globalState.isPlayerVisible=!globalState.isPlayerVisible;
    if (globalState.isPlayerVisible){
      playerContainer.style.height='auto';
      togglePlayerBtn.textContent='화면 숨기기';
      playerContainer.style.opacity='1';
    }else{
      playerContainer.style.height='0';
      togglePlayerBtn.textContent='화면 보기';
      playerContainer.style.opacity='0';
    }
  }

  // --- 정보 모달 ---
  function openInfoModal(videoId){
    currentInfoVideoId=videoId;
    const item=globalState.playlist.find(it=>it.videoId===videoId);
    songTitleInput.value=item?item.title:'';
    artistInput.value=item?item.artist:'';

    const db=firebase.firestore();
    const docRef=db.collection('artifacts').doc(appId).collection('public').collection('notes').doc(videoId);
    docRef.get().then(snap=>{
      if (snap.exists){
        const d=snap.data()||{};
        uploaderInput.value=d.uploader||'';
        infoTextarea.value=d.info||'';
        commentTextarea.value=d.comment||'';
      }else{
        uploaderInput.value=''; infoTextarea.value=''; commentTextarea.value='';
      }
    }).catch(e=>{
      console.error(e);
      uploaderInput.value=''; infoTextarea.value='불러오기 실패'; commentTextarea.value='';
    });

    infoModal.style.display='flex';
  }
  function closeInfoModal(){ infoModal.style.display='none'; currentInfoVideoId=null; }

  async function saveInfo(){
    if (!currentInfoVideoId || !authed) return;

    // 곡 메타 업데이트(원본 playlist 저장)
    const np=[...globalState.playlist];
    const i=np.findIndex(it=>it.videoId===currentInfoVideoId);
    if (i!==-1){
      np[i].title=(songTitleInput.value||'').trim();
      np[i].artist=(artistInput.value||'').trim();
      updatePlaylist(np); // Firestore에 playlist 저장
    }

    // 공유 노트 Firestore 저장
    const db=firebase.firestore();
    const notesRef=db.collection('artifacts').doc(appId).collection('public').collection('notes').doc(currentInfoVideoId);
    try{
      await notesRef.set({
        uploader:(uploaderInput.value||'').trim(),
        info:(infoTextarea.value||'').trim(),
        comment:(commentTextarea.value||'').trim(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });
      showMessage("노트가 저장되었습니다.","ok");
      closeInfoModal();
    }catch(e){
      console.error(e);
      showMessage("노트 저장 실패: "+e.message,"error");
    }
  }

  // --- 버스터콜 ---
  function saveBusterCallState(){
    if (!authed) return;
    const db=firebase.firestore();
    db.collection('artifacts').doc(appId).collection('public')
      .collection('buster_call_state').doc('main_state')
      .set({ lastBusterCallTimestamp: firebase.firestore.FieldValue.serverTimestamp(), updatedBy: clientId }, { merge:true })
      .catch(e=>console.error(e));
  }
  function busterCall(videoId){
    if (!authed){ showMessage("로그인되지 않았습니다.","error"); return; }
    try{
      const db=firebase.firestore();
      db.collection('artifacts').doc(appId).collection('public')
        .collection('playback_state').doc('main_state')
        .set({ videoId, timestamp:0, lastUpdatedBy:clientId, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });

      showMessage("모든 사용자에게 버스터콜을 보냈습니다!","ok");
      saveBusterCallState();

      busterCallOverlay.classList.add('show');
      setTimeout(()=>{ busterCallOverlay.classList.remove('show'); }, 3000);

      player.loadVideoById(videoId,0);
      player.playVideo();
      updatePlayingSong(videoId);
    }catch(e){
      console.error(e);
      showMessage("버스터콜에 실패했습니다. "+e.message,"error");
    }
  }
  function checkBusterCallCooldown(){
    const now=Date.now();
    const remain=globalState.lastBusterCallTimestamp+globalState.busterCallCoolDown-now;
    if (remain>0){
      const sec=Math.ceil(remain/1000);
      busterCallToggleBtn.disabled=true;
      busterCallToggleBtn.textContent=`버스터콜 (${sec}초)`;
      setTimeout(checkBusterCallCooldown,1000);
    }else{
      busterCallToggleBtn.disabled=false;
      busterCallToggleBtn.textContent='버스터콜';
    }
  }

  // --- 유틸 ---
  function getVideoId(url){
    if (url.length===11 && !url.includes(' ')) return url;
    url=url.replace('music.youtube.com','www.youtube.com');
    const regex=/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
    const m=url.match(regex);
    return (m && m[1])? m[1] : null;
  }
  async function fetchVideoDetails(videoId){
    const apiUrl=`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${YOUTUBE_API_KEY}`;
    const res=await fetch(apiUrl);
    if (!res.ok) throw new Error(`API Error: ${res.status} ${res.statusText}`);
    const data=await res.json();
    if (data.items && data.items.length>0){
      const s=data.items[0].snippet;
      return { title:s.title, artist:s.channelTitle };
    }
    throw new Error("Failed to find video information.");
  }

  // --- UI 배선 ---
  function wireUI(){
    addBtn.addEventListener('click', async ()=>{
      if (isManuallyAdding){
        const url=(urlInput.value||'').trim();
        const videoId=getVideoId(url);
        const title=manualTitleInput.value.trim();
        const artist=manualArtistInput.value.trim();
        if (!videoId){ showMessage("유효한 유튜브 링크 또는 ID를 입력해주세요.","error"); return; }
        if (!title || !artist){ showMessage("제목과 아티스트를 모두 입력해주세요.","error"); return; }
        const np=[...globalState.playlist, { title, artist, videoId, createdAt:new Date() }];
        updatePlaylist(np);
        urlInput.value=''; manualTitleInput.value=''; manualArtistInput.value='';
        isManuallyAdding=false; manualInputDiv.style.display='none'; addBtn.textContent='추가';
        showMessage('곡이 성공적으로 추가되었습니다.','ok');
        return;
      }

      const url=(urlInput.value||'').trim();
      const videoId=getVideoId(url);
      if (!videoId){ showMessage("유효한 유튜브 링크 또는 ID를 입력해주세요.","error"); return; }
      addBtn.textContent='불러오는 중...'; addBtn.disabled=true;
      try{
        const vd=await fetchVideoDetails(videoId);
        const np=[...globalState.playlist, { title:vd.title, artist:vd.artist, videoId, createdAt:new Date() }];
        updatePlaylist(np);
        urlInput.value=''; manualInputDiv.style.display='none'; isManuallyAdding=false;
        showMessage('곡이 성공적으로 추가되었습니다.','ok');
      }catch(e){
        console.error(e);
        if (e.message.includes('403')){
          showMessage("API 키 사용량 초과 또는 유효하지 않은 키입니다. 수동으로 제목과 아티스트를 입력해주세요.","error");
          isManuallyAdding=true; manualInputDiv.style.display='block'; addBtn.textContent='수동 추가';
        }else{
          showMessage("동영상 정보를 가져오는 데 실패했습니다: "+e.message,'error');
        }
      }finally{
        addBtn.disabled=false;
        if (!isManuallyAdding) addBtn.textContent='추가';
      }
    });

    shuffleBtn.addEventListener('click', ()=>{
      if (globalState.isShuffled){
        globalState.isShuffled=false;
        globalState.shuffledPlaylist=[]; // 업로드 없음
        shuffleBtn.textContent='셔플';
        showMessage("재생목록 정렬");
      }else{
        if (!globalState.playlist.length){ showMessage("재생목록이 비어있습니다. 먼저 곡을 추가해주세요.","info"); return; }
        const now=Date.now(), day=24*60*60*1000;
        const isNewSong=it=>{
          const t=it.createdAt?.toDate ? it.createdAt.toDate().getTime() : it.createdAt?.getTime?.();
          return t && (now - t) < day;
        };
        const newSongs=globalState.playlist.filter(isNewSong);
        const oldSongs=globalState.playlist.filter(it=>!isNewSong(it));
        const shuffledOld=[...oldSongs].sort(()=>Math.random()-0.5);
        globalState.isShuffled=true;
        globalState.shuffledPlaylist=[...newSongs, ...shuffledOld]; // 로컬 전용
        shuffleBtn.textContent='정렬';
        showMessage("재생목록 셔플 (new 우선)");
      }
      renderList();
      playVideo(0);
    });

    busterCallToggleBtn.addEventListener('click', ()=>{
      globalState.isBusterCallMode=!globalState.isBusterCallMode;
      busterCallToggleBtn.classList.toggle('active', globalState.isBusterCallMode);
      busterCallToggleBtn.textContent="버스터콜";
      showMessage(globalState.isBusterCallMode?"버스터콜 모드가 활성화되었습니다. 재생목록을 눌러 버스터콜을 시작하세요.":"버스터콜 모드가 비활성화되었습니다.");
    });

    prevSongBtn.addEventListener('click', ()=>{ playPrev(); showMessage("이전 곡으로 넘어갑니다."); });
    nextSongBtn.addEventListener('click', ()=>{ playNext(); showMessage("다음 곡으로 넘어갑니다."); });
    togglePlayerBtn.addEventListener('click', togglePlayerVisibility);

    modalCloseBtn.addEventListener('click', closeInfoModal);
    saveInfoBtn.addEventListener('click', saveInfo);

    window.addEventListener('click', e=>{ if (e.target===infoModal) closeInfoModal(); });
  }

  // 전역 내보내기
  window.openInfoModal=openInfoModal;
  window.onload=boot;
</script>
</body>
</html>
