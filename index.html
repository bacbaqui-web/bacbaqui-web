<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë§Œí™” ì¼ì • ê´€ë¦¬</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
    body{font-family:'Noto Sans KR',sans-serif;background:#000;color:#fff;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px;flex-direction:column;gap:2rem}
    .notepad-section,.calendar-section{background:#2a2a2a;border-radius:12px;padding:24px;box-shadow:inset 0 0 10px rgba(0,0,0,.3);text-align:center;width:100%;max-width:1200px}
    .notepad-section{display:flex;flex-direction:column;padding-bottom:12px;padding-top:12px}
    .notepad-tabs{display:flex;justify-content:center;align-items:center;margin-bottom:12px;gap:1rem}
    .notepad-tab{background:#333;padding:8px 16px;border-radius:8px 8px 0 0;cursor:pointer;transition:.2s;font-weight:700}
    .notepad-tab.active{background:#1a1a1a}
    .notepad-tab:hover{background:#444}
    .notepad-section textarea{background:#1a1a1a;border:1px solid #333;color:#fff;padding:12px;border-radius:8px;min-height:900px;resize:vertical}
    .calendar-header{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:24px}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day-label,.calendar-day{text-align:center;padding:8px;border-radius:8px;background:#2a2a2a;position:relative;overflow:hidden;word-wrap:break-word}
    .day-label{background:#444;font-weight:700;color:#fff}
    .calendar-day{min-height:120px;padding-top:24px}
    .calendar-day.today{border:2px solid #ccc}
    .day-number{position:absolute;top:8px;left:8px;font-size:1.2rem;font-weight:700;color:#aaa}
    .task-item{font-size:.8rem;padding:4px;border-radius:4px;margin-top:4px;word-wrap:break-word;cursor:pointer}
    .task-item.custom-task{background:#4c78a8}
    .task-item.episode-task{background:#444;color:#ddd;cursor:pointer}
    .task-item.recurring-shorts{background:#7d4040;cursor:pointer}
    .task-item.recurring-instatoon{background:#999966;cursor:pointer}
    .task-item.complete{background:#888;text-decoration:line-through;color:#ccc}
    .add-task-btn{background:#666;transition:.2s}
    .add-task-btn:hover{background:#777;transform:scale(1.02)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:1000}
    .modal-content{background:#1a1a1a;border-radius:12px;padding:24px;width:90%;max-width:500px;box-shadow:0 10px 30px rgba(0,0,0,.5);position:relative}
    @media (max-width:768px){body{padding:16px;gap:1.5rem}.calendar-day{min-height:100px;padding-top:28px}.day-number{font-size:1rem}.task-item{font-size:.7rem}.calendar-grid,.calendar-header{gap:4px}.add-task-btn{width:100%}}
  </style>
</head>
<body class="text-white">

  <!-- ë¡œê·¸ì¸ ë°” -->
  <div id="authBar" class="w-full max-w-5xl mx-auto flex items-center justify-end gap-2">
    <span id="userInfo" class="text-sm opacity-80"></span>
    <button id="signInBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Google ë¡œê·¸ì¸</button>
    <button id="signOutBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded hidden">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <!-- ìº˜ë¦°ë” -->
  <div id="calendar-section" class="calendar-section">
    <div class="flex justify-between items-center mb-4">
      <button id="prevMonthBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">&lt; ì´ì „ ë‹¬</button>
      <h2 id="currentMonthYear" class="text-2xl font-bold"></h2>
      <button id="nextMonthBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">ë‹¤ìŒ ë‹¬ &gt;</button>
    </div>
    <div class="calendar-header mb-2">
      <div class="day-label">ì¼</div><div class="day-label">ì›”</div><div class="day-label">í™”</div>
      <div class="day-label">ìˆ˜</div><div class="day-label">ëª©</div><div class="day-label">ê¸ˆ</div><div class="day-label">í† </div>
    </div>
    <div id="calendarGrid" class="calendar-grid"></div>
    <div class="mt-8 text-center">
      <button id="addTaskBtn" class="add-task-btn px-6 py-3 rounded-full font-bold text-white shadow-md">+ ê°œì¸ ì‘ì—… ì¶”ê°€</button>
    </div>
  </div>

  <!-- ë©”ëª¨ì¥ -->
  <div id="notepad-section" class="notepad-section mt-8">
    <div class="notepad-tabs">
      <button class="notepad-tab active" data-tab="ë°”í€´ë©˜í„°ë¦¬">ë°”í€´ë©˜í„°ë¦¬</button>
      <button class="notepad-tab" data-tab="ì§ìŠ¹ìœ¡ì•„">ì§ìŠ¹ìœ¡ì•„</button>
      <button class="notepad-tab" data-tab="ê·¸ê±°ì•„ì„¸ìš”">ê·¸ê±°ì•„ì„¸ìš”</button>
      <button class="notepad-tab" data-tab="ë©”ëª¨">ë©”ëª¨</button>
    </div>
    <textarea id="notesArea" class="flex-grow"></textarea>
  </div>

  <!-- ëª¨ë‹¬ -->
  <div id="taskModal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle" class="text-2xl font-bold mb-4">ìƒˆ ì‘ì—…</h2>
      <label for="taskTitle" class="block mb-2">ì œëª©:</label>
      <input type="text" id="taskTitle" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 mb-4">
      <label for="taskDescription" class="block mb-2">ì„¤ëª…:</label>
      <textarea id="taskDescription" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 mb-4 h-24"></textarea>
      <label for="taskDate" class="block mb-2">ë‚ ì§œ:</label>
      <input type="date" id="taskDate" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 mb-4">
      <div class="flex justify-end gap-2">
        <button id="saveTaskBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">ì €ì¥</button>
        <button id="cancelBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">ì·¨ì†Œ</button>
        <button id="deleteTaskBtn" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg hidden">ì‚­ì œ</button>
      </div>
    </div>
  </div>

  <!-- ===== ì•± ìŠ¤í¬ë¦½íŠ¸ (UI/ë¡œì§) ===== -->
  <script>
    // ì „ì—­ ìƒíƒœ(ë™ê¸°í™” ê¸°ì¤€ì€ window.*ë¡œ í†µì¼)
    window.customTasks = window.customTasks || [];
    window.taskStatus  = window.taskStatus  || {};
    window.currentTask = null;
    window.activeTab   = 'ë°”í€´ë©˜í„°ë¦¬';
    let currentDate    = new Date();

    // ì„œìš¸ ì‹œê°„(Asia/Seoul) ê³ ì • í‚¤/ìš”ì¼ ê³„ì‚°
    const TZ = 'Asia/Seoul';
    function ymdKST(date){ // YYYY-MM-DD (KST)
      return new Intl.DateTimeFormat('en-CA',{timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit'}).format(date);
    }
    function toKST(date){ return new Date(date.toLocaleString('en-US',{timeZone:TZ})) }
    function countWeekdaysBetweenKST(startTime,endTime){
      let count=0;
      const start=toKST(new Date(Math.min(startTime,endTime)));
      const end  =toKST(new Date(Math.max(startTime,endTime)));
      const cur=new Date(start);
      while(cur<=end){ const d=cur.getDay(); if(d>=0&&d<=4) count++; cur.setDate(cur.getDate()+1); }
      return count;
    }

    // ê³ ì • ìŠ¤ì¼€ì¤„
    const fixedSchedules = [
      { title: 'ì‡¼ì¸ ', daysOfWeek: [1,3,5], colorClass: 'recurring-shorts' },
      { title: 'ì›¹íˆ°', daysOfWeek: [2,4,6], colorClass: 'recurring-instatoon' }
    ];

    // ê³µìš© DOM
    const taskModal = document.getElementById('taskModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveTaskBtn = document.getElementById('saveTaskBtn');
    const deleteTaskBtn = document.getElementById('deleteTaskBtn');
    const taskTitleInput = document.getElementById('taskTitle');
    const taskDescriptionInput = document.getElementById('taskDescription');
    const taskDateInput = document.getElementById('taskDate');

    // í† ìŠ¤íŠ¸
    const showFeedbackMessage = (message) => {
      const el = document.createElement('div');
      el.textContent = message;
      el.style.cssText = "position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.8);color:#fff;padding:16px 20px;border-radius:10px;z-index:2000;max-width:90%";
      document.body.appendChild(el);
      setTimeout(()=>el.remove(),2000);
    };

    // ì´ë²¤íŠ¸ ì—°ê²°
    const attachEventListeners = () => {
      const prevMonthBtn = document.getElementById('prevMonthBtn');
      const nextMonthBtn = document.getElementById('nextMonthBtn');
      const addTaskBtn  = document.getElementById('addTaskBtn');
      const notepadTabs = document.querySelectorAll('.notepad-tab');
      const notesArea   = document.getElementById('notesArea');

      prevMonthBtn?.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn?.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });
      addTaskBtn?.addEventListener('click', () => openModal());

      notepadTabs?.forEach(tab => {
        tab.addEventListener('click', () => {
          notepadTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          window.activeTab = tab.dataset.tab;
          if (window.__notesTabs) {
            notesArea.value = window.__notesTabs[window.activeTab] || '';
          } else if (window.cloudLoadNotes) {
            window.cloudLoadNotes();
          }
        });
      });

      // ë©”ëª¨ ìë™ ì €ì¥(ë””ë°”ìš´ìŠ¤ + blur)
      if (notesArea) {
        notesArea.addEventListener('input', () => window.cloudSaveNotesDebounced && window.cloudSaveNotesDebounced());
        notesArea.addEventListener('blur',  () => window.cloudSaveNotes && window.cloudSaveNotes());
      }

      cancelBtn.addEventListener('click', closeModal);
      saveTaskBtn.addEventListener('click', saveTask);
      deleteTaskBtn.addEventListener('click', () => window.deleteTask && window.deleteTask());
      taskModal.addEventListener('click', (e) => { if (e.target === taskModal) closeModal(); });
    };

    // ë‹¬ë ¥ ë Œë”
    const renderCalendar = () => {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const currentMonthYear = document.getElementById('currentMonthYear');
      const calendarGrid = document.getElementById('calendarGrid');
      if (!currentMonthYear || !calendarGrid) return;

      currentMonthYear.textContent = `${year}ë…„ ${month+1}ì›”`;
      calendarGrid.innerHTML = '';

      const firstDay = toKST(new Date(year, month, 1)).getDay();
      const daysInMonth = new Date(year, month+1, 0).getDate();

      for (let i=0;i<firstDay;i++) {
        const empty = document.createElement('div'); empty.className='calendar-day'; calendarGrid.appendChild(empty);
      }

      for (let day=1; day<=daysInMonth; day++){
        const dayDiv = document.createElement('div');
        dayDiv.classList.add('calendar-day','relative');

        const thisDate = new Date(year, month, day);
        const fullDate = ymdKST(thisDate);                // âœ… KST ê¸°ì¤€ í‚¤
        const dayOfWeek = toKST(thisDate).getDay();       // âœ… KST ê¸°ì¤€ ìš”ì¼

        const today = toKST(new Date());
        const isToday = (ymdKST(thisDate) === ymdKST(today));
        if (isToday) dayDiv.classList.add('today');

        const dayNumberSpan = document.createElement('span');
        dayNumberSpan.classList.add('day-number');
        dayNumberSpan.textContent = day;
        dayDiv.appendChild(dayNumberSpan);

        // í‰ì¼(ì¼~ëª©) ì—í”¼ì†Œë“œ í‘œê¸° + í† ê¸€
        if (dayOfWeek >= 0 && dayOfWeek <= 4) {
          const milestoneDate = new Date('2025-09-01');   // ê¸°ì¤€ì¼ (ë¡œì»¬ Dateì´ì§€ë§Œ ë¹„êµëŠ” KSTë¡œ ì²˜ë¦¬)
          const current = thisDate;
          const weekdaysBetween = countWeekdaysBetweenKST(milestoneDate.getTime(), current.getTime());
          const milestoneEpisode = 2014;
          const episodeNumber = (toKST(current) >= toKST(milestoneDate))
              ? milestoneEpisode + weekdaysBetween - 1
              : milestoneEpisode - (weekdaysBetween - 1);

          const epItem = document.createElement('div');
          epItem.classList.add('task-item','episode-task');
          epItem.textContent = `${episodeNumber}í™”`;

          const key = `${fullDate}_ë°”í€´ë©˜í„°ë¦¬ ${episodeNumber}í™”`;
          if ((window.taskStatus||{})[key]) epItem.classList.add('complete');

          epItem.addEventListener('click', async (e) => { 
            e.stopPropagation(); 
            if (!window.ensureLogin || !window.ensureLogin()) return; 
            window.taskStatus = window.taskStatus || {};
            window.taskStatus[key] = !window.taskStatus[key];
            await window.cloudSaveStateOnly(); 
            renderCalendar(); 
          });

          dayDiv.appendChild(epItem);
        }

        // ê³ ì • ìŠ¤ì¼€ì¤„(ì‡¼ì¸ /ì›¹íˆ°)
        fixedSchedules.forEach(sch => {
          if (sch.daysOfWeek.includes(dayOfWeek)) {
            const t = document.createElement('div');
            t.classList.add('task-item', sch.colorClass);
            t.textContent = sch.title;
            const key = `${fullDate}_${sch.title}`;
            if ((window.taskStatus||{})[key]) t.classList.add('complete');
            t.addEventListener('click', async (e) => { 
              e.stopPropagation(); 
              if (!window.ensureLogin || !window.ensureLogin()) return; 
              window.taskStatus = window.taskStatus || {};
              window.taskStatus[key] = !window.taskStatus[key];
              await window.cloudSaveStateOnly(); 
              renderCalendar(); 
            });
            dayDiv.appendChild(t);
          }
        });

        // ì»¤ìŠ¤í…€ ì‘ì—…
        (window.customTasks||[]).filter(t => t.date===fullDate).forEach(task => {
          const el = document.createElement('div');
          el.classList.add('task-item','custom-task');
          el.textContent = task.title;
          if (task.complete) el.classList.add('complete');
          el.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (e.detail===1){
              if (!window.ensureLogin || !window.ensureLogin()) return;
              task.complete = !task.complete;
              await window.cloudSaveAll();
              renderCalendar();
            } else if (e.detail===2){
              openModal(task);
            }
          });
          dayDiv.appendChild(el);
        });

        // ë¹ˆ ê³µê°„ í´ë¦­ â†’ ìƒˆ ì‘ì—…
        dayDiv.addEventListener('click', (e)=>{
          if (e.target.classList.contains('calendar-day') || e.target.classList.contains('day-number')){
            openModal({ date: fullDate });
          }
        });

        calendarGrid.appendChild(dayDiv);
      }
    };

    // ëª¨ë‹¬ ì œì–´
    const openModal = (task=null) => {
      window.currentTask = task;
      if (task && task.id){
        document.getElementById('modalTitle').textContent = 'ì‘ì—… ìˆ˜ì •';
        taskTitleInput.value = task.title;
        taskDescriptionInput.value = task.description || '';
        taskDateInput.value = task.date || '';
        deleteTaskBtn.classList.remove('hidden');
      } else if (task && task.date){
        document.getElementById('modalTitle').textContent = 'ìƒˆ ì‘ì—…';
        taskTitleInput.value = ''; taskDescriptionInput.value = ''; taskDateInput.value = task.date;
        deleteTaskBtn.classList.add('hidden');
      } else {
        document.getElementById('modalTitle').textContent = 'ìƒˆ ì‘ì—…';
        taskTitleInput.value = ''; taskDescriptionInput.value = ''; taskDateInput.value = '';
        deleteTaskBtn.classList.add('hidden');
      }
      taskModal.style.display = 'flex';
    };
    const closeModal = () => { taskModal.style.display = 'none'; };

    // ì‘ì—… ì €ì¥
    const saveTask = async () => {
      if (!window.ensureLogin || !window.ensureLogin()) return;

      window.customTasks = window.customTasks || [];
      window.taskStatus  = window.taskStatus  || {};

      const title = taskTitleInput.value.trim();
      const description = taskDescriptionInput.value.trim();
      const date = taskDateInput.value;
      if (!title){ showFeedbackMessage('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

      const data = {
        id: window.currentTask && window.currentTask.id ? window.currentTask.id : Date.now(),
        title, description, date,
        complete: window.currentTask?.complete ?? false
      };

      const idx = window.customTasks.findIndex(t => t.id === data.id);
      if (idx > -1) window.customTasks[idx] = data; else window.customTasks.push(data);

      await window.cloudSaveAll();
      closeModal();
      renderCalendar();
    };

    // ì´ˆê¸° ì‹¤í–‰
    (function init(){ attachEventListeners(); renderCalendar(); })();
  </script>

  <!-- ===== Firebase SDKs & ì—°ë™ ì½”ë“œ (ëª¨ë“ˆ / ì‹¤ì‹œê°„ ë™ê¸°í™”) ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ğŸ”§ Firebase ì„¤ì • (íšŒì›ë‹˜ í”„ë¡œì íŠ¸ ê°’)
    const firebaseConfig = {
      apiKey: "AIzaSyCiwzde40jsz17CEz-rrMmmBrn-S6brdlE",
      authDomain: "comicschedule-dfec7.firebaseapp.com",
      projectId: "comicschedule-dfec7",
      storageBucket: "comicschedule-dfec7.appspot.com",
      messagingSenderId: "1084611276816",
      appId: "1:1084611276816:web:aca83237bafa971ed1fa95",
      measurementId: "G-ZNZZQRJZF9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const signInBtn  = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const userInfoEl = document.getElementById('userInfo');

    const provider = new GoogleAuthProvider();

    async function doSignIn(){
      try { await signInWithPopup(auth, provider); }
      catch(e){
        console.error('Popup sign-in failed:', e);
        if (e.code === 'auth/popup-blocked' || e.code === 'auth/unauthorized-domain') {
          await signInWithRedirect(auth, provider);
        } else {
          alert('ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + (e.message || e.code));
        }
      }
    }
    getRedirectResult(auth).catch(e => console.error('Redirect sign-in error:', e));

    signInBtn.onclick  = () => doSignIn();
    signOutBtn.onclick = () => signOut(auth);

    // Firestore ì°¸ì¡° í—¬í¼
    window.cloudRefs = async () => {
      const uid = auth.currentUser.uid;
      return {
        tasksCol: collection(db, `users/${uid}/customTasks`),
        stateDoc: doc(db, `users/${uid}/meta/appState`)
      };
    };

    // ë¡œê·¸ì¸ í™•ì¸
    window.ensureLogin = () => {
      if (!auth.currentUser){ alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.'); return false; }
      return true;
    };

    // ë©”ëª¨ ë””ë°”ìš´ìŠ¤ ì €ì¥
    let notesTimer = null;
    window.cloudSaveNotesDebounced = function () {
      clearTimeout(notesTimer);
      notesTimer = setTimeout(() => window.cloudSaveNotes && window.cloudSaveNotes(), 800);
    };

    // ë‹¨ë°œ ë¡œë“œ(ë°±ì—…)
    window.cloudLoadAll = async () => {
      if (!ensureLogin()) return;
      const { tasksCol, stateDoc } = await cloudRefs();

      const tasksSnap = await getDocs(tasksCol);
      window.customTasks = (tasksSnap.docs.map(d => ({ id: d.id, ...d.data() })) || []);

      const st = await getDoc(stateDoc);
      const data = st.exists() ? (st.data() || {}) : {};
      window.taskStatus  = data.taskStatus || {};
      window.__notesTabs = data.notesTabs || {};

      const notesArea = document.getElementById('notesArea');
      if (notesArea) notesArea.value = window.__notesTabs?.[window.activeTab] || '';
      if (typeof renderCalendar === 'function') renderCalendar();
    };

    window.cloudLoadNotes = async () => {
      if (!ensureLogin()) return;
      const { stateDoc } = await cloudRefs();
      const st = await getDoc(stateDoc);
      const data = st.exists() ? (st.data()||{}) : {};
      window.__notesTabs = data.notesTabs || {};
      const notesArea = document.getElementById('notesArea');
      if (notesArea) notesArea.value = window.__notesTabs?.[window.activeTab] || '';
    };

    window.cloudSaveAll = async () => {
      if (!ensureLogin()) return;
      const { tasksCol, stateDoc } = await cloudRefs();
      window.taskStatus  = window.taskStatus  || {};
      window.customTasks = window.customTasks || [];

      // ìƒíƒœ ì €ì¥
      await setDoc(stateDoc, { taskStatus: window.taskStatus }, { merge:true });

      // ì‘ì—…ë“¤ ì €ì¥(merge)
      const ops = window.customTasks.map(t =>
        setDoc(doc(tasksCol, String(t.id)), t, { merge:true })
      );
      await Promise.all(ops);
    };

    window.cloudSaveStateOnly = async () => {
      if (!ensureLogin()) return;
      const { stateDoc } = await cloudRefs();
      window.taskStatus = window.taskStatus || {};
      await setDoc(stateDoc, { taskStatus: window.taskStatus }, { merge:true });
    };

    window.cloudSaveNotes = async () => {
      if (!ensureLogin()) return;
      const { stateDoc } = await cloudRefs();
      const notesArea = document.getElementById('notesArea');

      // ê¸°ì¡´ ë°ì´í„° ê°€ì ¸ì™€ ë³‘í•©
      const st = await getDoc(stateDoc);
      const prev = st.exists() ? (st.data()||{}) : {};
      const notesTabs = prev.notesTabs || {};
      notesTabs[window.activeTab] = notesArea?.value ?? '';

      await setDoc(stateDoc, { notesTabs }, { merge:true });
    };

    window.deleteTask = async () => {
      if (!ensureLogin() || !window.currentTask?.id) { 
        if (typeof closeModal==='function') closeModal(); 
        return; 
      }
      const { tasksCol } = await cloudRefs();
      await deleteDoc(doc(tasksCol, String(window.currentTask.id)));
      window.customTasks = (window.customTasks||[]).filter(t => t.id !== window.currentTask.id);
      await window.cloudSaveAll();
      if (typeof closeModal==='function') closeModal();
      if (typeof renderCalendar==='function') renderCalendar();
    };

    // ===== ì‹¤ì‹œê°„ ë™ê¸°í™” =====
    window.__unsubs = [];
    async function setupRealtimeSync() {
      const { tasksCol, stateDoc } = await window.cloudRefs();

      // ê¸°ì¡´ êµ¬ë… í•´ì œ
      window.__unsubs.forEach(fn => { try { fn(); } catch(_){} });
      window.__unsubs = [];

      // 1) ê°œì¸ ì‘ì—… ì‹¤ì‹œê°„ ë°˜ì˜
      const unsubTasks = onSnapshot(tasksCol, (snap) => {
        window.customTasks = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        if (typeof renderCalendar === 'function') renderCalendar();
      });
      window.__unsubs.push(unsubTasks);

      // 2) ìƒíƒœ/ë©”ëª¨ ì‹¤ì‹œê°„ ë°˜ì˜
      const unsubState = onSnapshot(stateDoc, (ds) => {
        const data = ds.exists() ? (ds.data() || {}) : {};
        window.taskStatus  = data.taskStatus || {};
        window.__notesTabs = data.notesTabs || {};
        const notesArea = document.getElementById('notesArea');
        if (notesArea) notesArea.value = window.__notesTabs?.[window.activeTab] || '';
        if (typeof renderCalendar === 'function') renderCalendar();
      });
      window.__unsubs.push(unsubState);
    }

    // ë¡œê·¸ì¸ ìƒíƒœ ë³€í™”
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userInfoEl.textContent = `${user.displayName || 'ë¡œê·¸ì¸ë¨'} (${user.email || ''})`;
        signInBtn.classList.add('hidden');  
        signOutBtn.classList.remove('hidden');

        // ì‹¤ì‹œê°„ êµ¬ë… ì‹œì‘
        await setupRealtimeSync();

      } else {
        userInfoEl.textContent = '';
        signOutBtn.classList.add('hidden'); 
        signInBtn.classList.remove('hidden');

        // êµ¬ë… í•´ì œ
        window.__unsubs.forEach(fn => { try { fn(); } catch(_){} });
        window.__unsubs = [];
      }
    });
  </script>
</body>
</html>
