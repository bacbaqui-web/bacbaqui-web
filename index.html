<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë§Œí™” ì¼ì • ê´€ë¦¬</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
    body{
      font-family:'Noto Sans KR',sans-serif;background:#000;color:#fff;
      display:flex;flex-direction:column;align-items:center;min-height:100vh;gap:2rem;padding:20px;
    }
    .calendar-section,.notepad-section{
      width:100%;max-width:1200px;background:#2a2a2a;border-radius:12px;
      padding:24px;box-shadow:inset 0 0 10px rgba(0,0,0,.3);
    }
    .notepad-section{display:flex;flex-direction:column;padding-top:12px;padding-bottom:12px}
    .notepad-tabs{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .tab-container{display:flex;justify-content:space-around;gap:8px;flex-grow:1}
    .notepad-tab{background:#333;padding:8px 16px;border-radius:8px 8px 0 0;cursor:pointer;transition:.2s;font-weight:700}
    .notepad-tab.active{background:#1a1a1a}
    .notepad-tab:hover{background:#444}
    .notepad-section textarea{
      background:#1a1a1a;border:1px solid #333;color:#fff;padding:12px;border-radius:8px;min-height:900px;resize:vertical
    }

    .calendar-header{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:24px}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day-label,.calendar-day{
      text-align:center;padding:8px;border-radius:8px;background:#2a2a2a;position:relative;overflow:hidden
    }
    .day-label{background:#444;font-weight:700}
    .calendar-day{min-height:120px;padding-top:24px}
    .calendar-day.today{border:2px solid #ccc}
    .day-number{position:absolute;top:8px;left:8px;font-size:1.1rem;font-weight:700;color:#aaa}

    /* âœ… ëª¨ë°”ì¼ì—ì„œ ì„¸ë¡œê¹¨ì§ ë°©ì§€ */
    .task-item{
      font-size:.8rem;padding:4px 6px;border-radius:6px;margin-top:4px;
      white-space:nowrap;word-break:keep-all;overflow:hidden;text-overflow:ellipsis;
      display:inline-flex;align-items:center;justify-content:center;min-height:24px;cursor:pointer
    }
    .task-item.custom-task{background:#4c78a8}
    .task-item.episode-task{background:#444;color:#ddd}
    .task-item.recurring-shorts{background:#7d4040}
    .task-item.recurring-instatoon{background:#999966}
    .task-item.complete{background:#888;color:#ccc;text-decoration:line-through}

    .add-task-btn{background:#666;transition:.2s}
    .add-task-btn:hover{background:#777;transform:scale(1.02)}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:1000}
    .modal-content{background:#1a1a1a;border-radius:12px;padding:24px;width:90%;max-width:500px;box-shadow:0 10px 30px rgba(0,0,0,.5)}

    @media (max-width:480px){
      .calendar-header,.calendar-grid{gap:2px}
      .calendar-day{min-height:90px;padding-top:22px}
      .day-number{font-size:.95rem}
      .task-item{font-size:11px;padding:2px 4px;border-radius:6px}
      .task-item.episode-task{font-size:10px}
    }
  </style>
</head>
<body class="text-white">

  <!-- ìƒë‹¨ ë¡œê·¸ì¸ ë°” -->
  <div class="w-full max-w-5xl mx-auto flex items-center justify-end gap-2">
    <span id="userInfo" class="text-sm opacity-80"></span>
    <button id="signInBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Google ë¡œê·¸ì¸</button>
    <button id="signOutBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded hidden">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <!-- ë‹¬ë ¥ -->
  <div class="calendar-section">
    <div class="flex justify-between items-center mb-4">
      <button id="prevMonthBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">&lt; ì´ì „ ë‹¬</button>
      <h2 id="currentMonthYear" class="text-2xl font-bold"></h2>
      <button id="nextMonthBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">ë‹¤ìŒ ë‹¬ &gt;</button>
    </div>
    <div class="calendar-header mb-2">
      <div class="day-label">ì¼</div><div class="day-label">ì›”</div><div class="day-label">í™”</div>
      <div class="day-label">ìˆ˜</div><div class="day-label">ëª©</div><div class="day-label">ê¸ˆ</div><div class="day-label">í† </div>
    </div>
    <div id="calendarGrid" class="calendar-grid"></div>
    <div class="mt-8 text-center">
      <button id="addTaskBtn" class="add-task-btn px-6 py-3 rounded-full font-bold text-white shadow-md">+ ê°œì¸ ì‘ì—… ì¶”ê°€</button>
    </div>
  </div>

  <!-- ë©”ëª¨ -->
  <div class="notepad-section mt-8">
    <div class="notepad-tabs">
      <div class="tab-container">
        <button class="notepad-tab active" data-tab="ë°”í€´ë©˜í„°ë¦¬">ë°”í€´ë©˜í„°ë¦¬</button>
        <button class="notepad-tab" data-tab="ì§ìŠ¹ìœ¡ì•„">ì§ìŠ¹ìœ¡ì•„</button>
        <button class="notepad-tab" data-tab="ê·¸ê±°ì•„ì„¸ìš”">ê·¸ê±°ì•„ì„¸ìš”</button>
        <button class="notepad-tab" data-tab="ë©”ëª¨">ë©”ëª¨</button>
      </div>
    </div>
    <textarea id="notesArea" class="flex-grow"></textarea>
  </div>

  <!-- ì‘ì—… ëª¨ë‹¬ -->
  <div id="taskModal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle" class="text-2xl font-bold mb-4">ìƒˆ ì‘ì—…</h2>
      <label class="block mb-2">ì œëª©:</label>
      <input id="taskTitle" type="text" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 mb-4">
      <label class="block mb-2">ì„¤ëª…:</label>
      <textarea id="taskDescription" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 mb-4 h-24"></textarea>
      <label class="block mb-2">ë‚ ì§œ:</label>
      <input id="taskDate" type="date" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 mb-4">
      <div class="flex justify-end gap-2">
        <button id="saveTaskBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">ì €ì¥</button>
        <button id="cancelBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">ì·¨ì†Œ</button>
        <button id="deleteTaskBtn" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg hidden">ì‚­ì œ</button>
      </div>
    </div>
  </div>

  <!-- ================== ì•± UI/ë¡œì§ (ë¹„ëª¨ë“ˆ) ================== -->
  <script>
    // ----- ì „ì—­ ìƒíƒœ -----
    let customTasks = [];            // [{id, title, description, date(YYYY-MM-DD), complete}]
    let taskStatus = {};             // {"YYYY-MM-DD_ì‡¼ì¸ ": true/false, "YYYY-MM-DD_ë°”í€´ë©˜í„°ë¦¬ 2014í™”": ...}
    let currentDate = new Date();    // ë‹¬ë ¥ ê¸°ì¤€ ë‚ ì§œ(ì›”)
    let currentTask = null;          // ëª¨ë‹¬ì—ì„œ í¸ì§‘ì¤‘ì¸ ì‘ì—…
    let activeTab = 'ë°”í€´ë©˜í„°ë¦¬';    // ë©”ëª¨ íƒ­

    // ----- ê³ ì • ìŠ¤ì¼€ì¤„(ìš”ì¼: 0=ì¼ ~ 6=í† ) -----
    const fixedSchedules = [
      { title: 'ì‡¼ì¸ ', daysOfWeek: [1,3,5], colorClass: 'recurring-shorts' },
      { title: 'ì›¹íˆ°', daysOfWeek: [2,4,6], colorClass: 'recurring-instatoon' },
    ];

    // ----- ê³µí†µ DOM -----
    const taskModal = document.getElementById('taskModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveTaskBtn = document.getElementById('saveTaskBtn');
    const deleteTaskBtn = document.getElementById('deleteTaskBtn');
    const taskTitleInput = document.getElementById('taskTitle');
    const taskDescriptionInput = document.getElementById('taskDescription');
    const taskDateInput = document.getElementById('taskDate');

    // ----- ìœ í‹¸: í† ìŠ¤íŠ¸ -----
    const showFeedbackMessage = (message) => {
      const el = document.createElement('div');
      el.textContent = message;
      el.style.cssText = "position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.8);color:#fff;padding:16px 20px;border-radius:10px;z-index:2000;max-width:90%";
      document.body.appendChild(el);
      setTimeout(()=>el.remove(),2000);
    };

    // ----- ìœ í‹¸: íŠ¹ì • ë‘ ë‚ ì§œ ì‚¬ì´ì˜ (ì¼~ëª©) í‰ì¼ìˆ˜ -----
    function countWeekdaysBetween(startMs, endMs){
      let count = 0;
      const start = new Date(Math.min(startMs, endMs));
      const end   = new Date(Math.max(startMs, endMs));
      const cur = new Date(start);
      while (cur <= end){
        const d = cur.getDay();
        if (d >= 0 && d <= 4) count++;
        cur.setDate(cur.getDate()+1);
      }
      return count;
    }

    // ----- ì´ë²¤íŠ¸ ì—°ê²° -----
    function attachEventListeners(){
      document.getElementById('prevMonthBtn').addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      document.getElementById('nextMonthBtn').addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });
      document.getElementById('addTaskBtn').addEventListener('click', ()=> openModal());

      // ë©”ëª¨ íƒ­
      document.querySelectorAll('.notepad-tab').forEach(tab=>{
        tab.addEventListener('click', ()=>{
          document.querySelectorAll('.notepad-tab').forEach(t=>t.classList.remove('active'));
          tab.classList.add('active');
          activeTab = tab.dataset.tab;
          if (window.cloudLoadNotes) window.cloudLoadNotes();
        });
      });

      // ë©”ëª¨ ì…ë ¥ ì €ì¥ ë””ë°”ìš´ìŠ¤
      const notesArea = document.getElementById('notesArea');
      let notesTimer=null;
      notesArea.addEventListener('input', ()=>{
        clearTimeout(notesTimer);
        notesTimer = setTimeout(()=> window.cloudSaveNotes && window.cloudSaveNotes(), 800);
      });

      // ëª¨ë‹¬ ë²„íŠ¼
      cancelBtn.addEventListener('click', closeModal);
      saveTaskBtn.addEventListener('click', saveTask);
      deleteTaskBtn.addEventListener('click', ()=> window.deleteTask && window.deleteTask());
      taskModal.addEventListener('click', (e)=>{ if (e.target===taskModal) closeModal(); });
    }

    // ----- ë‹¬ë ¥ ë Œë”ë§ -----
    function renderCalendar(){
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      document.getElementById('currentMonthYear').textContent = `${year}ë…„ ${month+1}ì›”`;

      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month+1, 0).getDate();

      // ì•ìª½ ê³µë°±
      for (let i=0;i<firstDay;i++){
        const empty = document.createElement('div');
        empty.className = 'calendar-day';
        grid.appendChild(empty);
      }

      // ì‹¤ì œ ë‚ ì§œ
      for (let day=1; day<=daysInMonth; day++){
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day relative';

        const fullDate = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;

        // ì˜¤ëŠ˜ í‘œì‹œ
        const today = new Date();
        if (year===today.getFullYear() && month===today.getMonth() && day===today.getDate()){
          dayDiv.classList.add('today');
        }

        const num = document.createElement('span');
        num.className = 'day-number';
        num.textContent = day;
        dayDiv.appendChild(num);

        const dayOfWeek = new Date(year, month, day).getDay();

        // í‰ì¼ ì—í”¼ì†Œë“œ ë²ˆí˜¸
        if (dayOfWeek >= 0 && dayOfWeek <= 4){
          const milestoneDate = new Date('2025-09-01');
          const milestoneEpisode = 2014;
          const cur = new Date(year, month, day);
          const weekdaysBetween = countWeekdaysBetween(milestoneDate.getTime(), cur.getTime());
          const episodeNumber = (cur >= milestoneDate)
              ? milestoneEpisode + weekdaysBetween - 1
              : milestoneEpisode - (weekdaysBetween - 1);

          const ep = document.createElement('div');
          ep.className = 'task-item episode-task';
          ep.textContent = `${episodeNumber}í™”`;
          const key = `${fullDate}_ë°”í€´ë©˜í„°ë¦¬ ${episodeNumber}í™”`;
          if (taskStatus[key]) ep.classList.add('complete');
          ep.addEventListener('click', async (e)=>{
            e.stopPropagation();
            if (!window.ensureLogin || !window.ensureLogin()) return;
            taskStatus[key] = !taskStatus[key];
            await window.cloudSaveStateOnly && window.cloudSaveStateOnly();
            renderCalendar();
          });
          dayDiv.appendChild(ep);
        }

        // ê³ ì • ìŠ¤ì¼€ì¤„
        fixedSchedules.forEach(s=>{
          if (s.daysOfWeek.includes(dayOfWeek)){
            const el = document.createElement('div');
            el.className = `task-item ${s.colorClass}`;
            el.textContent = s.title;
            const key = `${fullDate}_${s.title}`;
            if (taskStatus[key]) el.classList.add('complete');
            el.addEventListener('click', async (e)=>{
              e.stopPropagation();
              if (!window.ensureLogin || !window.ensureLogin()) return;
              taskStatus[key] = !taskStatus[key];
              await window.cloudSaveStateOnly && window.cloudSaveStateOnly();
              renderCalendar();
            });
            dayDiv.appendChild(el);
          }
        });

        // ì‚¬ìš©ì ì‘ì—…
        customTasks.filter(t=>t.date===fullDate).forEach(task=>{
          const el = document.createElement('div');
          el.className = 'task-item custom-task';
          el.textContent = task.title;
          if (task.complete) el.classList.add('complete');
          el.addEventListener('click', async (e)=>{
            e.stopPropagation();
            if (e.detail===1){
              if (!window.ensureLogin || !window.ensureLogin()) return;
              task.complete = !task.complete;
              await window.cloudSaveAll && window.cloudSaveAll();
              renderCalendar();
            } else if (e.detail===2){
              openModal(task);
            }
          });
          dayDiv.appendChild(el);
        });

        dayDiv.addEventListener('click', (e)=>{
          if (e.target.classList.contains('calendar-day') || e.target.classList.contains('day-number')){
            openModal({ date: fullDate });
          }
        });

        grid.appendChild(dayDiv);
      }
    }

    // ----- ëª¨ë‹¬ ì—´ê³ /ë‹«ê¸° -----
    function openModal(task=null){
      currentTask = task;
      if (task && task.id){
        document.getElementById('modalTitle').textContent = 'ì‘ì—… ìˆ˜ì •';
        taskTitleInput.value = task.title;
        taskDescriptionInput.value = task.description || '';
        taskDateInput.value = task.date || '';
        deleteTaskBtn.classList.remove('hidden');
      } else if (task && task.date){
        document.getElementById('modalTitle').textContent = 'ìƒˆ ì‘ì—…';
        taskTitleInput.value = '';
        taskDescriptionInput.value = '';
        taskDateInput.value = task.date;
        deleteTaskBtn.classList.add('hidden');
      } else {
        document.getElementById('modalTitle').textContent = 'ìƒˆ ì‘ì—…';
        taskTitleInput.value = '';
        taskDescriptionInput.value = '';
        taskDateInput.value = '';
        deleteTaskBtn.classList.add('hidden');
      }
      taskModal.style.display = 'flex';
    }
    function closeModal(){ taskModal.style.display = 'none'; }

    // ----- ì‘ì—… ì €ì¥ -----
    async function saveTask(){
      if (!window.ensureLogin || !window.ensureLogin()) return;
      const title = taskTitleInput.value.trim();
      const description = taskDescriptionInput.value.trim();
      const date = taskDateInput.value;
      if (!title){ showFeedbackMessage('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

      const data = {
        id: currentTask && currentTask.id ? currentTask.id : Date.now(),
        title, description, date,
        complete: currentTask?.complete ?? false,
      };

      const idx = customTasks.findIndex(t=>t.id===data.id);
      if (idx>-1) customTasks[idx]=data; else customTasks.push(data);

      await window.cloudSaveAll && window.cloudSaveAll();
      closeModal();
      renderCalendar();
    }

    // ----- ì´ˆê¸° ì‹¤í–‰ -----
    (function init(){
      attachEventListeners();
      renderCalendar();
    })();
  </script>

  <!-- ================== Firebase ì—°ë™ (ëª¨ë“ˆ) ================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ğŸ”§ ì—¬ê¸° ë³¸ì¸ Firebase ì„¤ì •ìœ¼ë¡œ êµì²´í•˜ì„¸ìš” (ì½˜ì†”ì˜ ì›¹ì•± êµ¬ì„± ê·¸ëŒ€ë¡œ ë³µì‚¬)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "comicschedule-dfec7.firebaseapp.com",
      projectId: "comicschedule-dfec7",
      storageBucket: "comicschedule-dfec7.appspot.com",
      messagingSenderId: "1084611276816",
      appId: "1:1084611276816:web:aca83237bafa971ed1fa95",
      measurementId: "G-ZNZZQRJZF9"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const signInBtn  = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const userInfoEl = document.getElementById('userInfo');

    const provider = new GoogleAuthProvider();
    async function doSignIn(){
      try{ await signInWithPopup(auth, provider); }
      catch(e){
        if (e.code==='auth/popup-blocked' || e.code==='auth/unauthorized-domain'){
          await signInWithRedirect(auth, provider);
        } else { alert('ë¡œê·¸ì¸ ì˜¤ë¥˜: '+(e.message||e.code)); }
      }
    }
    getRedirectResult(auth).catch(()=>{});

    signInBtn.onclick  = () => doSignIn();
    signOutBtn.onclick = () => signOut(auth);

    // ---- Firestore ê²½ë¡œ/ë„ì›€ í•¨ìˆ˜ (ì „ì—­ì— ë…¸ì¶œ) ----
    window.cloudRefs = async () => {
      const uid = auth.currentUser.uid;
      return {
        tasksCol: collection(db, `users/${uid}/customTasks`),
        stateDoc: doc(db, `users/${uid}/meta/appState`)
      };
    };

    window.ensureLogin = () => {
      if (!auth.currentUser){ alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.'); return false; }
      return true;
    };

    window.cloudLoadAll = async () => {
      if (!ensureLogin()) return;
      const { tasksCol, stateDoc } = await cloudRefs();

      const tasksSnap = await getDocs(tasksCol);
      window.customTasks = tasksSnap.docs.map(d => ({ id:d.id, ...d.data() }));

      const st = await getDoc(stateDoc);
      if (st.exists()){
        const data = st.data() || {};
        window.taskStatus = data.taskStatus || {};
        const el = document.getElementById('notesArea');
        const allNotes = data.notesTabs || {};
        if (el) el.value = allNotes[window.activeTab] || '';
      }
      if (typeof renderCalendar==='function') renderCalendar();
    };

    window.cloudLoadNotes = async () => {
      if (!ensureLogin()) return;
      const { stateDoc } = await cloudRefs();
      const st = await getDoc(stateDoc);
      const data = st.exists() ? (st.data()||{}) : {};
      const notesTabs = data.notesTabs || {};
      const el = document.getElementById('notesArea');
      if (el) el.value = notesTabs[window.activeTab] || '';
    };

    window.cloudSaveAll = async () => {
      if (!ensureLogin()) return;
      const { tasksCol, stateDoc } = await cloudRefs();
      // ìƒíƒœ ì €ì¥
      await setDoc(stateDoc, { taskStatus: window.taskStatus }, { merge:true });
      // ëª¨ë“  ì‚¬ìš©ì ì‘ì—… ì €ì¥
      const ops = (window.customTasks||[]).map(t=> setDoc(doc(tasksCol, String(t.id)), t, { merge:true }));
      await Promise.all(ops);
    };

    window.cloudSaveStateOnly = async () => {
      if (!ensureLogin()) return;
      const { stateDoc } = await cloudRefs();
      await setDoc(stateDoc, { taskStatus: window.taskStatus }, { merge:true });
    };

    window.cloudSaveNotes = async () => {
      if (!ensureLogin()) return;
      const { stateDoc } = await cloudRefs();
      const el = document.getElementById('notesArea');
      const st = await getDoc(stateDoc);
      const prev = st.exists() ? (st.data()||{}) : {};
      const notesTabs = prev.notesTabs || {};
      notesTabs[window.activeTab] = el.value;
      await setDoc(stateDoc, { notesTabs }, { merge:true });
    };

    window.deleteTask = async () => {
      if (!ensureLogin() || !window.currentTask?.id) { if (typeof closeModal==='function') closeModal(); return; }
      const { tasksCol } = await cloudRefs();
      await deleteDoc(doc(tasksCol, String(window.currentTask.id)));
      window.customTasks = (window.customTasks||[]).filter(t=>t.id!==window.currentTask.id);
      await window.cloudSaveAll();
      if (typeof closeModal==='function') closeModal();
      if (typeof renderCalendar==='function') renderCalendar();
    };

    // ---- ë¡œê·¸ì¸ ìƒíƒœ ë³€í™” ----
    onAuthStateChanged(auth, async (user)=>{
      if (user){
        userInfoEl.textContent = user.email || 'ë¡œê·¸ì¸ë¨';
        signInBtn.classList.add('hidden');
        signOutBtn.classList.remove('hidden');
        await window.cloudLoadAll();
      } else {
        userInfoEl.textContent='';
        signOutBtn.classList.add('hidden');
        signInBtn.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
