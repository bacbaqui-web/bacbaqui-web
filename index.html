<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>만화 일정 관리</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    body{font-family:'Noto Sans KR',sans-serif;background:#000;color:#fff;display:flex;flex-direction:column;gap:0;min-height:100vh;padding:16px}
    .tab-content{display:none}.tab-content.active{display:flex;flex-direction:column;flex-grow:1}
    .section-card{background:#2a2a2a;border-radius:12px;padding:20px;box-shadow:inset 0 0 10px rgba(0,0,0,.3);text-align:center;width:100%;max-width:900px}
    .notepad-tabs{display:flex;justify-content:center;align-items:center;gap:1rem;width:100%;max-width:900px}
    .notepad-tab{background:#1a1a1a;padding:8px 16px;border-radius:8px 8px 0 0;cursor:pointer;transition:.2s;font-weight:700;color:#737373;font-size:.9rem}
    .notepad-tab.active,.notepad-tab:hover{background:#2a2a2a;color:#fff}
    .calendar-header{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:4px}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
    .day-label,.calendar-day{background:#2a2a2a;border-radius:8px}
    .day-label{padding:8px 0;font-weight:700}
    .calendar-day{min-height:160px;padding:16px 2px 2px;position:relative;display:flex;flex-direction:column;gap:4px}
    .calendar-day.today{outline:2px solid #ccc}
    .day-number{position:absolute;top:8px;left:8px;font-size:.85rem;color:#aaa;font-weight:700}
    .task-item{font-size:.85rem;padding:5px 6px;border-radius:8px;text-align:left;cursor:pointer}
    .task-item.custom-task{background:#4c78a8}
    .task-item.episode-task{background:#444;color:#ddd}
    .task-item.recurring-shorts{background:#7d4040}
    .task-item.recurring-instatoon{background:#999966}
    .task-item.complete{background:#888;text-decoration:line-through;color:#ccc}
    .drag-area{border:2px dashed #4b4b4b;padding:24px;border-radius:12px;cursor:pointer}
    .drag-area.active{border-color:#6b6b6b;background:#242424}
    .image-card{position:relative}
    .image-card img{border-radius:8px}
    /* 모달: 화면에 꽉 차도록 */
    #imageModal{display:none}
    #imageModal.show{display:flex}
    #imageModal .modal-content{
      background:transparent;padding:0;max-width:95vw;max-height:95vh;width:95vw;height:95vh;
      display:flex;justify-content:center;align-items:center
    }
    #modalImage{width:95vw;height:95vh;object-fit:contain}
    @media (max-width:768px){
      .section-card{max-width:100%;padding:12px;border-radius:8px}
      .calendar-grid,.calendar-header{gap:2px}
      .calendar-day{min-height:120px;padding:12px 2px 2px}
    }
  </style>
</head>
<body>
  <!-- 상단 바 -->
  <div id="authBar" class="w-full max-w-3xl mx-auto flex items-center justify-end gap-2 mb-4">
    <span id="userInfo" class="text-sm opacity-80"></span>
    <button id="signInBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Google 로그인</button>
    <button id="signOutBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded hidden">로그아웃</button>
  </div>

  <!-- 탭 -->
  <div id="main-tabs" class="notepad-tabs mx-auto">
    <button class="notepad-tab active" data-tab="calendar">달력</button>
    <button class="notepad-tab" data-tab="notes">메모</button>
    <button class="notepad-tab" data-tab="bookmarks">북마크</button>
  </div>

  <!-- 달력 -->
  <section id="calendar-section" class="section-card tab-content active">
    <div class="flex justify-between items-center mb-4">
      <button id="prevMonthBtn" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded">&lt; 이전 달</button>
      <h2 id="currentMonthYear" class="text-lg font-bold"></h2>
      <button id="nextMonthBtn" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded">다음 달 &gt;</button>
    </div>
    <div class="calendar-header mb-2">
      <div class="day-label">일</div><div class="day-label">월</div><div class="day-label">화</div>
      <div class="day-label">수</div><div class="day-label">목</div><div class="day-label">금</div><div class="day-label">토</div>
    </div>
    <div id="calendarGrid" class="calendar-grid"></div>
    <div class="mt-6">
      <button id="addTaskBtn" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">+ 개인 작업 추가</button>
    </div>
  </section>

  <!-- 메모 -->
  <section id="notes-section" class="section-card tab-content">
    <div class="notepad-tabs mb-2">
      <button class="notepad-tab active" data-tab="바퀴멘터리">바퀴멘터리</button>
      <button class="notepad-tab" data-tab="짐승육아">짐승육아</button>
      <button class="notepad-tab" data-tab="그거아세요">그거아세요</button>
      <button class="notepad-tab" data-tab="메모">메모</button>
    </div>
    <textarea id="notesArea" class="w-full min-h-40 p-3 bg-black text-white border border-gray-700 rounded"></textarea>
  </section>

  <!-- 북마크 -->
  <section id="bookmarks-section" class="section-card tab-content text-left">
    <div id="drag-area" class="drag-area mt-2" title="클릭하면 클립보드 자동 읽기 시도">
      이미지 URL을 드래그하거나, 캡쳐/복사 이미지를 붙여넣으세요 (Ctrl/Cmd+V). 클릭 시 클립보드 자동 읽기.
    </div>
    <div id="image-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mt-6"></div>
  </section>

  <!-- 작업 모달 -->
  <div id="taskModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
    <div class="bg-[#1a1a1a] rounded-xl p-5 w-[92vw] max-w-[520px]">
      <h2 id="modalTitle" class="text-xl font-bold mb-3">새 작업</h2>
      <label class="block mb-1">제목</label>
      <input id="taskTitle" class="w-full p-2 rounded bg-gray-800 border border-gray-700 mb-3"/>
      <label class="block mb-1">설명</label>
      <textarea id="taskDescription" class="w-full p-2 rounded bg-gray-800 border border-gray-700 mb-3 h-24"></textarea>
      <label class="block mb-1">날짜</label>
      <input id="taskDate" type="date" class="w-full p-2 rounded bg-gray-800 border border-gray-700 mb-4"/>
      <div class="flex justify-end gap-2">
        <button id="saveTaskBtn" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">저장</button>
        <button id="cancelBtn" class="bg-gray-500 hover:bg-gray-600 px-4 py-2 rounded">취소</button>
        <button id="deleteTaskBtn" class="bg-gray-700 hover:bg-gray-800 px-4 py-2 rounded hidden">삭제</button>
      </div>
    </div>
  </div>

  <!-- 이미지 모달 -->
  <div id="imageModal" class="fixed inset-0 bg-black/80 items-center justify-center z-50">
    <div class="modal-content relative">
      <button id="closeImageModalBtn" class="absolute top-2 right-2 bg-black/60 text-white rounded px-2 py-1">닫기</button>
      <img id="modalImage" src="" alt="확대 이미지"/>
      <button id="goToPageBtn" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">원본 페이지로 이동</button>
    </div>
  </div>

  <!-- 알림 모달 -->
  <div id="alert-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[1001]">
    <div class="bg-[#242424] rounded-lg p-5 shadow-xl max-w-sm">
      <p id="modal-message" class="text-white text-center"></p>
      <div class="mt-4 flex justify-center">
        <button id="modal-close-btn" class="px-4 py-2 bg-[#424242] text-white rounded hover:bg-[#525252]">확인</button>
      </div>
    </div>
  </div>

  <!-- 로딩 -->
  <div id="loading-overlay" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-[1002]">
    <div class="flex flex-col items-center">
      <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white"></div>
      <p class="text-white mt-3">데이터를 불러오는 중...</p>
    </div>
  </div>

  <!-- 전체 앱 로직: 하나의 module 스크립트로 통합 -->
  <script type="module">
    // ===== Firebase SDK =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ===== Constants =====
    const IMGBB_API_KEY = "f64175972f4e4178332db9ae8559969b";

    const firebaseConfig = {
      apiKey: "AIzaSyCiwzde40jsz17CEz-rrMmmBrn-S6brdlE",
      authDomain: "comicschedule-dfec7.firebaseapp.com",
      projectId: "comicschedule-dfec7",
      storageBucket: "comicschedule-dfec7.appspot.com",
      messagingSenderId: "1084611276816",
      appId: "1:1084611276816:web:aca83237bafa971ed1fa95",
      measurementId: "G-ZNZZQRJZF9"
    };

    // ===== Init =====
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // ===== DOM =====
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const userInfoEl = document.getElementById('userInfo');
    const loadingOverlay = document.getElementById('loading-overlay');

    const tabButtons = document.querySelectorAll('#main-tabs .notepad-tab');
    const tabContents = document.querySelectorAll('.tab-content');

    const calendarGrid = document.getElementById('calendarGrid');
    const currentMonthYear = document.getElementById('currentMonthYear');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const addTaskBtn = document.getElementById('addTaskBtn');

    const taskModal = document.getElementById('taskModal');
    const modalTitle = document.getElementById('modalTitle');
    const taskTitleInput = document.getElementById('taskTitle');
    const taskDescriptionInput = document.getElementById('taskDescription');
    const taskDateInput = document.getElementById('taskDate');
    const saveTaskBtn = document.getElementById('saveTaskBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const deleteTaskBtn = document.getElementById('deleteTaskBtn');

    const notesArea = document.getElementById('notesArea');
    const notesTabs = document.querySelectorAll('#notes-section .notepad-tab');

    const dragArea = document.getElementById('drag-area');
    const imageGrid = document.getElementById('image-grid');

    const imageModal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const closeImageModalBtn = document.getElementById('closeImageModalBtn');
    const goToPageBtn = document.getElementById('goToPageBtn');

    const alertModal = document.getElementById('alert-modal');
    const alertMsg = document.getElementById('modal-message');
    const alertClose = document.getElementById('modal-close-btn');

    // ===== State =====
    let isAuthReady = false;
    let currentDate = new Date();
    let currentTask = null;
    let unsubs = [];
    window.customTasks = [];
    window.taskStatus = {};
    window.__notesTabs = {};
    window.imageBookmarks = [];

    // ===== Utils =====
    const TZ = 'Asia/Seoul';
    const toKST = (d)=>new Date(d.toLocaleString('en-US',{timeZone:TZ}));
    const ymdKST = (d)=>new Intl.DateTimeFormat('en-CA',{timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit'}).format(d);

    function showAlert(msg){ alertMsg.textContent = msg; alertModal.classList.remove('hidden'); alertModal.classList.add('flex'); }
    function hideAlert(){ alertModal.classList.add('hidden'); alertModal.classList.remove('flex'); }
    alertClose.addEventListener('click', hideAlert);

    function ensureLogin(){
      if(!isAuthReady){ showAlert('데이터 로딩 중입니다.'); return false; }
      if(!auth.currentUser){ showAlert('로그인 후 이용하세요.'); return false; }
      return true;
    }
    async function cloudRefs(){
      const uid = auth.currentUser.uid;
      const base = `users/${uid}`;
      return {
        tasksCol: collection(db, `${base}/customTasks`),
        stateDoc: doc(db, `${base}/meta/appState`),
        imagesCol: collection(db, `${base}/images`),
      };
    }

    function showTab(id){
      tabContents.forEach(n=>n.classList.remove('active'));
      tabButtons.forEach(b=>b.classList.remove('active'));
      document.getElementById(`${id}-section`).classList.add('active');
      document.querySelector(`#main-tabs .notepad-tab[data-tab="${id}"]`)?.classList.add('active');
    }
    tabButtons.forEach(b=>b.addEventListener('click',()=>showTab(b.dataset.tab)));
    showTab('calendar');

    // ===== Calendar =====
    function countWeekdaysBetweenKST(a,b){
      let cnt=0;
      const start=toKST(new Date(Math.min(a,b)));
      const end=toKST(new Date(Math.max(a,b)));
      const cur=new Date(start);
      while(cur<=end){ const d=cur.getDay(); if(d>=0&&d<=4) cnt++; cur.setDate(cur.getDate()+1); }
      return cnt;
    }
    const fixedSchedules = [
      { title:'쇼츠', daysOfWeek:[1,3,5], colorClass:'recurring-shorts' },
      { title:'웹툰', daysOfWeek:[2,4,6], colorClass:'recurring-instatoon' }
    ];

    function renderCalendar(){
      const y=currentDate.getFullYear(), m=currentDate.getMonth();
      currentMonthYear.textContent = `${y}년 ${m+1}월`;
      calendarGrid.innerHTML='';
      const firstDay = toKST(new Date(y,m,1)).getDay();
      const daysInMonth = new Date(y,m+1,0).getDate();

      for(let i=0;i<firstDay;i++){ const empty=document.createElement('div'); empty.className='calendar-day'; calendarGrid.appendChild(empty); }

      for(let day=1; day<=daysInMonth; day++){
        const d = new Date(y,m,day);
        const fullDate = ymdKST(d);
        const dayOfWeek = toKST(d).getDay();

        const cell = document.createElement('div');
        cell.className='calendar-day relative';
        const today = toKST(new Date());
        if(ymdKST(d)===ymdKST(today)) cell.classList.add('today');

        const num = document.createElement('span');
        num.className='day-number';
        num.textContent=day;
        cell.appendChild(num);

        if(dayOfWeek>=0 && dayOfWeek<=4){
          const milestoneDate=new Date('2025-09-01');
          const weekdaysBetween = countWeekdaysBetweenKST(milestoneDate.getTime(), d.getTime());
          const milestoneEpisode=2014;
          const episodeNumber = (toKST(d)>=toKST(milestoneDate)) ? milestoneEpisode+weekdaysBetween-1 : milestoneEpisode-(weekdaysBetween-1);
          const ep = document.createElement('div');
          ep.className='task-item episode-task';
          ep.textContent=`${episodeNumber}화`;
          const key=`${fullDate}_바퀴멘터리 ${episodeNumber}화`;
          if(window.taskStatus[key]) ep.classList.add('complete');
          ep.addEventListener('click', async (e)=>{
            e.stopPropagation();
            if(!ensureLogin()) return;
            window.taskStatus[key] = !window.taskStatus[key];
            const { stateDoc } = await cloudRefs();
            await setDoc(stateDoc, { taskStatus: window.taskStatus }, { merge:true });
            renderCalendar();
          });
          cell.appendChild(ep);
        }

        fixedSchedules.forEach(s=>{
          if(s.daysOfWeek.includes(dayOfWeek)){
            const t=document.createElement('div');
            t.className=`task-item ${s.colorClass}`;
            t.textContent=s.title;
            const key=`${fullDate}_${s.title}`;
            if(window.taskStatus[key]) t.classList.add('complete');
            t.addEventListener('click', async (e)=>{
              e.stopPropagation();
              if(!ensureLogin()) return;
              window.taskStatus[key]=!window.taskStatus[key];
              const { stateDoc } = await cloudRefs();
              await setDoc(stateDoc, { taskStatus: window.taskStatus }, { merge:true });
              renderCalendar();
            });
            cell.appendChild(t);
          }
        });

        (window.customTasks||[]).filter(t=>t.date===fullDate).forEach(task=>{
          const el=document.createElement('div');
          el.className='task-item custom-task';
          el.textContent=task.title;
          if(task.complete) el.classList.add('complete');
          el.addEventListener('click', async (e)=>{
            if(e.detail===1){
              if(!ensureLogin()) return;
              task.complete=!task.complete;
              const { tasksCol, stateDoc } = await cloudRefs();
              await setDoc(stateDoc, { taskStatus: window.taskStatus }, { merge:true });
              await setDoc(doc(tasksCol,String(task.id)), task, { merge:true });
              renderCalendar();
            }else if(e.detail===2){
              openTaskModal(task);
            }
          });
          cell.appendChild(el);
        });

        cell.addEventListener('click',(e)=>{
          if(e.target.classList.contains('calendar-day')||e.target.classList.contains('day-number')){
            openTaskModal({date:fullDate});
          }
        });

        calendarGrid.appendChild(cell);
      }
    }
    prevMonthBtn.addEventListener('click',()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
    nextMonthBtn.addEventListener('click',()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });
    addTaskBtn.addEventListener('click',()=>openTaskModal());

    function openTaskModal(task=null){
      currentTask = task;
      if(task?.id){
        modalTitle.textContent='작업 수정';
        taskTitleInput.value=task.title;
        taskDescriptionInput.value=task.description||'';
        taskDateInput.value=task.date||'';
        deleteTaskBtn.classList.remove('hidden');
      }else{
        modalTitle.textContent='새 작업';
        taskTitleInput.value='';
        taskDescriptionInput.value='';
        taskDateInput.value=task?.date||'';
        deleteTaskBtn.classList.add('hidden');
      }
      taskModal.classList.remove('hidden');
      taskModal.classList.add('flex');
    }
    function closeTaskModal(){
      taskModal.classList.add('hidden');
      taskModal.classList.remove('flex');
    }
    cancelBtn.addEventListener('click', closeTaskModal);
    taskModal.addEventListener('click',(e)=>{ if(e.target===taskModal) closeTaskModal(); });
    saveTaskBtn.addEventListener('click', async ()=>{
      if(!ensureLogin()) return;
      const title = taskTitleInput.value.trim();
      if(!title){ showAlert('제목을 입력하세요.'); return; }
      const data = {
        id: currentTask?.id || Date.now(),
        title,
        description: taskDescriptionInput.value.trim(),
        date: taskDateInput.value,
        complete: currentTask?.complete ?? false
      };
      const { tasksCol } = await cloudRefs();
      await setDoc(doc(tasksCol,String(data.id)), data, { merge:true });
      closeTaskModal();
    });
    deleteTaskBtn.addEventListener('click', async ()=>{
      if(!ensureLogin() || !currentTask?.id) { closeTaskModal(); return; }
      const { tasksCol } = await cloudRefs();
      await deleteDoc(doc(tasksCol,String(currentTask.id)));
      closeTaskModal();
    });

    // ===== Notes =====
    let notesTimer=null;
    notesTabs.forEach(tab=>{
      tab.addEventListener('click', async ()=>{
        notesTabs.forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        const key = tab.dataset.tab;
        notesArea.value = window.__notesTabs[key] || '';
      });
    });
    notesArea.addEventListener('input', ()=>{
      clearTimeout(notesTimer);
      notesTimer = setTimeout(saveNotes, 700);
    });
    async function saveNotes(){
      if(!ensureLogin()) return;
      const activeBtn = document.querySelector('#notes-section .notepad-tab.active');
      if(!activeBtn) return;
      const key = activeBtn.dataset.tab;
      const { stateDoc } = await cloudRefs();
      const snap = await getDoc(stateDoc);
      const prev = snap.exists()? (snap.data()||{}) : {};
      const notesTabsData = prev.notesTabs || {};
      notesTabsData[key] = notesArea.value;
      await setDoc(stateDoc, { notesTabs: notesTabsData }, { merge:true });
    }

    // ===== Bookmarks =====
    function renderImageBookmarks(){
      imageGrid.innerHTML='';
      (window.imageBookmarks||[]).forEach(d=>{
        const card = document.createElement('div');
        card.className = 'image-card group';
        card.innerHTML = `
          <div class="block w-full h-40">
            <img src="${d.url}" alt="북마크" class="w-full h-full object-cover"/>
          </div>
          <button class="absolute top-2 right-2 bg-black/60 text-white px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition" data-id="${d.id}">삭제</button>
        `;
        const imgEl = card.querySelector('img');
        imgEl.addEventListener('click', ()=>{
          modalImage.src = d.url;
          if(d.pageUrl){ goToPageBtn.style.display='block'; goToPageBtn.onclick=()=>window.open(d.pageUrl,'_blank'); }
          else{ goToPageBtn.style.display='none'; goToPageBtn.onclick=null; }
          imageModal.classList.add('show','flex');
        });
        card.querySelector('button').addEventListener('click', (e)=>{ e.stopPropagation(); deleteImage(d.id); });
        imageGrid.appendChild(card);
      });
    }
    closeImageModalBtn.addEventListener('click',()=>{ imageModal.classList.remove('show','flex'); });

    function isValidUrl(u){ try{ new URL(u); return true; }catch{ return false; } }

    // DnD: URL만 저장
    dragArea.addEventListener('dragover',(e)=>{ e.preventDefault(); dragArea.classList.add('active'); });
    dragArea.addEventListener('dragleave',()=>dragArea.classList.remove('active'));
    dragArea.addEventListener('drop', async (e)=>{
      e.preventDefault(); dragArea.classList.remove('active');
      if(!ensureLogin()) return;
      const url = e.dataTransfer.getData('URL');
      const html = e.dataTransfer.getData('text/html');
      const parsed = new DOMParser().parseFromString(html||'','text/html');
      const img = parsed.querySelector('img');

      if(img?.src && isValidUrl(img.src)){ await addUrlImage(img.src, e.dataTransfer.getData('text/uri-list')||img.src); return; }
      if(url && /\.(jpe?g|png|gif|webp|svg)$/i.test(url)){ await addUrlImage(url, url); return; }

      showAlert('유효한 이미지 URL을 드롭하세요.');
    });

    // 클릭: 클립보드 자동 읽기 -> 이미지 있으면 imgbb 업로드, 없으면 URL 텍스트 시도
    dragArea.addEventListener('click', async ()=>{
      if(!ensureLogin()) return;
      try{
        if(navigator.clipboard && navigator.clipboard.read){
          const items = await navigator.clipboard.read();
          for(const it of items){
            for(const type of it.types){
              if(type.startsWith('image/')){
                const blob = await it.getType(type);
                await addClipboardImage(new File([blob],'clipboard-image',{type:blob.type}), null);
                return;
              }
            }
          }
        }
        if(navigator.clipboard?.readText){
          const t = await navigator.clipboard.readText();
          if(t && isValidUrl(t) && /\.(jpe?g|png|gif|webp|svg)$/i.test(t)){ await addUrlImage(t,t); return; }
        }
        showAlert('클립보드에서 이미지/URL을 읽지 못했습니다. Ctrl/Cmd+V로 붙여넣기하세요.');
      }catch(e){ showAlert('클립보드 접근이 차단되었습니다. 사이트 권한에서 허용하세요.'); }
    });

    // 붙여넣기: 이미지 Blob이면 imgbb, URL이면 바로 저장
    dragArea.addEventListener('paste', async (e)=>{
      e.preventDefault();
      if(!ensureLogin()) return;
      const items = [...(e.clipboardData?.items || [])];
      for(const it of items){
        if(it.kind==='file' && it.type.startsWith('image/')){
          const file = it.getAsFile(); if(file){ await addClipboardImage(file,null); return; }
        }
        if(it.kind==='string' && (it.type==='text/uri-list' || it.type==='text/plain' || it.type==='text/html')){
          const textUri = e.clipboardData.getData('text/uri-list');
          const text = e.clipboardData.getData('text/plain');
          const html = e.clipboardData.getData('text/html');
          const srcFromHtml = html ? new DOMParser().parseFromString(html,'text/html').querySelector('img')?.src : null;
          const url = textUri || srcFromHtml || text;
          if(url && isValidUrl(url) && /\.(jpe?g|png|gif|webp|svg)$/i.test(url)){ await addUrlImage(url,url); return; }
        }
      }
      showAlert('붙여넣기한 항목에 유효한 이미지가 없습니다.');
    });

    // ===== Firestore ops for bookmarks =====
    async function addUrlImage(url, pageUrl){
      const { imagesCol } = await cloudRefs();
      await addDoc(imagesCol, { url, pageUrl: pageUrl||null, type:'url', timestamp:new Date() });
    }
    async function addClipboardImage(file, pageUrl){
      // imgbb 업로드
      const form = new FormData();
      form.append('image', file);
      const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method:'POST', body: form });
      const json = await res.json();
      if(!json.success) throw new Error(json?.error?.message || 'imgbb 업로드 실패');
      const link = json.data?.url || json.data?.display_url;
      const deleteUrl = json.data?.delete_url || null;
      const deleteId = deleteUrl ? (deleteUrl.match(/\/image\/([^/?#]+)/)?.[1] || null) : null;

      const { imagesCol } = await cloudRefs();
      await addDoc(imagesCol, {
        url: link, pageUrl: pageUrl||null, type:'imgbb',
        imgbb_delete_url: deleteUrl, imgbb_delete_id: deleteId,
        timestamp: new Date()
      });
    }
    async function deleteImage(id){
      if(!ensureLogin()) return;
      try{
        const row = (window.imageBookmarks||[]).find(d=>d.id===id);
        if(row?.type==='imgbb'){
          // 우선 delete_url 시도
          let ok=false;
          if(row.imgbb_delete_url){
            try{ const r=await fetch(row.imgbb_delete_url,{method:'GET'}); ok=r.ok; }catch{}
          }
          // 실패 시 공식 API 시도
          if(!ok && row.imgbb_delete_id){
            try{
              const r2=await fetch(`https://api.imgbb.com/1/image/${row.imgbb_delete_id}?key=${IMGBB_API_KEY}`,{method:'DELETE'});
              ok=r2.ok;
            }catch{}
          }
        }
        const { imagesCol } = await cloudRefs();
        await deleteDoc(doc(imagesCol,id));
      }catch(e){ showAlert('이미지 삭제 중 오류가 발생했습니다.'); }
    }

    // ===== Realtime sync =====
    async function setupRealtime(){
      const { tasksCol, stateDoc, imagesCol } = await cloudRefs();
      // clear old
      unsubs.forEach(fn=>{try{fn();}catch{}});
      unsubs = [];

      unsubs.push(onSnapshot(tasksCol,(snap)=>{
        window.customTasks = snap.docs.map(d=>({id:d.id, ...d.data()}));
        renderCalendar();
      }));
      unsubs.push(onSnapshot(stateDoc,(ds)=>{
        const data = ds.exists()? (ds.data()||{}) : {};
        window.taskStatus = data.taskStatus || {};
        window.__notesTabs = data.notesTabs || {};
        const activeBtn = document.querySelector('#notes-section .notepad-tab.active');
        if(activeBtn){ notesArea.value = window.__notesTabs[activeBtn.dataset.tab] || ''; }
        renderCalendar();
      }));
      unsubs.push(onSnapshot(imagesCol,(snap)=>{
        window.imageBookmarks = snap.docs.map(d=>({id:d.id, ...d.data()}));
        renderImageBookmarks();
      }));
    }

    // ===== Auth =====
    async function doSignIn(){
      try{ await signInWithPopup(auth, provider); }
      catch(e){
        if(e.code==='auth/popup-blocked' || e.code==='auth/unauthorized-domain'){
          await signInWithRedirect(auth, provider);
        }else{
          showAlert('로그인 오류: '+(e.message||e.code));
        }
      }
    }
    getRedirectResult(auth).catch(()=>{});

    signInBtn.addEventListener('click', doSignIn);
    signOutBtn.addEventListener('click', ()=>signOut(auth));

    onAuthStateChanged(auth, async (user)=>{
      loadingOverlay.classList.remove('hidden'); loadingOverlay.classList.add('flex');
      isAuthReady = false;

      if(user){
        userInfoEl.textContent = `${user.email||''}`;
        signInBtn.classList.add('hidden');
        signOutBtn.classList.remove('hidden');
        await setupRealtime();
      }else{
        userInfoEl.textContent = '';
        signInBtn.classList.remove('hidden');
        signOutBtn.classList.add('hidden');
        unsubs.forEach(fn=>{try{fn();}catch{}});
        unsubs = [];
        window.customTasks=[]; window.taskStatus={}; window.__notesTabs={}; window.imageBookmarks=[];
        renderCalendar(); renderImageBookmarks(); notesArea.value='';
      }

      loadingOverlay.classList.add('hidden'); loadingOverlay.classList.remove('flex');
      isAuthReady = true;
    });

    // 초기 렌더
    renderCalendar();
  </script>
</body>
</html>
