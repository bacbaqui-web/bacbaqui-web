<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë§Œí™” ì¼ì • ê´€ë¦¬</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
    body{font-family:'Noto Sans KR',sans-serif;background:#000;color:#fff;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px;flex-direction:column;gap:2rem}
    .notepad-section,.calendar-section{background:#2a2a2a;border-radius:12px;padding:24px;box-shadow:inset 0 0 10px rgba(0,0,0,.3);text-align:center;width:100%;max-width:1200px}
    .notepad-section{display:flex;flex-direction:column;padding-bottom:12px;padding-top:12px}
    .notepad-tabs{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .tab-container{display:flex;justify-content:space-around;flex-grow:1}
    .notepad-tab{background:#333;padding:8px 16px;border-radius:8px 8px 0 0;cursor:pointer;transition:.2s;font-weight:700}
    .notepad-tab.active{background:#1a1a1a}
    .notepad-tab:hover{background:#444}
    .notepad-section textarea{background:#1a1a1a;border:1px solid #333;color:#fff;padding:12px;border-radius:8px;min-height:900px;resize:vertical}
    .calendar-header{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:24px}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day-label,.calendar-day{text-align:center;padding:8px;border-radius:8px;background:#2a2a2a;position:relative;overflow:hidden}
    .day-label{background:#444;font-weight:700;color:#fff}
    .calendar-day{min-height:120px;padding-top:24px}
    .calendar-day.today{border:2px solid #ccc}
    .day-number{position:absolute;top:8px;left:8px;font-size:1.2rem;font-weight:700;color:#aaa}

    /* âœ… ëª¨ë°”ì¼ ê¸€ì ì„¸ë¡œê¹¨ì§ ë°©ì§€ */
    .task-item{
      font-size:.8rem;
      padding:4px 6px;
      border-radius:4px;
      margin-top:4px;
      cursor:pointer;
      white-space:nowrap;
      word-break:keep-all;
      overflow:hidden;
      text-overflow:ellipsis;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-height:24px;
    }
    .task-item.custom-task{background:#4c78a8}
    .task-item.episode-task{background:#444;color:#ddd}
    .task-item.recurring-shorts{background:#7d4040}
    .task-item.recurring-instatoon{background:#999966}
    .task-item.complete{background:#888;text-decoration:line-through;color:#ccc}

    .add-task-btn{background:#666;transition:.2s}
    .add-task-btn:hover{background:#777;transform:scale(1.02)}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:1000}
    .modal-content{background:#1a1a1a;border-radius:12px;padding:24px;width:90%;max-width:500px;box-shadow:0 10px 30px rgba(0,0,0,.5);position:relative}

    @media (max-width:480px){
      .calendar-header,.calendar-grid{gap:2px}
      .calendar-day{min-height:90px;padding-top:22px}
      .day-number{font-size:0.9rem}
      .task-item{font-size:11px;padding:2px 4px;border-radius:6px}
      .task-item.episode-task{font-size:10px}
    }
  </style>
</head>
<body class="text-white">

  <!-- ë¡œê·¸ì¸ ë°” -->
  <div id="authBar" class="w-full max-w-5xl mx-auto flex items-center justify-end gap-2">
    <span id="userInfo" class="text-sm opacity-80"></span>
    <button id="signInBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Google ë¡œê·¸ì¸</button>
    <button id="signOutBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded hidden">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <!-- ë‹¬ë ¥ -->
  <div id="calendar-section" class="calendar-section">
    <div class="flex justify-between items-center mb-4">
      <button id="prevMonthBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">&lt; ì´ì „ ë‹¬</button>
      <h2 id="currentMonthYear" class="text-2xl font-bold"></h2>
      <button id="nextMonthBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">ë‹¤ìŒ ë‹¬ &gt;</button>
    </div>
    <div class="calendar-header mb-2">
      <div class="day-label">ì¼</div><div class="day-label">ì›”</div><div class="day-label">í™”</div>
      <div class="day-label">ìˆ˜</div><div class="day-label">ëª©</div><div class="day-label">ê¸ˆ</div><div class="day-label">í† </div>
    </div>
    <div id="calendarGrid" class="calendar-grid"></div>
    <div class="mt-8 text-center">
      <button id="addTaskBtn" class="add-task-btn px-6 py-3 rounded-full font-bold text-white shadow-md">+ ê°œì¸ ì‘ì—… ì¶”ê°€</button>
    </div>
  </div>

  <!-- ë©”ëª¨ì¥ -->
  <div id="notepad-section" class="notepad-section mt-8">
    <div class="notepad-tabs">
      <div class="tab-container">
        <button class="notepad-tab active" data-tab="ë°”í€´ë©˜í„°ë¦¬">ë°”í€´ë©˜í„°ë¦¬</button>
        <button class="notepad-tab" data-tab="ì§ìŠ¹ìœ¡ì•„">ì§ìŠ¹ìœ¡ì•„</button>
        <button class="notepad-tab" data-tab="ê·¸ê±°ì•„ì„¸ìš”">ê·¸ê±°ì•„ì„¸ìš”</button>
        <button class="notepad-tab" data-tab="ë©”ëª¨">ë©”ëª¨</button>
      </div>
    </div>
    <textarea id="notesArea" class="flex-grow"></textarea>
  </div>

  <!-- ëª¨ë‹¬ -->
  <div id="taskModal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle" class="text-2xl font-bold mb-4">ìƒˆ ì‘ì—…</h2>
      <label for="taskTitle" class="block mb-2">ì œëª©:</label>
      <input type="text" id="taskTitle" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 mb-4">
      <label for="taskDescription" class="block mb-2">ì„¤ëª…:</label>
      <textarea id="taskDescription" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 mb-4 h-24"></textarea>
      <label for="taskDate" class="block mb-2">ë‚ ì§œ:</label>
      <input type="date" id="taskDate" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 mb-4">
      <div class="flex justify-end gap-2">
        <button id="saveTaskBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">ì €ì¥</button>
        <button id="cancelBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">ì·¨ì†Œ</button>
        <button id="deleteTaskBtn" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg hidden">ì‚­ì œ</button>
      </div>
    </div>
  </div>

  <!-- ===== JS ë¡œì§ & Firebase ì—°ë™ ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "ğŸ”¥ì—¬ê¸°ì— ë³¸ì¸ Firebase apiKey ì…ë ¥ğŸ”¥",
      authDomain: "comicschedule-dfec7.firebaseapp.com",
      projectId: "comicschedule-dfec7",
      storageBucket: "comicschedule-dfec7.appspot.com",
      messagingSenderId: "1084611276816",
      appId: "1:1084611276816:web:aca83237bafa971ed1fa95",
      measurementId: "G-ZNZZQRJZF9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const userInfoEl = document.getElementById('userInfo');

    const provider = new GoogleAuthProvider();
    async function doSignIn(){ try{ await signInWithPopup(auth, provider);}catch(e){await signInWithRedirect(auth, provider);} }
    getRedirectResult(auth);

    signInBtn.onclick = () => doSignIn();
    signOutBtn.onclick = () => signOut(auth);

    // === í´ë¼ìš°ë“œ ë™ê¸°í™” ===
    window.cloudRefs = async () => {
      const uid = auth.currentUser.uid;
      return {
        tasksCol: collection(db, `users/${uid}/customTasks`),
        stateDoc: doc(db, `users/${uid}/meta/appState`)
      };
    };

    window.ensureLogin = () => { if (!auth.currentUser){ alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.'); return false;} return true; };

    window.cloudLoadAll = async () => {
      if (!ensureLogin()) return;
      const { tasksCol, stateDoc } = await cloudRefs();
      const tasksSnap = await getDocs(tasksCol);
      window.customTasks = tasksSnap.docs.map(d => ({ id:d.id, ...d.data() }));
      const st = await getDoc(stateDoc);
      if (st.exists()){
        const data = st.data() || {};
        window.taskStatus = data.taskStatus || {};
        const notesArea = document.getElementById('notesArea');
        const allNotes = data.notesTabs || {};
        if (notesArea) notesArea.value = allNotes[window.activeTab] || '';
      }
      if (typeof renderCalendar==='function') renderCalendar();
    };

    window.cloudSaveAll = async () => {
      if (!ensureLogin()) return;
      const { tasksCol, stateDoc } = await cloudRefs();
      await setDoc(stateDoc, { taskStatus: window.taskStatus }, { merge:true });
      const ops = (window.customTasks||[]).map(t => setDoc(doc(tasksCol, String(t.id)), t, { merge:true }));
      await Promise.all(ops);
    };

    window.cloudSaveStateOnly = async () => {
      if (!ensureLogin()) return;
      const { stateDoc } = await cloudRefs();
      await setDoc(stateDoc, { taskStatus: window.taskStatus }, { merge:true });
    };

    window.cloudSaveNotes = async () => {
      if (!ensureLogin()) return;
      const { stateDoc } = await cloudRefs();
      const notesArea = document.getElementById('notesArea');
      const st = await getDoc(stateDoc);
      const prev = st.exists() ? (st.data()||{}) : {};
      const notesTabs = prev.notesTabs || {};
      notesTabs[window.activeTab] = notesArea.value;
      await setDoc(stateDoc, { notesTabs }, { merge:true });
    };

    // === ë¡œê·¸ì¸ ìƒíƒœ ===
    onAuthStateChanged(auth, async (user)=>{
      if(user){ userInfoEl.textContent = user.email; signInBtn.classList.add('hidden'); signOutBtn.classList.remove('hidden'); await window.cloudLoadAll();}
      else { userInfoEl.textContent=''; signOutBtn.classList.add('hidden'); signInBtn.classList.remove('hidden'); }
    });
  </script>
</body>
</html>
