<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>만화 일정 관리</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; background: #000; color: #fff; padding: 16px; }
    .section-card { background:#2a2a2a; border-radius:12px; padding:20px; }
    .notepad-tabs { display:flex; gap:1rem; }
    .notepad-tab { background:#1a1a1a; padding:6px 12px; border-radius:6px; cursor:pointer; }
    .notepad-tab.active { background:#2a2a2a; color:#fff; }
    .calendar-day { min-height:100px; background:#222; border-radius:8px; padding:4px; position:relative; }
    .day-number { position:absolute; top:4px; left:4px; font-size:0.75rem; }
    .task-item { margin-top:4px; padding:2px 4px; font-size:0.8rem; border-radius:4px; background:#555; }
    .drag-area { border:2px dashed #555; padding:20px; text-align:center; cursor:pointer; }
    .image-card img { border-radius:8px; }
  </style>
</head>
<body>

  <!-- 탭 -->
  <div class="notepad-tabs">
    <button class="notepad-tab active" data-tab="calendar">달력</button>
    <button class="notepad-tab" data-tab="notes">메모</button>
    <button class="notepad-tab" data-tab="bookmarks">북마크</button>
  </div>

  <!-- 캘린더 -->
  <div id="calendar-section" class="section-card mt-4">
    <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
  </div>

  <!-- 메모 -->
  <div id="notes-section" class="section-card mt-4 hidden">
    <textarea id="notesArea" class="w-full h-40 p-2 bg-black border border-gray-600 rounded"></textarea>
  </div>

  <!-- 북마크 -->
  <div id="bookmarks-section" class="section-card mt-4 hidden">
    <div id="drag-area" class="drag-area">이미지를 드래그하거나 붙여넣으세요</div>
    <div id="image-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4 mt-4"></div>
  </div>

  <!-- 알림 모달 -->
  <div id="alert-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-lg">
      <p id="modal-message" class="mb-4"></p>
      <button id="modal-close-btn" class="bg-gray-600 px-4 py-2 rounded">확인</button>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, deleteDoc, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCiwzde40jsz17CEz-rrMmmBrn-S6brdlE",
    authDomain: "comicschedule-dfec7.firebaseapp.com",
    projectId: "comicschedule-dfec7",
    storageBucket: "comicschedule-dfec7.appspot.com",
    messagingSenderId: "1084611276816",
    appId: "1:1084611276816:web:aca83237bafa971ed1fa95"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  const IMGBB_API_KEY = "f64175972f4e4178332db9ae8559969b";

  const dragArea = document.getElementById("drag-area");
  const imageGrid = document.getElementById("image-grid");
  const alertModal = document.getElementById("alert-modal");
  const modalMsg = document.getElementById("modal-message");

  function showAlert(msg){
    modalMsg.textContent = msg;
    alertModal.classList.remove("hidden");
  }
  document.getElementById("modal-close-btn").onclick=()=>alertModal.classList.add("hidden");

  async function cloudRefs(){
    const uid = auth.currentUser.uid;
    return { imagesCol: collection(db, `users/${uid}/images`) };
  }

  // Firestore 등록
  async function addRemoteImage(url,pageUrl){
    const { imagesCol } = await cloudRefs();
    await addDoc(imagesCol,{url,pageUrl,type:"remote",timestamp:new Date()});
  }
  async function addImage(file,pageUrl){
    const form=new FormData();
    form.append("image",file);
    const res=await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{method:"POST",body:form});
    const data=await res.json();
    const { imagesCol } = await cloudRefs();
    await addDoc(imagesCol,{
      url:data.data.url,
      pageUrl:pageUrl||null,
      type:"imgbb",
      imgbb_delete_url:data.data.delete_url,
      timestamp:new Date()
    });
  }
  window.deleteImage=async(id)=>{
    const { imagesCol } = await cloudRefs();
    const row=(window.imageBookmarks||[]).find(d=>d.id===id);
    if(row?.type==="remote"){
      await deleteDoc(doc(imagesCol,id));
      return;
    }
    if(row?.type==="imgbb" && row.imgbb_delete_url){
      try{await fetch(row.imgbb_delete_url,{method:"GET"});}catch(_){}
    }
    await deleteDoc(doc(imagesCol,id));
  };

  // 이미지 렌더
  function renderImageBookmarks(){
    imageGrid.innerHTML="";
    (window.imageBookmarks||[]).forEach(d=>{
      const card=document.createElement("div");
      card.className="image-card relative";
      card.innerHTML=`
        <img src="${d.url}" loading="lazy" class="w-full h-40 object-cover"/>
        <button data-id="${d.id}" class="absolute top-2 right-2 bg-black/50 text-white p-1 rounded">X</button>
      `;
      card.querySelector("button").onclick=(e)=>{
        e.stopPropagation();
        window.deleteImage(d.id);
      };
      imageGrid.appendChild(card);
    });
  }

  // 드래그앤드롭
  function extractDroppedUrl(e){
    const dt=e.dataTransfer;
    const html=dt.getData("text/html");
    if(html){
      const docu=new DOMParser().parseFromString(html,"text/html");
      const img=docu.querySelector("img");
      if(img?.src) return {url:img.src,page:dt.getData("text/uri-list")||dt.getData("URL")||null};
    }
    const uri=dt.getData("text/uri-list");
    if(uri) return {url:uri.split("\n")[0],page:uri};
    const plain=dt.getData("URL")||dt.getData("text/plain");
    if(plain) return {url:plain,page:plain};
    return null;
  }
  dragArea.addEventListener("dragover",e=>{e.preventDefault();dragArea.classList.add("bg-gray-700");});
  dragArea.addEventListener("dragleave",()=>dragArea.classList.remove("bg-gray-700"));
  dragArea.addEventListener("drop",async(e)=>{
    e.preventDefault();dragArea.classList.remove("bg-gray-700");
    const hit=extractDroppedUrl(e);
    if(hit && /\.(jpe?g|png|gif|webp|svg|avif)(\?|$)/i.test(hit.url)){
      await addRemoteImage(hit.url,hit.page); return;
    }
    const files=[...(e.dataTransfer.files||[])].filter(f=>f.type.startsWith("image/"));
    if(files.length){await addImage(files[0],null);return;}
    showAlert("이미지 URL을 찾지 못했습니다.");
  });

  // 붙여넣기
  dragArea.addEventListener("paste",async(e)=>{
    e.preventDefault();
    const items=[...(e.clipboardData?.items||[])];
    for(const item of items){
      if(item.kind==="file" && item.type.startsWith("image/")){
        const f=item.getAsFile(); await addImage(f,null); return;
      }
      if(item.kind==="string"){
        const txt=await new Promise(r=>item.getAsString(r));
        if(/\.(jpe?g|png|gif|webp|svg|avif)(\?|$)/i.test(txt)){await addRemoteImage(txt,txt);return;}
      }
    }
    showAlert("붙여넣기한 항목에 유효한 이미지가 없습니다.");
  });

  // 실시간 반영
  window.imageBookmarks=[];
  onAuthStateChanged(auth,async(user)=>{
    if(user){
      const { imagesCol } = await cloudRefs();
      onSnapshot(imagesCol,(snap)=>{
        window.imageBookmarks=snap.docs.map(d=>({id:d.id,...d.data()}));
        renderImageBookmarks();
      });
    }
  });
  // 자동 로그인
  signInWithPopup(auth,provider).catch(()=>{});
</script>
</body>
</html>
