<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>만화 일정 관리</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght400;700&display=swap" rel="stylesheet"/>
  <style>
    body{font-family:'Noto Sans KR',sans-serif;background:#000;color:#fff;display:flex;justify-content:flex-start;align-items:center;min-height:100vh;padding:16px;flex-direction:column;gap:0}
    .tab-content{display:none}.tab-content.active{display:flex;flex-direction:column;flex-grow:1}
    .section-card{background:#2a2a2a;border-radius:12px;padding:20px;box-shadow:inset 0 0 10px rgba(0,0,0,.3);text-align:center;width:100%;max-width:800px}
    .notepad-tabs{display:flex;justify-content:center;align-items:center;gap:1rem;width:100%;max-width:800px}
    .notepad-tab{background:#1a1a1a;padding:8px 16px;border-radius:8px 8px 0 0;cursor:pointer;transition:.2s;font-weight:700;color:#737373;font-size:.85rem}
    .notepad-tab.active,.notepad-tab:hover{background:#2a2a2a;color:#fff}
    .notes-area{flex-grow:1;resize:vertical}
    textarea#notesArea::-webkit-scrollbar{width:8px;background-color:#2a2a2a;border-radius:10px}
    textarea#notesArea::-webkit-scrollbar-thumb{background-color:#555;border-radius:10px}
    .calendar-header{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:4px}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
    .day-label,.calendar-day{text-align:center;padding:8px 2px;border-radius:8px;background:#2a2a2a;position:relative;overflow:hidden;word-wrap:break-word}
    .day-label{background:#444;font-weight:700;color:#fff;font-size:.8rem;padding:8px 0}
    .calendar-day{min-height:160px;padding-top:16px;padding-left:2px;padding-right:2px;display:flex;flex-direction:column;gap:2px}
    .calendar-day.today{border:2px solid #ccc}
    .day-number{position:absolute;top:8px;left:8px;font-size:.85rem;font-weight:700;color:#aaa;z-index:10}
    .task-item{font-size:.85rem;padding:5px 6px;border-radius:8px;margin-top:4px;word-wrap:break-word;cursor:pointer;text-align:left}
    .task-item.custom-task{background:#4c78a8}
    .task-item.episode-task{background:#444;color:#ddd}
    .task-item.recurring-shorts{background:#7d4040}
    .task-item.recurring-instatoon{background:#999966}
    .task-item.complete{background:#888;text-decoration:line-through;color:#ccc}
    .add-task-btn{background:#666;transition:.2s}.add-task-btn:hover{background:#777;transform:scale(1.02)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:1000}
    .modal-content{background:#1a1a1a;border-radius:12px;padding:24px;width:90%;max-width:500px;box-shadow:0 10px 30px rgba(0,0,0,.5);position:relative}
    .drag-area{border:2px dashed #4b4b4b;transition:all .3s ease;padding:24px}
    .drag-area.active{border-color:#6b6b6b;background-color:#2a2a2a}
    
    #image-grid {
        column-count: 2;
        column-gap: 1rem;
        margin-top: 1.5rem;
        display: block;
    }
    @media (min-width: 640px) {
        #image-grid { column-count: 3; }
    }
    @media (min-width: 1024px) {
        #image-grid { column-count: 4; }
    }

    .bookmark-card{
        position: relative;
        transition: transform .2s ease-in-out; 
        background: #333; 
        border-radius: 8px; 
        overflow: hidden; 
        margin-bottom: 1rem;
        break-inside: avoid;
        width: 100%;
        display: block;
    }
    .bookmark-card:hover{transform:translateY(-5px)}
    
    .bookmark-card .content {
        display: block; 
        width: 100%;
        height: auto;
        overflow: hidden;
        background-color: #1a1a1a;
        min-height: 80px; 
        position: relative;
    }
    
    .bookmark-card img {
        position: static; 
        width: 100%;
        height: auto;
        display: block;
        object-fit: contain; 
    }

    .bookmark-card .img-fit-cover {
        object-fit: cover; 
        height: 100%;
    }
    
    .bookmark-card .icon-overlay {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex; justify-content: center; align-items: center;
        color: white; font-size: 3rem;
    }
    .bookmark-card .link-title-overlay {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        color: white; padding: 10px;
        text-align: center;
    }
    .bookmark-card .link-title-text {
        font-size: 1rem;
        font-weight: 700;
        margin-bottom: 5px;
        word-break: break-all;
    }
    .bookmark-card .link-url-text {
        font-size: 0.75rem;
        opacity: 0.7;
        word-break: break-all;
    }
    
    .bookmark-card .video-title-overlay {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(80, 0, 0, 0.7);
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        color: white; padding: 10px;
        text-align: center;
    }
    .bookmark-card .video-title-text {
        font-size: 1rem;
        font-weight: 700;
        margin-bottom: 5px;
        word-break: break-all;
    }
    .bookmark-card .video-url-text {
        font-size: 0.75rem;
        opacity: 0.7;
        word-break: break-all;
    }
    
    .bookmark-card .instagram-overlay { display: none; } 
    
    .bookmark-card .content > div[style*="max-width:540px"] {
        max-width: 100% !important; 
        width: 100% !important;
        box-sizing: border-box;
    }

    .domain-header {
        column-span: all;
        width: 100%;
        margin: 20px 0 10px;
        padding: 8px 0;
        color: #fff;
        font-size: 1.25rem;
        font-weight: 700;
        border-bottom: 2px solid #555;
        text-align: left;
    }

    @media (max-width:768px){
      body{padding:12px;gap:0}.section-card{padding:12px;border-radius:0}
      .notepad-tabs{gap:.5rem}.notepad-tab{padding:6px 12px;font-size:.8rem}
      .calendar-day{min-height:120px;padding:1.5rem .2rem .2rem;gap:1px}.day-number{font-size:.75rem;top:.5rem;left:.5rem}
      .task-item{font-size:.85rem;padding:2px 4px;margin-top:2px}
      .calendar-grid,.calendar-header{gap:0}.add-task-btn{width:100%;font-size:.9rem}
      .modal-content{padding:16px;width:95%}
      .domain-header { font-size: 1rem; }
    }
    .calendar-grid{grid-gap:4px}
    @media (max-width:768px){.calendar-grid{grid-gap:0}}

    #imageModal.modal {
        background: rgba(0, 0, 0, 0.7);
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
    }
    #imageModal .modal-content {
        background-color: transparent;
        padding: 0;
        box-shadow: none;
        max-width: 90vw;
        max-height: 90vh;
        width: auto; 
        height: auto; 
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
    }
    #modalImage {
        width: auto; 
        height: auto; 
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }
    
    #editTitleModal.modal { z-index: 1001; }
    #editTitleModal .modal-content {
        background: #2a2a2a; 
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(0,0,0,.5);
    }
  </style>
</head>
<body class="text-white">
  <div id="authBar" class="w-full max-w-2xl mx-auto flex items-center justify-end gap-2 mb-4">
    <span id="userInfo" class="text-sm opacity-80"></span>
    <button id="signInBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Google 로그인</button>
    <button id="signOutBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded hidden">로그아웃</button>
  </div>

  <div id="main-tabs" class="notepad-tabs mx-auto">
    <button class="notepad-tab active" data-tab="calendar">달력</button>
    <button class="notepad-tab" data-tab="notes">메모</button>
    <button class="notepad-tab" data-tab="bookmarks">북마크</button>
  </div>

  <div id="calendar-section" class="section-card tab-content active">
    <div class="flex justify-between items-center mb-4">
      <button id="prevMonthBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">&lt; 이전 달</button>
      <h2 id="currentMonthYear" class="text-lg font-bold"></h2>
      <button id="nextMonthBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">다음 달 &gt;</button>
    </div>
    <div class="calendar-header mb-2">
      <div class="day-label">일</div><div class="day-label">월</div><div class="day-label">화</div>
      <div class="day-label">수</div><div class="day-label">목</div><div class="day-label">금</div><div class="day-label">토</div>
    </div>
    <div id="calendarGrid" class="calendar-grid"></div>
    <div class="mt-8 text-center">
      <button id="addTaskBtn" class="add-task-btn px-6 py-3 rounded-full font-bold text-white shadow-md">+ 개인 작업 추가</button>
    </div>
  </div>

  <div id="notes-section" class="section-card tab-content">
    <div class="notepad-tabs">
      <button class="notepad-tab active" data-tab="바퀴멘터리">바퀴멘터리</button>
      <button class="notepad-tab" data-tab="짐승육아">짐승육아</button>
      <button class="notepad-tab" data-tab="그거아세요">그거아세요</button>
      <button class="notepad-tab" data-tab="메모">메모</button>
    </div>
    <textarea id="notesArea" class="w-full notes-area p-4 bg-black text-white border border-gray-700 focus:outline-none focus:ring-1 focus:ring-gray-500 rounded-lg"></textarea>
  </div>

  <div id="bookmarks-section" class="section-card tab-content text-left">
    
    <div class="flex justify-between items-center mb-4">
        <div class="flex gap-2 items-center text-sm">
            <span class="text-gray-400">정렬 기준:</span>
            <select id="bookmarkSortSelect" class="bg-gray-700 p-1 rounded text-white focus:outline-none">
                <option value="timestamp">최신순</option>
                <option value="sourceDomain" selected>사이트별 정렬</option>
            </select>
        </div>
    </div>

    <section id="drag-area" class="drag-area rounded-lg p-6 flex items-center justify-center text-center text-[#999] font-medium cursor-pointer" title="클릭하면 클립보드에서 자동 붙여넣기 시도">
      <div>이미지/동영상/일반 페이지 URL 또는 인스타그램 퍼가기 코드를 붙여넣기 또는 드래그하세요. 캡쳐/이미지는 붙여넣기(Ctrl/Cmd+V)를 사용하세요.</div>
    </section>
    <section id="image-grid"></section>
  </div>

  <div id="taskModal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle" class="text-2xl font-bold mb-4">새 작업</h2>
      <label class="block mb-2">제목:</label>
      <input type="text" id="taskTitle" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 mb-4">
      <label class="block mb-2">설명:</label>
      <textarea id="taskDescription" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 mb-4 h-24"></textarea>
      <label class="block mb-2">날짜:</label>
      <input type="date" id="taskDate" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 mb-4">
      <div class="flex justify-end gap-2">
        <button id="saveTaskBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">저장</button>
        <button id="cancelBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">취소</button>
        <button id="deleteTaskBtn" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg hidden">삭제</button>
      </div>
    </div>
  </div>

  <div id="imageModal" class="modal">
    <div class="modal-content relative">
      <button id="closeImageModalBtn" class="absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full p-1 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
      <img id="modalImage" src="" alt="확대 이미지" />
      <button id="goToPageBtn" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg z-50">원본 페이지로 이동</button>
    </div>
  </div>

  <div id="editTitleModal" class="modal">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4">북마크 제목 수정</h2>
      <label class="block mb-2 text-sm opacity-80" id="currentUrlDisplay"></label>
      <input type="text" id="editTitleInput" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 mb-4 text-white">
      <div class="flex justify-end gap-2">
        <button id="saveTitleBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">저장</button>
        <button id="cancelTitleBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">취소</button>
      </div>
    </div>
  </div>


  <div id="alert-modal" class="fixed inset-0 bg-[#1a1a1a] bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-[#242424] rounded-lg p-6 shadow-xl max-w-sm mx-auto">
      <p id="modal-message" class="text-white text-lg text-center font-medium"></p>
      <div class="mt-4 flex justify-center">
        <button id="modal-close-btn" class="px-4 py-2 bg-[#424242] text-white rounded-md hover:bg-[#525252]">확인</button>
      </div>
    </div>
  </div>

  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-70 z-[1001] flex items-center justify-center hidden">
    <div class="flex flex-col items-center">
      <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"></div>
      <p class="text-white mt-4 text-lg">데이터를 불러오는 중...</p>
    </div>
  </div>

  <script>
    window.customTasks = window.customTasks || [];
    window.taskStatus = window.taskStatus || {};
    window.__notesTabs = window.__notesTabs || {};
    window.imageBookmarks = window.imageBookmarks || [];
    window.currentTask = null;
    window.currentEditingBookmark = null;
    let currentDate = new Date();
    window.isAuthReady = false;
    window.bookmarkSortKey = 'sourceDomain';

    const tabButtons = document.querySelectorAll('#main-tabs .notepad-tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const mainNotepadTabs = document.querySelectorAll('#notes-section .notepad-tabs .notepad-tab');
    const notesArea = document.getElementById('notesArea');
    const dragArea = document.getElementById('drag-area');
    const imageGrid = document.getElementById('image-grid');
    const imageModal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const closeImageModalBtn = document.getElementById('closeImageModalBtn');
    const goToPageBtn = document.getElementById('goToPageBtn');
    const editTitleModal = document.getElementById('editTitleModal');
    const editTitleInput = document.getElementById('editTitleInput');
    const saveTitleBtn = document.getElementById('saveTitleBtn');
    const cancelTitleBtn = document.getElementById('cancelTitleBtn');
    const currentUrlDisplay = document.getElementById('currentUrlDisplay');
    const bookmarkSortSelect = document.getElementById('bookmarkSortSelect');

    const showFeedbackMessage = (message) => {
      const el = document.createElement('div');
      el.textContent = message;
      el.style.cssText="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.8);color:#fff;padding:16px 20px;border-radius:10px;z-index:2000;max-width:90%";
      document.body.appendChild(el); setTimeout(()=>el.remove(),2000);
    };
    const showAlert = (msg) => { document.getElementById('modal-message').textContent = msg; document.getElementById('alert-modal').classList.remove('hidden'); };
    const hideAlert = () => { document.getElementById('alert-modal').classList.add('hidden'); };
    document.getElementById('modal-close-btn').addEventListener('click', hideAlert);

    const openImageModal = (imageUrl, pageUrl) => {
      modalImage.src = imageUrl;
      if (pageUrl){ goToPageBtn.style.display='block'; goToPageBtn.onclick=()=>window.open(pageUrl,'_blank'); }
      else goToPageBtn.style.display='none';
      imageModal.style.display='flex';
    };
    const closeImageModal = () => { imageModal.style.display = 'none'; };

    const openEditModal = (bookmark) => {
        window.currentEditingBookmark = bookmark;
        const currentTitle = bookmark.title || '';
        const displayUrl = bookmark.pageUrl.length > 50 ? bookmark.pageUrl.substring(0, 47) + '...' : bookmark.pageUrl;
        
        currentUrlDisplay.textContent = `URL: ${displayUrl}`;
        editTitleInput.value = currentTitle;
        editTitleModal.style.display = 'flex';
    };

    const closeEditModal = () => {
        window.currentEditingBookmark = null;
        editTitleModal.style.display = 'none';
    };

    const saveEditedTitle = async () => {
        if (!window.currentEditingBookmark || !window.ensureLogin()) return;

        const newTitle = editTitleInput.value.trim();
        const bookmark = window.currentEditingBookmark;

        if (bookmark.type === 'link' || bookmark.type === 'video' || bookmark.type === 'instagram') {
            await window.updateBookmarkTitle(bookmark.id, newTitle);
        }
        
        closeEditModal();
        showFeedbackMessage('제목이 저장되었습니다.');
    };

    function showTab(tabId){
      tabContents.forEach(c=>c.classList.remove('active'));
      tabButtons.forEach(b=>b.classList.remove('active'));
      document.getElementById(`${tabId}-section`).classList.add('active');
      const btn=document.querySelector(`#main-tabs .notepad-tab[data-tab="${tabId}"]`); if(btn) btn.classList.add('active');
    }
    showTab('calendar');
    tabButtons.forEach(b=>b.addEventListener('click',()=>showTab(b.dataset.tab)));
    mainNotepadTabs.forEach(tab=>{
      tab.addEventListener('click',()=>{
        mainNotepadTabs.forEach(t=>t.classList.remove('active')); tab.classList.add('active');
        window.activeTab = tab.dataset.tab;
        notesArea.value = (window.__notesTabs||{})[window.activeTab] || '';
      });
    });

    const TZ='Asia/Seoul';
    function ymdKST(date){ return new Intl.DateTimeFormat('en-CA',{timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit'}).format(date); }
    function toKST(date){ return new Date(date.toLocaleString('en-US',{timeZone:TZ})); }
    function countWeekdaysBetweenKST(a,b){ let c=0,start=toKST(new Date(Math.min(a,b))),end=toKST(new Date(Math.max(a,b))),cur=new Date(start); while(cur<=end){ const d=cur.getDay(); if(d>=0&&d<=4)c++; cur.setDate(cur.getDate()+1);} return c;}

    const fixedSchedules=[{title:'쇼츠',daysOfWeek:[1,3,5],colorClass:'recurring-shorts'},{title:'웹툰',daysOfWeek:[2,4,6],colorClass:'recurring-instatoon'}];

    const taskModal=document.getElementById('taskModal');
    const cancelBtn=document.getElementById('cancelBtn');
    const saveTaskBtn=document.getElementById('saveTaskBtn');
    const deleteTaskBtn=document.getElementById('deleteTaskBtn');
    const taskTitleInput=document.getElementById('taskTitle');
    const taskDescriptionInput=document.getElementById('taskDescription');
    const taskDateInput=document.getElementById('taskDate');

    const attachEventListeners=()=>{
      const prevMonthBtn=document.getElementById('prevMonthBtn');
      const nextMonthBtn=document.getElementById('nextMonthBtn');
      const addTaskBtn=document.getElementById('addTaskBtn');
      prevMonthBtn?.addEventListener('click',()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn?.addEventListener('click',()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });
      addTaskBtn?.addEventListener('click',()=>openModal());
      if(notesArea){
        notesArea.addEventListener('input',()=>window.cloudSaveNotesDebounced&&window.cloudSaveNotesDebounced());
        notesArea.addEventListener('blur',()=>window.cloudSaveNotes&&window.cloudSaveNotes());
      }
      cancelBtn.addEventListener('click',closeModal);
      saveTaskBtn.addEventListener('click',saveTask);
      deleteTaskBtn.addEventListener('click',()=>window.deleteTask&&window.deleteTask());
      taskModal.addEventListener('click',(e)=>{ if(e.target===taskModal) closeModal(); });

      closeImageModalBtn.addEventListener('click', closeImageModal);
      imageModal.addEventListener('click',(e)=>{ if(e.target===imageModal) closeImageModal(); }); 
      document.querySelector('#imageModal .modal-content').addEventListener('click', (e) => {
          if (!e.target.closest('#closeImageModalBtn') && !e.target.closest('#goToPageBtn')) {
              closeImageModal();
          }
      });
      
      cancelTitleBtn.addEventListener('click', closeEditModal);
      saveTitleBtn.addEventListener('click', saveEditedTitle);
      editTitleModal.addEventListener('click', (e) => { if (e.target === editTitleModal) closeEditModal(); });
      editTitleInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
              e.preventDefault();
              saveEditedTitle();
          }
      });
      
      bookmarkSortSelect.addEventListener('change', (e) => {
          window.bookmarkSortKey = e.target.value;
          renderImageBookmarks();
      });
    };

    const renderCalendar=()=>{
      const year=currentDate.getFullYear(), month=currentDate.getMonth();
      const currentMonthYear=document.getElementById('currentMonthYear');
      const calendarGrid=document.getElementById('calendarGrid'); if(!currentMonthYear||!calendarGrid) return;
      currentMonthYear.textContent=`${year}년 ${month+1}월`; calendarGrid.innerHTML='';
      const firstDay=toKST(new Date(year,month,1)).getDay(); const daysInMonth=new Date(year,month+1,0).getDate();
      for(let i=0;i<firstDay;i++){ const empty=document.createElement('div'); empty.className='calendar-day'; calendarGrid.appendChild(empty); }
      for(let day=1;day<=daysInMonth;day++){
        const dayDiv=document.createElement('div'); dayDiv.classList.add('calendar-day','relative');
        const thisDate=new Date(year,month,day); const fullDate=ymdKST(thisDate); const dayOfWeek=toKST(thisDate).getDay();
        const today=toKST(new Date()); if(ymdKST(thisDate)===ymdKST(today)) dayDiv.classList.add('today');
        const dayNumberSpan=document.createElement('span'); dayNumberSpan.classList.add('day-number'); dayNumberSpan.textContent=day; dayDiv.appendChild(dayNumberSpan);

        if(dayOfWeek>=0&&dayOfWeek<=4){
          const milestoneDate=new Date('2025-09-01'); const weekdaysBetween=countWeekdaysBetweenKST(milestoneDate.getTime(), thisDate.getTime());
          const milestoneEpisode=2014; const episodeNumber=(toKST(thisDate)>=toKST(milestoneDate))? milestoneEpisode+weekdaysBetween-1 : milestoneEpisode-(weekdaysBetween-1);
          const epItem=document.createElement('div'); epItem.classList.add('task-item','episode-task'); epItem.textContent=`${episodeNumber}화`;
          const key=`${fullDate}_바퀴멘터리 ${episodeNumber}화`; if((window.taskStatus||{})[key]) epItem.classList.add('complete');
          epItem.addEventListener('click',async(e)=>{ e.stopPropagation(); if(!window.ensureLogin||!window.ensureLogin()) return; window.taskStatus=window.taskStatus||{}; window.taskStatus[key]=!window.taskStatus[key]; await window.cloudSaveStateOnly(); renderCalendar();});
          dayDiv.appendChild(epItem);
        }

        fixedSchedules.forEach(sch=>{
          if(sch.daysOfWeek.includes(dayOfWeek)){
            const t=document.createElement('div'); t.classList.add('task-item',sch.colorClass); t.textContent=sch.title;
            const key=`${fullDate}_${sch.title}`; if((window.taskStatus||{})[key]) t.classList.add('complete');
            t.addEventListener('click',async(e)=>{ e.stopPropagation(); if(!window.ensureLogin||!window.ensureLogin()) return; window.taskStatus=window.taskStatus||{}; window.taskStatus[key]=!window.taskStatus[key]; await window.cloudSaveStateOnly(); renderCalendar();});
            dayDiv.appendChild(t);
          }
        });

        (window.customTasks||[]).filter(t=>t.date===fullDate).forEach(task=>{
          const el=document.createElement('div'); el.classList.add('task-item','custom-task'); el.textContent=task.title;
          if(task.complete) el.classList.add('complete');
          el.addEventListener('click',async(e)=>{ if(e.detail===1){ if(!window.ensureLogin||!window.ensureLogin()) return; task.complete=!task.complete; await window.cloudSaveAll(); renderCalendar(); } else if(e.detail===2){ openModal(task); }});
          dayDiv.appendChild(el);
        });

        dayDiv.addEventListener('click',(e)=>{ if(e.target.classList.contains('calendar-day')||e.target.classList.contains('day-number')) openModal({date:fullDate});});
        calendarGrid.appendChild(dayDiv);
      }
    };

    function getYoutubeThumbnail(url) {
        let videoId = null;
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        if (match && match[2].length === 11) {
            videoId = match[2];
        }
        if (videoId) {
            return `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
        }
        return null;
    }
    
    function initializeInstagramEmbeds() {
        if (window.instgrm && window.instgrm.Embeds) {
            window.instgrm.Embeds.process();
            return;
        }

        const scriptId = 'instagram-embed-script';
        if (!document.getElementById(scriptId)) {
            const script = document.createElement('script');
            script.id = scriptId;
            script.async = true;
            script.src = '//www.instagram.com/embed.js';
            document.head.appendChild(script);
            
            script.onload = () => {
                if (window.instgrm && window.instgrm.Embeds) {
                    window.instgrm.Embeds.process();
                }
            };
        }
    }

    const renderImageBookmarks=()=>{
      imageGrid.innerHTML='';
      
      let sortedBookmarks = [...(window.imageBookmarks || [])];

      let currentSortKey = window.bookmarkSortKey || 'sourceDomain';
      bookmarkSortSelect.value = currentSortKey;

      if (currentSortKey === 'sourceDomain') {
          sortedBookmarks.sort((a, b) => {
              const domainA = a.sourceDomain || 'Unknown Source';
              const domainB = b.sourceDomain || 'Unknown Source';
              return domainA.localeCompare(domainB);
          });
      } else {
          sortedBookmarks.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
      }

      let lastDomain = null;

      sortedBookmarks.forEach(d=>{
        const isVideo = d.type === 'video';
        const isLink = d.type === 'link';
        const isInstagram = d.type === 'instagram';
        const isImage = d.type === 'imgbb' || d.type === 'firebase_storage' || d.type === 'remote';
        
        const isEditable = isVideo || isLink || isInstagram;
        const imageUrl = d.url;
        const pageUrl = d.pageUrl;
        const sourceDomain = d.sourceDomain || 'Unknown Source';

        if (currentSortKey === 'sourceDomain' && sourceDomain !== lastDomain) {
            const header = document.createElement('h3');
            header.className = 'domain-header';
            header.textContent = sourceDomain;
            imageGrid.appendChild(header);
            lastDomain = sourceDomain;
        }
        
        let thumbnail = isVideo ? getYoutubeThumbnail(pageUrl) : imageUrl;
        let iconHtml = '';
        let urlToOpen = pageUrl;

        if (isLink) {
            const displayTitle = d.title || '일반 페이지 링크';
            const displayUrl = pageUrl.replace(/^https?:\/\//, '').replace(/\/$/, '');
            
            iconHtml = `<div class="link-title-overlay">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.708l4-4a4 4 0 015.656 0l4 4a4 4 0 01-5.656 5.656l-1.102-1.101" />
                            </svg>
                            <span class="link-title-text">${displayTitle}</span>
                            <span class="link-url-text">${displayUrl}</span>
                        </div>`;
        } else if (isInstagram) {
             const parser = new DOMParser();
             const doc = parser.parseFromString(d.embedCode || '', 'text/html');
             const blockquote = doc.querySelector('blockquote.instagram-media');
             if (blockquote && blockquote.cite) urlToOpen = blockquote.cite;
             else urlToOpen = pageUrl;
             
             const displayTitle = d.title || 'Instagram Post (클릭 시 원본 이동)';
             
             iconHtml = `
                <div class="w-full h-full relative z-0">
                    ${d.embedCode || ''}
                    <div class="absolute top-0 left-0 right-0 p-2 bg-black bg-opacity-70 text-white text-sm font-bold z-10">${displayTitle}</div>
                </div>
             `;

        } else if (isVideo && !thumbnail) {
            const displayTitle = d.title || '동영상 북마크 (제목 편집 가능)';
            const displayUrl = pageUrl.replace(/^https?:\/\//, '').substring(0, 30) + '...';
            
            iconHtml = `<div class="video-title-overlay">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-red-400 mb-2" fill="currentColor" viewBox="0 0 24 24"><path d="M6 4l12 8-12 8z"/></svg>
                            <span class="video-title-text">${displayTitle}</span>
                            <span class="video-url-text">${displayUrl}</span>
                        </div>`;
        } else if (isImage) {
            iconHtml = `<img src="${imageUrl}" alt="북마크된 이미지" loading="lazy" decoding="async" onerror="this.onerror=null;this.src='https://placehold.co/100x120/444/fff?text=이미지+오류'"/>`;
        } else if (isVideo) {
            const displayTitle = d.title || 'YouTube 영상';
            iconHtml = `<img src="${thumbnail}" alt="동영상 썸네일" loading="lazy" decoding="async" class="img-fit-cover" onerror="this.onerror=null;this.src='https://placehold.co/100x120/444/fff?text=동영상+썸네일'"/>
                        <div class="icon-overlay flex-col">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="currentColor" viewBox="0 0 24 24"><path d="M6 4l12 8-12 8z"/></svg>
                            <span class="text-xs mt-1 font-bold">${displayTitle}</span>
                        </div>`;
        } else {
             iconHtml = `<div class="link-title-overlay">
                            <span class="link-title-text">알 수 없는 북마크</span>
                        </div>`;
        }

        const card=document.createElement('div');
        card.className='bookmark-card relative group cursor-pointer';
        card.innerHTML=`
          <div class="content">
            ${iconHtml}
          </div>
          <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs px-2 py-1 truncate z-10 opacity-70">
              ${sourceDomain}
          </div>
          <button class="absolute top-2 right-2 bg-[#424242] text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity z-20" data-id="${d.id}" data-action="delete">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
          ${isEditable ? `
          <button class="absolute top-2 right-9 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity z-20" data-id="${d.id}" data-action="edit">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
            </svg>
          </button>
          ` : ''}
          `;
        imageGrid.appendChild(card);
        
        card.addEventListener('click',(e)=>{
            if (e.target.closest('button[data-action]')) return; 

            if (isVideo || isLink || isInstagram) {
                window.open(urlToOpen, '_blank');
            } else if (isImage) {
                openImageModal(imageUrl, pageUrl);
            }
        });
      });
      
      imageGrid.querySelectorAll('button[data-action]').forEach(btn=>{
        btn.onclick=async(e)=>{ 
          e.stopPropagation(); 
          const id=e.currentTarget.dataset.id;
          const action=e.currentTarget.dataset.action;
          const bookmark = window.imageBookmarks.find(d => d.id === id);

          if (action === 'delete') {
             try{ 
                 if(window.deleteImage) await window.deleteImage(id);
             }catch(err){ 
                 console.error(err); 
                 showAlert('북마크 삭제 중 오류가 발생했습니다.'); 
             }
          } else if (action === 'edit' && bookmark) {
             openEditModal(bookmark);
          }
        };
      });
      
      initializeInstagramEmbeds();
    };

    const openModal=(task=null)=>{
      window.currentTask=task;
      if(task&&task.id){ document.getElementById('modalTitle').textContent='작업 수정'; taskTitleInput.value=task.title; taskDescriptionInput.value=task.description||''; taskDateInput.value=task.date||''; deleteTaskBtn.classList.remove('hidden'); }
      else if(task&&task.date){ document.getElementById('modalTitle').textContent='새 작업'; taskTitleInput.value=''; taskDescriptionInput.value=''; taskDateInput.value=task.date; deleteTaskBtn.classList.add('hidden'); }
      else{ document.getElementById('modalTitle').textContent='새 작업'; taskTitleInput.value=''; taskDescriptionInput.value=''; taskDateInput.value=''; deleteTaskBtn.classList.add('hidden'); }
      taskModal.style.display='flex';
    };
    const closeModal=()=>{ taskModal.style.display='none'; };

    const saveTask=async ()=>{
      if(!window.ensureLogin||!window.ensureLogin()) return;
      window.customTasks=window.customTasks||[]; window.taskStatus=window.taskStatus||{};
      const title=taskTitleInput.value.trim(); const description=taskDescriptionInput.value.trim(); const date=taskDateInput.value;
      if(!title){ showFeedbackMessage('제목을 입력해주세요.'); return; }
      const data={ id: window.currentTask&&window.currentTask.id ? window.currentTask.id : Date.now(), title, description, date, complete: window.currentTask?.complete ?? false };
      const idx=window.customTasks.findIndex(t=>t.id===data.id); if(idx>-1) window.customTasks[idx]=data; else window.customTasks.push(data);
      await window.cloudSaveAll(); closeModal(); renderCalendar();
    };

    (function init(){ 
        attachEventListeners(); 
        bookmarkSortSelect.value = window.bookmarkSortKey;
        renderCalendar(); 
    })();

    function isImageUrl(u){
      try{ new URL(u); }catch{ return false; }
      return /\.(jpe?g|png|gif|webp|svg|avif)(\?|$)/i.test(u);
    }
    
    function isVideoUrl(u){
        if (!u) return false;
        try { new URL(u); } catch { return false; }
        return /youtu\.be|youtube\.com|vimeo\.com|\.(mp4|webm|ogg|mov)(\?|$)|missav\.com/i.test(u);
    }
    
    function isInstagramEmbed(text) {
        return /<blockquote class="instagram-media".*<\/blockquote>/.test(text);
    }
    
    function extractDomain(url) {
        if (!url) return 'Unknown';
        try {
            const urlObj = new URL(url.includes('://') ? url : 'https://' + url);
            let domain = urlObj.hostname;
            if (domain.startsWith('www.')) domain = domain.substring(4);
            return domain;
        } catch {
            return 'Unknown';
        }
    }

    function isGenericUrl(u) {
        if (!u) return false;
        try {
            const urlObj = new URL(u);
            return (urlObj.protocol === 'http:' || urlObj.protocol === 'https:') && urlObj.hostname.includes('.') && !isImageUrl(u) && !isVideoUrl(u) && !/instagram\.com/.test(u);
        } catch {
            return false;
        }
    }

    dragArea.addEventListener('dragover',(e)=>{ e.preventDefault(); dragArea.classList.add('active'); });
    dragArea.addEventListener('dragleave',()=>{ dragArea.classList.remove('active'); });
    dragArea.addEventListener('drop',async(e)=>{
      e.preventDefault(); dragArea.classList.remove('active');
      const dt=e.dataTransfer;
      const html=dt.getData('text/html');
      const plainText = dt.getData('text/plain');

      let url=null, pageUrl=null;
      
      if(plainText && isInstagramEmbed(plainText)) {
          if(window.addInstagramBookmark) { await window.addInstagramBookmark(plainText); return; }
      }
      
      if(html){
        const doc=new DOMParser().parseFromString(html,'text/html');
        const img=doc.querySelector('img');
        if(img?.src){ url=img.src; pageUrl=dt.getData('text/uri-list')||dt.getData('URL')||null; }
      }
      if(!url){ const u=dt.getData('text/uri-list')||dt.getData('URL')||plainText; if(u) { url=u; pageUrl=u; } }

      if(url){
          if(isImageUrl(url)){ 
              if(window.addRemoteImage){ await window.addRemoteImage(url,pageUrl); } 
              return; 
          } else if(isVideoUrl(url)) {
              if(window.addVideoBookmark) { await window.addVideoBookmark(url); }
              return;
          } else if(isGenericUrl(url)) {
              if(window.addGenericBookmark) { await window.addGenericBookmark(url); }
              return;
          }
      }

      const files=[...(dt.files||[])].filter(f=>f.type.startsWith('image/'));
      if(files.length){ 
          if(window.addImage){ await window.addImage(files[0], null); return; }
      }

      showAlert('유효한 콘텐츠를 찾지 못했습니다.');
    });

    dragArea.addEventListener('click', async ()=>{
      try{
        let processed = false;
        
        if(navigator.clipboard?.read){
          const items=await navigator.clipboard.read();
          for(const it of items){
            for(const type of it.types){
              if(type.startsWith('image/')){
                const blob=await it.getType(type);
                if(window.addImage){ await window.addImage(new File([blob],'clipboard-image',{type:blob.type}), null); processed=true; return; }
              }
            }
          }
        }
        
        const t = await navigator.clipboard.readText();
        if(t){
            if (isInstagramEmbed(t)) {
                if(window.addInstagramBookmark) { await window.addInstagramBookmark(t); processed=true; return; }
            } else if(isImageUrl(t)){ 
                if(window.addRemoteImage){ await window.addRemoteImage(t,t); processed=true; return; } 
            } else if(isVideoUrl(t)){
                if(window.addVideoBookmark) { await window.addVideoBookmark(t); processed=true; return; }
            } else if(isGenericUrl(t)) {
                if(window.addGenericBookmark) { await window.addGenericBookmark(t); processed=true; return; }
            }
        }
        
        if(!processed) showAlert('클립보드에서 유효한 콘텐츠를 읽지 못했습니다.');
      }catch(e){ console.error(e); showAlert('클립보드 권한을 허용하세요.'); }
    });

    dragArea.addEventListener('paste', async (e)=>{
      e.preventDefault();
      const items=[...(e.clipboardData||e.originalEvent?.clipboardData)?.items||[]];
      let foundText = null;

      for(const item of items){
        if(item.kind==='file' && item.type.startsWith('image/')){
          const file=item.getAsFile(); 
          if(file && window.addImage){ await window.addImage(file,null); return; }
        }
        if(item.kind==='string'){
          const txt=await new Promise(r=>item.getAsString(r));
          if(txt){
             if (isInstagramEmbed(txt)) {
                 if(window.addInstagramBookmark) { await window.addInstagramBookmark(txt); return; }
             } else if(isImageUrl(txt)){ 
                if(window.addRemoteImage){ await window.addRemoteImage(txt,txt); return; } 
             } else if(isVideoUrl(txt)){
                 if(window.addVideoBookmark) { await window.addVideoBookmark(txt); return; }
             } else if(isGenericUrl(txt)){
                 if(window.addGenericBookmark) { await window.addGenericBookmark(txt); return; }
             }
             foundText = txt;
          }
        }
      }
      
      if (!foundText) {
          const plain=e.clipboardData?.getData('text/plain');
          if(plain){
             if (isInstagramEmbed(plain)) {
                 if(window.addInstagramBookmark) { await window.addInstagramBookmark(plain); return; }
             } else if(isImageUrl(plain)){ 
                if(window.addRemoteImage){ await window.addRemoteImage(plain,plain); return; } 
             } else if(isVideoUrl(plain)){
                if(window.addVideoBookmark) { await window.addVideoBookmark(plain); return; }
             } else if(isGenericUrl(plain)){
                if(window.addGenericBookmark) { await window.addGenericBookmark(plain); return; }
             }
          }
      }
      
      showAlert('붙여넣기한 항목에 유효한 이미지, 동영상 URL, 일반 페이지 URL 또는 인스타그램 퍼가기 코드가 없습니다.');
    });
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, onSnapshot, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    import { 
      getStorage, 
      ref, 
      uploadBytes, 
      getDownloadURL, 
      deleteObject 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCiwzde40jsz17CEz-rrMmmBrn-S6brdlE",
      authDomain: "comicschedule-dfec7.firebaseapp.com",
      projectId: "comicschedule-dfec7",
      storageBucket: "comicschedule-dfec7.appspot.com",
      messagingSenderId: "1084611276816",
      appId: "1:1084611276816:web:aca83237bafa971ed1fa95",
      measurementId: "G-ZNZZQRJZF9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const signInBtn=document.getElementById('signInBtn');
    const signOutBtn=document.getElementById('signOutBtn');
    const userInfoEl=document.getElementById('userInfo');
    const loadingOverlay=document.getElementById('loading-overlay');
    const provider = new GoogleAuthProvider();
    
    function extractDomain(url) {
        if (!url) return 'Unknown';
        try {
            const urlObj = new URL(url.includes('://') ? url : 'https://' + url);
            let domain = urlObj.hostname;
            if (domain.startsWith('www.')) domain = domain.substring(4);
            return domain;
        } catch {
            return 'Unknown';
        }
    }


    async function doSignIn(){
      try{ await signInWithPopup(auth,provider); }
      catch(e){
        if(e.code==='auth/popup-blocked'||e.code==='auth/unauthorized-domain'){ await signInWithRedirect(auth,provider); }
        else{ document.getElementById('modal-message').textContent='로그인 오류: '+(e.message||e.code); document.getElementById('alert-modal').classList.remove('hidden'); }
      }
    }
    getRedirectResult(auth).catch(()=>{});

    signInBtn.onclick=()=>doSignIn();
    signOutBtn.onclick=()=>signOut(auth);

    window.cloudRefs=async ()=>{
      const uid=auth.currentUser.uid;
      const userPath=`users/${uid}`;
      return {
        tasksCol: collection(db, `${userPath}/customTasks`),
        stateDoc: doc(db, `${userPath}/meta/appState`),
        imagesCol: collection(db, `${userPath}/images`),
      };
    };

    window.ensureLogin=()=>{
      if(!window.isAuthReady){ document.getElementById('modal-message').textContent='데이터 로딩 중입니다.'; document.getElementById('alert-modal').classList.remove('hidden'); return false; }
      if(!auth.currentUser){ document.getElementById('modal-message').textContent='로그인 후 이용해 주세요.'; document.getElementById('alert-modal').classList.remove('hidden'); return false; }
      return true;
    };

    let notesTimer=null;
    window.cloudSaveNotesDebounced=function(){ clearTimeout(notesTimer); notesTimer=setTimeout(()=>window.cloudSaveNotes&&window.cloudSaveNotes(),800); };

    window.cloudSaveAll=async ()=>{
      if(!ensureLogin()) return;
      const { tasksCol, stateDoc } = await cloudRefs();
      window.taskStatus=window.taskStatus||{}; window.customTasks=window.customTasks||[];
      await setDoc(stateDoc,{taskStatus:window.taskStatus},{merge:true});
      const ops=window.customTasks.map(t=>setDoc(doc(tasksCol,String(t.id)),t,{merge:true}));
      await Promise.all(ops);
    };

    window.cloudSaveStateOnly=async ()=>{
      if(!ensureLogin()) return;
      const { stateDoc } = await cloudRefs();
      window.taskStatus=window.taskStatus||{};
      await setDoc(stateDoc,{taskStatus:window.taskStatus},{merge:true});
    };

    window.cloudSaveNotes=async ()=>{
      if(!ensureLogin()) return;
      const { stateDoc } = await cloudRefs();
      const st=await getDoc(stateDoc);
      const prev=st.exists()?(st.data()||{}):{};
      const notesTabs=prev.notesTabs||{};
      const activeTabButton=document.querySelector('#notes-section .notepad-tab.active');
      if(activeTabButton){ notesTabs[activeTabButton.dataset.tab]=document.getElementById('notesArea')?.value ?? ''; }
      await setDoc(stateDoc,{notesTabs},{merge:true});
    };

    window.deleteTask=async ()=>{
      if(!ensureLogin() || !window.currentTask?.id){ if(typeof closeModal==='function') closeModal(); return; }
      const { tasksCol } = await cloudRefs();
      await deleteDoc(doc(tasksCol,String(window.currentTask.id)));
      window.customTasks=(window.customTasks||[]).filter(t=>t.id!==window.currentTask.id);
      if(typeof renderCalendar==='function') renderCalendar();
    };

    window.addVideoBookmark = async (url)=>{
      if(!ensureLogin()) return;
      const { imagesCol } = await cloudRefs();
      await addDoc(imagesCol,{ pageUrl: url, url: null, type:'video', title: null, sourceDomain: extractDomain(url), timestamp:new Date() }); 
      showFeedbackMessage('동영상 URL 북마크됨');
    };
    
    window.addGenericBookmark = async (url)=>{
      if(!ensureLogin()) return;
      const { imagesCol } = await cloudRefs();
      await addDoc(imagesCol,{ pageUrl: url, url: null, type:'link', title: null, sourceDomain: extractDomain(url), timestamp:new Date() }); 
      showFeedbackMessage('페이지 URL 북마크됨');
    };
    
    window.addInstagramBookmark = async (embedCode)=>{
      if(!ensureLogin()) return;
      const { imagesCol } = await cloudRefs();
      
      let pageUrl = '인스타그램 게시물';
      const parser = new DOMParser();
      const doc = parser.parseFromString(embedCode, 'text/html');
      const blockquote = doc.querySelector('blockquote.instagram-media');
      if(blockquote && blockquote.cite) pageUrl = blockquote.cite;
      
      await addDoc(imagesCol,{ pageUrl: pageUrl, embedCode: embedCode, url: null, type:'instagram', title: null, sourceDomain: extractDomain(pageUrl), timestamp:new Date() }); 
      showFeedbackMessage('인스타그램 게시물 북마크됨');
    };

    window.addRemoteImage = async (url, pageUrl)=>{
      if(!ensureLogin()) return;
      const { imagesCol } = await cloudRefs();
      await addDoc(imagesCol,{ url, pageUrl: pageUrl||null, type:'remote', sourceDomain: extractDomain(pageUrl || url), timestamp:new Date() });
      showFeedbackMessage('이미지 URL 북마크됨');
    };
    
    window.addImage = async (file, pageUrl)=>{
      if(!ensureLogin()) return;

      if (typeof file === 'string') {
          return window.addRemoteImage(file, pageUrl || file);
      }
      
      try{
        const { imagesCol } = await cloudRefs();
        const user = auth.currentUser;
        if (!user) throw new Error("로그인이 필요합니다.");

        const storagePath = `users/${user.uid}/uploads/${Date.now()}_${file.name}`;
        const storageRef = ref(storage, storagePath);

        showFeedbackMessage('이미지 업로드 중...');
        const uploadResult = await uploadBytes(storageRef, file);
        
        const downloadURL = await getDownloadURL(uploadResult.ref);
        
        const source = pageUrl ? extractDomain(pageUrl) : 'Uploaded (Firebase)';

        await addDoc(imagesCol,{ 
          url: downloadURL,
          pageUrl: pageUrl || null,
          type: 'firebase_storage',
          storagePath: storagePath,
          title: null, 
          sourceDomain: source, 
          timestamp: new Date() 
        });
        showFeedbackMessage('이미지가 업로드되었습니다.');

      }catch(err){
        console.error("Firebase Storage 업로드 실패:", err);
        document.getElementById('modal-message').textContent='이미지 추가 실패: '+(err.message||'오류');
        document.getElementById('alert-modal').classList.remove('hidden');
      }
    };

    window.updateBookmarkTitle = async (id, newTitle) => {
        if (!ensureLogin()) return;
        const { imagesCol } = await cloudRefs();
        const docRef = doc(imagesCol, id);
        
        try {
            await updateDoc(docRef, { title: newTitle || null });
        } catch (e) {
            console.error("제목 업데이트 오류:", e);
            showAlert("제목을 저장하는 중 오류가 발생했습니다.");
        }
    };

    window.deleteImage = async (id)=>{
      if(!ensureLogin()) return;
      try{
        const { imagesCol } = await cloudRefs();
        const row=(window.imageBookmarks||[]).find(d=>d.id===id); 
        
        if(!row) throw new Error('북마크 항목을 찾을 수 없습니다.');
        
        if (row.type === 'firebase_storage') {
          if (row.storagePath) {
            try {
              const fileRef = ref(storage, row.storagePath);
              await deleteObject(fileRef);
            } catch (e) {
              console.warn("Storage 파일 삭제 실패 (무시함):", e);
            }
          }
          await deleteDoc(doc(imagesCol, id));
          showFeedbackMessage('북마크가 삭제되었습니다.');

        } else if(row.type==='imgbb'){
          const delUrl=row.imgbb_delete_url||null;
          if(delUrl){ 
            try{ 
                await fetch(delUrl,{method:'GET'}); 
            }catch(_){} 
          }
          await deleteDoc(doc(imagesCol,id));
          showFeedbackMessage('북마크가 삭제되었습니다.');
        
        } else if(row.type==='remote' || row.type === 'video' || row.type === 'link' || row.type === 'instagram'){
          await deleteDoc(doc(imagesCol,id));
          showFeedbackMessage('북마크가 삭제되었습니다.');
        
        } else {
            await deleteDoc(doc(imagesCol, id));
            showFeedbackMessage('북마크가 삭제되었습니다.');
        }

      }catch(e){
        document.getElementById('modal-message').textContent='북마크 삭제 중 오류: '+(e?.message||'unknown');
        document.getElementById('alert-modal').classList.remove('hidden');
      }
    };

    window.__unsubs=[];
    async function setupRealtimeSync(){
      const { tasksCol, stateDoc, imagesCol } = await cloudRefs();
      window.__unsubs.forEach(fn=>{ try{ fn(); }catch(_){} }); window.__unsubs=[];

      const unsubTasks = onSnapshot(tasksCol,(snap)=>{ window.customTasks=snap.docs.map(d=>({id:d.id,...d.data()})); if(typeof renderCalendar==='function') renderCalendar(); });
      window.__unsubs.push(unsubTasks);

      const unsubState = onSnapshot(stateDoc,(ds)=>{ const data=ds.exists()?(ds.data()||{}):{}; window.taskStatus=data.taskStatus||{}; window.__notesTabs=data.notesTabs||{}; const activeTabButton=document.querySelector('#notes-section .notepad-tab.active'); const notesAreaEl=document.getElementById('notesArea'); if(notesAreaEl&&activeTabButton){ notesAreaEl.value=window.__notesTabs[activeTabButton.dataset.tab]||''; } if(typeof renderCalendar==='function') renderCalendar(); });
      window.__unsubs.push(unsubState);

      const unsubImages = onSnapshot(imagesCol,(snap)=>{ 
          window.imageBookmarks=snap.docs.map(d=>({id:d.id,...d.data()})); 
          if(typeof renderImageBookmarks==='function') renderImageBookmarks(); 
      });
      window.__unsubs.push(unsubImages);
    }

    onAuthStateChanged(auth, async (user)=>{
      loadingOverlay.classList.remove('hidden'); window.isAuthReady=false;
      if(user){
        userInfoEl.textContent = `${user.displayName || '로그인됨'} (${user.email || ''})`;
        signInBtn.classList.add('hidden');
        signOutBtn.classList.remove('hidden');
        await setupRealtimeSync();
      }else{
        userInfoEl.textContent=''; signOutBtn.classList.add('hidden'); signInBtn.classList.remove('hidden');
        window.__unsubs.forEach(fn=>{ try{ fn(); }catch(_){} }); window.__unsubs=[];
        window.customTasks=[]; window.taskStatus={}; window.imageBookmarks=[]; window.__notesTabs={};
        if(typeof renderCalendar==='function') renderCalendar(); if(typeof renderImageBookmarks==='function') renderImageBookmarks(); const na=document.getElementById('notesArea'); if(na) na.value='';
      }
      loadingOverlay.classList.add('hidden'); window.isAuthReady=true;
    });
  </script>
</body>
</html>
