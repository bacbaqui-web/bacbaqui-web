<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë§Œí™” ì¼ì • ê´€ë¦¬</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: black;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      flex-direction: column;
      gap: 2rem;
    }
    .notepad-section, .calendar-section {
      background-color: #2a2a2a;
      border-radius: 12px;
      padding: 24px;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
      text-align: center;
      width: 100%;
      max-width: 1200px;
    }
    .notepad-section { display: flex; flex-direction: column; padding-bottom: 12px; padding-top: 12px; }
    .notepad-tabs { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .tab-container { display: flex; justify-content: space-around; flex-grow: 1; }
    .notepad-tab { background-color: #333; padding: 8px 16px; border-radius: 8px 8px 0 0; cursor: pointer; transition: background-color 0.2s; font-weight: bold; }
    .notepad-tab.active { background-color: #1a1a1a; }
    .notepad-tab:hover { background-color: #444; }
    .notepad-section textarea {
      background-color: #1a1a1a; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 8px;
      min-height: 900px; resize: vertical;
    }
    .calendar-section { flex-grow: 1; }
    .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 24px; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .day-label, .calendar-day { text-align: center; padding: 8px; border-radius: 8px; background-color: #2a2a2a; position: relative; overflow: hidden; word-wrap: break-word; }
    .day-label { background-color: #444; font-weight: bold; color: #fff; }
    .calendar-day { min-height: 120px; padding-top: 24px; }
    .calendar-day.today { border: 2px solid #ccc; }
    .day-number { position: absolute; top: 8px; left: 8px; font-size: 1.2rem; font-weight: bold; color: #aaa; }
    .task-item { font-size: 0.8rem; padding: 4px; border-radius: 4px; margin-top: 4px; word-wrap: break-word; cursor: pointer; }
    .task-item.custom-task { background-color: #4c78a8; }
    .task-item.episode-task { background-color: #444; color: #ddd; cursor: pointer; }
    .task-item.recurring-shorts { background-color: #7d4040; cursor: pointer; }
    .task-item.recurring-instatoon { background-color: #999966; cursor: pointer; }
    .task-item.complete { background-color: #888; text-decoration: line-through; color: #ccc; }
    .add-task-btn { background-color: #666; transition: background-color 0.2s, transform 0.2s; }
    .add-task-btn:hover { background-color: #777; transform: scale(1.02); }
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000;
    }
    .modal-content {
      background-color: #1a1a1a; border-radius: 12px; padding: 24px; width: 90%; max-width: 500px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative;
    }
    @media (max-width: 768px) {
      body { padding: 16px; gap: 1.5rem; }
      .calendar-day { min-height: 100px; padding-top: 28px; }
      .day-number { font-size: 1rem; }
      .task-item { font-size: 0.7rem; }
      .calendar-grid, .calendar-header { gap: 4px; }
      .add-task-btn { width: 100%; }
    }
  </style>
</head>
<body class="text-white">

  <!-- ë¡œê·¸ì¸ ë°” -->
  <div id="authBar" class="w-full max-w-5xl mx-auto flex items-center justify-end gap-2">
    <span id="userInfo" class="text-sm opacity-80"></span>
    <button id="signInBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Google ë¡œê·¸ì¸</button>
    <button id="signOutBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded hidden">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <div id="calendar-section" class="calendar-section">
    <div class="flex justify-between items-center mb-4">
      <button id="prevMonthBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">&lt; ì´ì „ ë‹¬</button>
      <h2 id="currentMonthYear" class="text-2xl font-bold"></h2>
      <button id="nextMonthBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">ë‹¤ìŒ ë‹¬ &gt;</button>
    </div>
    <div class="calendar-header mb-2">
      <div class="day-label">ì¼</div><div class="day-label">ì›”</div><div class="day-label">í™”</div>
      <div class="day-label">ìˆ˜</div><div class="day-label">ëª©</div><div class="day-label">ê¸ˆ</div><div class="day-label">í† </div>
    </div>
    <div id="calendarGrid" class="calendar-grid"></div>
    <div class="mt-8 text-center">
      <button id="addTaskBtn" class="add-task-btn px-6 py-3 rounded-full font-bold text-white shadow-md">+ ê°œì¸ ì‘ì—… ì¶”ê°€</button>
    </div>
  </div>

  <div id="notepad-section" class="notepad-section mt-8">
    <div class="notepad-tabs">
      <div class="tab-container">
        <button class="notepad-tab active" data-tab="ë°”í€´ë©˜í„°ë¦¬">ë°”í€´ë©˜í„°ë¦¬</button>
        <button class="notepad-tab" data-tab="ì§ìŠ¹ìœ¡ì•„">ì§ìŠ¹ìœ¡ì•„</button>
        <button class="notepad-tab" data-tab="ê·¸ê±°ì•„ì„¸ìš”">ê·¸ê±°ì•„ì„¸ìš”</button>
        <button class="notepad-tab" data-tab="ë©”ëª¨">ë©”ëª¨</button>
      </div>
      <button id="generateIdeaBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full ml-4 whitespace-nowrap">
        ì•„ì´ë””ì–´ ìƒì„± âœ¨
      </button>
    </div>
    <textarea id="notesArea" class="flex-grow"></textarea>
  </div>

  <!-- ëª¨ë‹¬ -->
  <div id="taskModal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle" class="text-2xl font-bold mb-4">ìƒˆ ì‘ì—…</h2>
      <label for="taskTitle" class="block mb-2">ì œëª©:</label>
      <input type="text" id="taskTitle" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 mb-4">
      <label for="taskDescription" class="block mb-2">ì„¤ëª…:</label>
      <textarea id="taskDescription" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 mb-4 h-24"></textarea>
      <label for="taskDate" class="block mb-2">ë‚ ì§œ:</label>
      <input type="date" id="taskDate" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 mb-4">
      <div class="flex justify-end gap-2">
        <button id="saveTaskBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">ì €ì¥</button>
        <button id="cancelBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">ì·¨ì†Œ</button>
        <button id="deleteTaskBtn" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg transition duration-200 hidden">ì‚­ì œ</button>
      </div>
    </div>
  </div>

  <!-- ===== ì•± ìŠ¤í¬ë¦½íŠ¸ ===== -->
  <script>
    // ìƒíƒœ
    let customTasks = [];
    let taskStatus = {};
    let currentDate = new Date();
    let currentTask = null;
    let activeTab = 'ë°”í€´ë©˜í„°ë¦¬';

    // ê³ ì • ìŠ¤ì¼€ì¤„(ìš”ì¼: 0=ì¼~6=í† )
    const fixedSchedules = [
      { title: 'ì‡¼ì¸ ', daysOfWeek: [1,3,5], colorClass: 'recurring-shorts' },
      { title: 'ì›¹íˆ°', daysOfWeek: [2,4,6], colorClass: 'recurring-instatoon' }
    ];

    // ê³µí†µ DOM
    const taskModal = document.getElementById('taskModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveTaskBtn = document.getElementById('saveTaskBtn');
    const deleteTaskBtn = document.getElementById('deleteTaskBtn');
    const taskTitleInput = document.getElementById('taskTitle');
    const taskDescriptionInput = document.getElementById('taskDescription');
    const taskDateInput = document.getElementById('taskDate');
    const generateIdeaBtn = document.getElementById('generateIdeaBtn');

    // ìœ í‹¸: ì•ˆë‚´ í† ìŠ¤íŠ¸
    const showFeedbackMessage = (message) => {
      const feedbackDiv = document.createElement('div');
      feedbackDiv.textContent = message;
      feedbackDiv.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background-color: rgba(0,0,0,0.8); color: white; padding: 16px 20px;
        border-radius: 10px; z-index: 2000; text-align: center; max-width: 90%;
      `;
      document.body.appendChild(feedbackDiv);
      setTimeout(() => feedbackDiv.remove(), 2000);
    };

    // í‰ì¼ ìˆ˜ ê³„ì‚°(ì¼~ëª©)
    function countWeekdaysBetween(startDate, endDate) {
      let count = 0;
      const start = new Date(Math.min(startDate.getTime(), endDate.getTime()));
      const end = new Date(Math.max(startDate.getTime(), endDate.getTime()));
      const cur = new Date(start);
      while (cur.getTime() <= end.getTime()) {
        const day = cur.getDay();
        if (day >= 0 && day <= 4) count++;
        cur.setDate(cur.getDate() + 1);
      }
      return count;
    }

    // ì´ë²¤íŠ¸
    const attachEventListeners = () => {
      const prevMonthBtn = document.getElementById('prevMonthBtn');
      const nextMonthBtn = document.getElementById('nextMonthBtn');
      const addTaskBtn  = document.getElementById('addTaskBtn');
      const notepadTabs = document.querySelectorAll('.notepad-tab');
      const notesArea   = document.getElementById('notesArea');

      prevMonthBtn?.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn?.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });
      addTaskBtn?.addEventListener('click', () => openModal());

      notepadTabs?.forEach(tab => {
        tab.addEventListener('click', () => {
          notepadTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          activeTab = tab.dataset.tab;
          cloudLoadNotes(); // íƒ­ ë°”ê¾¸ë©´ í•´ë‹¹ íƒ­ ë©”ëª¨ ë¡œë“œ
        });
      });

      notesArea?.addEventListener('input', () => cloudSaveNotesDebounced());

      cancelBtn.addEventListener('click', closeModal);
      saveTaskBtn.addEventListener('click', saveTask);
      deleteTaskBtn.addEventListener('click', deleteTask);
      taskModal.addEventListener('click', (e) => { if (e.target === taskModal) closeModal(); });

      generateIdeaBtn?.addEventListener('click', generateIdea);
    };

    // ë‹¬ë ¥ ë Œë”
    const renderCalendar = () => {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const currentMonthYear = document.getElementById('currentMonthYear');
      const calendarGrid = document.getElementById('calendarGrid');
      if (!currentMonthYear || !calendarGrid) return;

      currentMonthYear.textContent = `${year}ë…„ ${month+1}ì›”`;
      calendarGrid.innerHTML = '';

      const firstDayOfMonth = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month+1, 0).getDate();

      for (let i=0;i<firstDayOfMonth;i++){
        const empty = document.createElement('div');
        empty.classList.add('calendar-day');
        calendarGrid.appendChild(empty);
      }

      for (let day=1; day<=daysInMonth; day++){
        const dayDiv = document.createElement('div');
        dayDiv.classList.add('calendar-day','relative');

        const fullDate = `${year}-${(month+1).toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
        const today = new Date();
        if (year===today.getFullYear() && month===today.getMonth() && day===today.getDate()){
          dayDiv.classList.add('today');
        }

        const dayNumberSpan = document.createElement('span');
        dayNumberSpan.classList.add('day-number');
        dayNumberSpan.textContent = day;
        dayDiv.appendChild(dayNumberSpan);

        const dayOfWeek = new Date(year, month, day).getDay();
        if (dayOfWeek >= 0 && dayOfWeek <= 4) {
          const milestoneDate = new Date('2025-09-01');
          const milestoneEpisode = 2014;
          const current = new Date(year, month, day);
          const weekdaysBetween = countWeekdaysBetween(milestoneDate, current);
          const episodeNumber = (current.getTime() >= milestoneDate.getTime())
              ? milestoneEpisode + weekdaysBetween - 1
              : milestoneEpisode - (weekdaysBetween - 1);

          const epItem = document.createElement('div');
          epItem.classList.add('task-item','episode-task');
          epItem.textContent = `${episodeNumber}í™”`;

          const key = `${fullDate}_ë°”í€´ë©˜í„°ë¦¬ ${episodeNumber}í™”`;
          if (taskStatus[key]) epItem.classList.add('complete');
          epItem.addEventListener('click', async (e) => { e.stopPropagation(); await toggleTaskStatus(key); });

          dayDiv.appendChild(epItem);
        }

        fixedSchedules.forEach(sch => {
          if (sch.daysOfWeek.includes(dayOfWeek)) {
            const t = document.createElement('div');
            t.classList.add('task-item', sch.colorClass);
            t.textContent = sch.title;
            const key = `${fullDate}_${sch.title}`;
            if (taskStatus[key]) t.classList.add('complete');
            t.addEventListener('click', async (e) => { e.stopPropagation(); await toggleTaskStatus(key); });
            dayDiv.appendChild(t);
          }
        });

        customTasks.filter(t => t.date===fullDate).forEach(task => {
          const el = document.createElement('div');
          el.classList.add('task-item','custom-task');
          el.textContent = task.title;
          if (task.complete) el.classList.add('complete');
          el.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (e.detail===1){ // ë‹¨í´ë¦­: ì™„ë£Œ í† ê¸€
              task.complete = !task.complete;
              await cloudSaveAll();
              renderCalendar();
            } else if (e.detail===2){ // ë”ë¸”í´ë¦­: í¸ì§‘
              openModal(task);
            }
          });
          dayDiv.appendChild(el);
        });

        dayDiv.addEventListener('click', (e)=>{
          if (e.target.classList.contains('calendar-day') || e.target.classList.contains('day-number')){
            openModal({ date: fullDate });
          }
        });

        calendarGrid.appendChild(dayDiv);
      }
    };

    // ëª¨ë‹¬ ì œì–´
    const openModal = (task=null) => {
      currentTask = task;
      if (task && task.id){
        document.getElementById('modalTitle').textContent = 'ì‘ì—… ìˆ˜ì •';
        taskTitleInput.value = task.title;
        taskDescriptionInput.value = task.description || '';
        taskDateInput.value = task.date || '';
        deleteTaskBtn.classList.remove('hidden');
      } else if (task && task.date){
        document.getElementById('modalTitle').textContent = 'ìƒˆ ì‘ì—…';
        taskTitleInput.value = ''; taskDescriptionInput.value = ''; taskDateInput.value = task.date;
        deleteTaskBtn.classList.add('hidden');
      } else {
        document.getElementById('modalTitle').textContent = 'ìƒˆ ì‘ì—…';
        taskTitleInput.value = ''; taskDescriptionInput.value = ''; taskDateInput.value = '';
        deleteTaskBtn.classList.add('hidden');
      }
      taskModal.style.display = 'flex';
    };
    const closeModal = () => { taskModal.style.display = 'none'; };

    // ê³ ì • ì‘ì—… ì™„ë£Œ í† ê¸€
    const toggleTaskStatus = async (taskKey) => {
      if (!ensureLogin()) return;
      taskStatus[taskKey] = !taskStatus[taskKey];
      await cloudSaveStateOnly();
      renderCalendar();
    };

    // ì‘ì—… ì €ì¥(ì¶”ê°€/ìˆ˜ì •)
    const saveTask = async () => {
      if (!ensureLogin()) return;
      const title = taskTitleInput.value.trim();
      const description = taskDescriptionInput.value.trim();
      const date = taskDateInput.value;
      if (!title){ showFeedbackMessage('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

      const data = {
        id: currentTask && currentTask.id ? currentTask.id : Date.now(),
        title, description, date,
        complete: currentTask?.complete ?? false
      };

      const idx = customTasks.findIndex(t => t.id === data.id);
      if (idx > -1) customTasks[idx] = data; else customTasks.push(data);

      await cloudSaveAll();
      closeModal();
      renderCalendar();
    };

    async function deleteTask(){
      if (!ensureLogin() || !currentTask?.id) { closeModal(); return; }
      const { tasksCol } = await cloudRefs();
      await tasksCol.doc(String(currentTask.id)).delete();
      customTasks = customTasks.filter(t => t.id !== currentTask.id);
      await cloudSaveAll();
      closeModal();
      renderCalendar();
    }

    // ===== ì•„ì´ë””ì–´ ìƒì„± (Gemini API ìë¦¬) =====
    const generateIdea = async () => {
      const notesArea = document.getElementById('notesArea');
      const btn = document.getElementById('generateIdeaBtn');
      const original = btn.textContent;
      const notes = notesArea.value.trim();
      if (notes.length < 50){ showFeedbackMessage('ì•„ì´ë””ì–´ë¥¼ ìƒì„±í•˜ë ¤ë©´ ìµœì†Œ 50ì ì´ìƒì˜ ë©”ëª¨ê°€ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
      btn.textContent = 'ìƒì„± ì¤‘...'; btn.disabled = true;

      const apiKey = ""; // í•„ìš” ì‹œ ì…ë ¥
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
      const systemPrompt = "ë‹¹ì‹ ì€ ì„¸ê³„ì ì¸ ë§Œí™”ê°€ì´ì ìŠ¤í† ë¦¬í…”ëŸ¬ì…ë‹ˆë‹¤. ë‹¤ìŒ ë©”ëª¨ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì°½ì˜ì ì´ê³  í¥ë¯¸ë¡œìš´ ë§Œí™” ì•„ì´ë””ì–´, ìºë¦­í„° ì„¤ì •, í˜¹ì€ ì¤„ê±°ë¦¬ ì „ê°œì— ëŒ€í•œ ì œì•ˆì„ 200ì ë‚´ì™¸ë¡œ 3ê°€ì§€ ì´ìƒ ì œì‹œí•´ ì£¼ì„¸ìš”. ì œì•ˆì€ '- 'ë¡œ ì‹œì‘í•˜ëŠ” ëª©ë¡ í˜•íƒœë¡œ ì‘ì„±í•˜ê³ , ë‚´ìš©ì€ ìµœëŒ€í•œ ê°„ê²°í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.";

      const payload = { contents:[{ parts:[{ text: notes }]}], systemInstruction:{ parts:[{ text: systemPrompt }] } };

      try {
        const res = await fetch(apiUrl,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        const text = json?.candidates?.[0]?.content?.parts?.[0]?.text;
        if (text){
          notesArea.value += '\n\n--- ì•„ì´ë””ì–´ ì œì•ˆ ---\n' + text;
          await cloudSaveNotes(); // ìƒì„±ëœ ë‚´ìš© ì €ì¥
          showFeedbackMessage('ìƒˆë¡œìš´ ì•„ì´ë””ì–´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
        } else { throw new Error('No content'); }
      } catch (e){
        console.error(e);
        showFeedbackMessage('ì•„ì´ë””ì–´ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      } finally {
        btn.textContent = original; btn.disabled = false;
      }
    };

    // ì´ˆê¸°í™”
    const renderLayout = () => { attachEventListeners(); renderCalendar(); };
    renderLayout();

  </script>

  <!-- ===== Firebase SDKs & ì—°ë™ ì½”ë“œ ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ğŸ”§ ì´ ê°’ì€ í™˜ê²½ì—ì„œ ìë™ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤.
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    if (!firebaseConfig.projectId) {
        console.error("Firebase config is not available.");
    } else {
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ë¡œê·¸ì¸ ë°”
        const signInBtn = document.getElementById('signInBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const userInfoEl = document.getElementById('userInfo');

        // Firestore ê²½ë¡œ í—¬í¼
        window.cloudRefs = async function(){
          const uid = auth.currentUser.uid;
          return {
            tasksCol: collection(db, `artifacts/${appId}/users/${uid}/customTasks`),
            stateDoc: doc(db, `artifacts/${appId}/users/${uid}/meta/appState`),
          };
        }

        // ë¡œê·¸ì¸ í•„ìš” ì•ˆë‚´
        window.ensureLogin = function(){
          if (!auth.currentUser){
            showFeedbackMessage('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.');
            return false;
          }
          return true;
        }

        // í´ë¼ìš°ë“œ ë¡œë“œ/ì„¸ì´ë¸Œ í•¨ìˆ˜ ì¬ì •ì˜
        window.cloudLoadAll = async function(){
          if (!ensureLogin()) return;
          const { tasksCol, stateDoc } = await cloudRefs();

          // ê°œì¸ ì‘ì—…
          const tasksSnap = await getDocs(tasksCol);
          customTasks = tasksSnap.docs.map(d => ({ id: d.id, ...d.data() }));

          // ìƒíƒœ + ë©”ëª¨ íƒ­
          const st = await getDoc(stateDoc);
          if (st.exists()){
            const data = st.data() || {};
            taskStatus = data.taskStatus || {};
            const notesArea = document.getElementById('notesArea');
            const allNotes = data.notesTabs || {};
            if (notesArea) notesArea.value = allNotes[activeTab] || '';
          }
          renderCalendar();
        }

        window.cloudLoadNotes = async function(){
          if (!ensureLogin()) return;
          const { stateDoc } = await cloudRefs();
          const st = await getDoc(stateDoc);
          const data = st.exists() ? (st.data()||{}) : {};
          const notesTabs = data.notesTabs || {};
          const notesArea = document.getElementById('notesArea');
          if (notesArea) notesArea.value = notesTabs[activeTab] || '';
        }

        window.cloudSaveAll = async function(){
          if (!ensureLogin()) return;
          const { tasksCol, stateDoc } = await cloudRefs();
          // ìƒíƒœ ì €ì¥
          await setDoc(stateDoc, { taskStatus }, { merge: true });
          // ì‘ì—…ë“¤ ì €ì¥
          const ops = customTasks.map(t => setDoc(doc(tasksCol, String(t.id)), t, { merge:true }));
          await Promise.all(ops);
        }

        window.cloudSaveStateOnly = async function(){
          if (!ensureLogin()) return;
          const { stateDoc } = await cloudRefs();
          await setDoc(stateDoc, { taskStatus }, { merge: true });
        }

        window.cloudSaveNotes = async function(){
          if (!ensureLogin()) return;
          const { stateDoc } = await cloudRefs();
          const notesArea = document.getElementById('notesArea');
          // í˜„ì¬ íƒ­ë§Œ ë³‘í•© ì €ì¥
          const st = await getDoc(stateDoc);
          const prev = st.exists() ? (st.data()||{}) : {};
          const notesTabs = prev.notesTabs || {};
          notesTabs[activeTab] = notesArea.value;
          await setDoc(stateDoc, { notesTabs }, { merge:true });
        }

        window.deleteTask = async function(){
          if (!ensureLogin() || !currentTask?.id) { closeModal(); return; }
          const { tasksCol } = await cloudRefs();
          await deleteDoc(doc(tasksCol, String(currentTask.id)));
          customTasks = customTasks.filter(t => t.id !== currentTask.id);
          await cloudSaveAll();
          closeModal();
          renderCalendar();
        }

        // ì…ë ¥ì‹œ ê³¼ë„ ì €ì¥ ë°©ì§€(0.8ì´ˆ ë””ë°”ìš´ìŠ¤)
        let notesTimer = null;
        window.cloudSaveNotesDebounced = function(){
          clearTimeout(notesTimer);
          notesTimer = setTimeout(() => cloudSaveNotes().catch(console.error), 800);
        }

        onAuthStateChanged(auth, async (user) => {
          if (user) {
            userInfoEl.textContent = `${user.displayName || 'ìµëª…'} (${user.email || 'ìµëª…'})`;
            signInBtn.classList.add('hidden');
            signOutBtn.classList.remove('hidden');
            await cloudLoadAll();
          } else {
            userInfoEl.textContent = '';
            signOutBtn.classList.add('hidden');
            signInBtn.classList.remove('hidden');
            if (initialAuthToken) {
              await signInWithCustomToken(auth, initialAuthToken).catch(console.error);
            } else {
              await signInAnonymously(auth).catch(console.error);
            }
          }
        });
      }
    </script>
</body>
</html>
