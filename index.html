<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>만화 일정 관리</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
    body{
      font-family:'Noto Sans KR',sans-serif;background:#000;color:#fff;
      display:flex;flex-direction:column;align-items:center;min-height:100vh;gap:2rem;padding:20px;
    }
    .calendar-section,.notepad-section{
      width:100%;max-width:1200px;background:#2a2a2a;border-radius:12px;
      padding:24px;box-shadow:inset 0 0 10px rgba(0,0,0,.3);
    }
    .notepad-section{display:flex;flex-direction:column;padding-top:12px;padding-bottom:12px}
    .notepad-tabs{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .tab-container{display:flex;justify-content:space-around;gap:8px;flex-grow:1}
    .notepad-tab{background:#333;padding:8px 16px;border-radius:8px 8px 0 0;cursor:pointer;transition:.2s;font-weight:700}
    .notepad-tab.active{background:#1a1a1a}
    .notepad-tab:hover{background:#444}
    .notepad-section textarea{
      background:#1a1a1a;border:1px solid #333;color:#fff;padding:12px;border-radius:8px;min-height:900px;resize:vertical
    }

    .calendar-header{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:24px}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day-label,.calendar-day{
      text-align:center;padding:8px;border-radius:8px;background:#2a2a2a;position:relative;overflow:hidden
    }
    .day-label{background:#444;font-weight:700}
    .calendar-day{min-height:120px;padding-top:24px}
    .calendar-day.today{border:2px solid #ccc}
    .day-number{position:absolute;top:8px;left:8px;font-size:1.1rem;font-weight:700;color:#aaa}

    /* ✅ 모바일에서 세로깨짐 방지 */
    .task-item{
      font-size:.8rem;padding:4px 6px;border-radius:6px;margin-top:4px;
      white-space:nowrap;word-break:keep-all;overflow:hidden;text-overflow:ellipsis;
      display:inline-flex;align-items:center;justify-content:center;min-height:24px;cursor:pointer
    }
    .task-item.custom-task{background:#4c78a8}
    .task-item.episode-task{background:#444;color:#ddd}
    .task-item.recurring-shorts{background:#7d4040}
    .task-item.recurring-instatoon{background:#999966}
    .task-item.complete{background:#888;color:#ccc;text-decoration:line-through}

    .add-task-btn{background:#666;transition:.2s}
    .add-task-btn:hover{background:#777;transform:scale(1.02)}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:1000}
    .modal-content{background:#1a1a1a;border-radius:12px;padding:24px;width:90%;max-width:500px;box-shadow:0 10px 30px rgba(0,0,0,.5)}

    @media (max-width:480px){
      .calendar-header,.calendar-grid{gap:2px}
      .calendar-day{min-height:90px;padding-top:22px}
      .day-number{font-size:.95rem}
      .task-item{font-size:11px;padding:2px 4px;border-radius:6px}
      .task-item.episode-task{font-size:10px}
    }
  </style>
</head>
<body class="text-white">

  <!-- 상단 로그인 바 -->
  <div class="w-full max-w-5xl mx-auto flex items-center justify-end gap-2">
    <span id="userInfo" class="text-sm opacity-80"></span>
    <button id="signInBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Google 로그인</button>
    <button id="signOutBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded hidden">로그아웃</button>
  </div>

  <!-- 달력 -->
  <div class="calendar-section">
    <div class="flex justify-between items-center mb-4">
      <button id="prevMonthBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">&lt; 이전 달</button>
      <h2 id="currentMonthYear" class="text-2xl font-bold"></h2>
      <button id="nextMonthBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">다음 달 &gt;</button>
    </div>
    <div class="calendar-header mb-2">
      <div class="day-label">일</div><div class="day-label">월</div><div class="day-label">화</div>
      <div class="day-label">수</div><div class="day-label">목</div><div class="day-label">금</div><div class="day-label">토</div>
    </div>
    <div id="calendarGrid" class="calendar-grid"></div>
    <div class="mt-8 text-center">
      <button id="addTaskBtn" class="add-task-btn px-6 py-3 rounded-full font-bold text-white shadow-md">+ 개인 작업 추가</button>
    </div>
  </div>

  <!-- 메모 -->
  <div class="notepad-section mt-8">
    <div class="notepad-tabs">
      <div class="tab-container">
        <button class="notepad-tab active" data-tab="바퀴멘터리">바퀴멘터리</button>
        <button class="notepad-tab" data-tab="짐승육아">짐승육아</button>
        <button class="notepad-tab" data-tab="그거아세요">그거아세요</button>
        <button class="notepad-tab" data-tab="메모">메모</button>
      </div>
    </div>
    <textarea id="notesArea" class="flex-grow"></textarea>
  </div>

  <!-- 작업 모달 -->
  <div id="taskModal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle" class="text-2xl font-bold mb-4">새 작업</h2>
      <label class="block mb-2">제목:</label>
      <input id="taskTitle" type="text" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 mb-4">
      <label class="block mb-2">설명:</label>
      <textarea id="taskDescription" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 mb-4 h-24"></textarea>
      <label class="block mb-2">날짜:</label>
      <input id="taskDate" type="date" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 mb-4">
      <div class="flex justify-end gap-2">
        <button id="saveTaskBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">저장</button>
        <button id="cancelBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">취소</button>
        <button id="deleteTaskBtn" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg hidden">삭제</button>
      </div>
    </div>
  </div>

  <!-- ================== 앱 UI/로직 (비모듈) ================== -->
  <script>
    // ----- 전역 상태 -----
    let customTasks = [];            // [{id, title, description, date(YYYY-MM-DD), complete}]
    let taskStatus = {};             // {"YYYY-MM-DD_쇼츠": true/false, "YYYY-MM-DD_바퀴멘터리 2014화": ...}
    let currentDate = new Date();    // 달력 기준 날짜(월)
    let currentTask = null;          // 모달에서 편집중인 작업
    let activeTab = '바퀴멘터리';    // 메모 탭

    // ----- 고정 스케줄(요일: 0=일 ~ 6=토) -----
    const fixedSchedules = [
      { title: '쇼츠', daysOfWeek: [1,3,5], colorClass: 'recurring-shorts' },
      { title: '웹툰', daysOfWeek: [2,4,6], colorClass: 'recurring-instatoon' },
    ];

    // ----- 공통 DOM -----
    const taskModal = document.getElementById('taskModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveTaskBtn = document.getElementById('saveTaskBtn');
    const deleteTaskBtn = document.getElementById('deleteTaskBtn');
    const taskTitleInput = document.getElementById('taskTitle');
    const taskDescriptionInput = document.getElementById('taskDescription');
    const taskDateInput = document.getElementById('taskDate');

    // ----- 유틸: 토스트 -----
    const showFeedbackMessage = (message) => {
      const el = document.createElement('div');
      el.textContent = message;
      el.style.cssText = "position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.8);color:#fff;padding:16px 20px;border-radius:10px;z-index:2000;max-width:90%";
      document.body.appendChild(el);
      setTimeout(()=>el.remove(),2000);
    };

    // ----- 유틸: 특정 두 날짜 사이의 (일~목) 평일수 -----
    function countWeekdaysBetween(startMs, endMs){
      let count = 0;
      const start = new Date(Math.min(startMs, endMs));
      const end   = new Date(Math.max(startMs, endMs));
      const cur = new Date(start);
      while (cur <= end){
        const d = cur.getDay();
        if (d >= 0 && d <= 4) count++;
        cur.setDate(cur.getDate()+1);
      }
      return count;
    }

    // ----- 이벤트 연결 -----
    function attachEventListeners(){
      document.getElementById('prevMonthBtn').addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      document.getElementById('nextMonthBtn').addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });
      document.getElementById('addTaskBtn').addEventListener('click', ()=> openModal());

      // 메모 탭
      document.querySelectorAll('.notepad-tab').forEach(tab=>{
        tab.addEventListener('click', ()=>{
          document.querySelectorAll('.notepad-tab').forEach(t=>t.classList.remove('active'));
          tab.classList.add('active');
          activeTab = tab.dataset.tab;
          if (window.cloudLoadNotes) window.cloudLoadNotes();
        });
      });

      // 메모 입력 저장 디바운스
      const notesArea = document.getElementById('notesArea');
      let notesTimer=null;
      notesArea.addEventListener('input', ()=>{
        clearTimeout(notesTimer);
        notesTimer = setTimeout(()=> window.cloudSaveNotes && window.cloudSaveNotes(), 800);
      });

      // 모달 버튼
      cancelBtn.addEventListener('click', closeModal);
      saveTaskBtn.addEventListener('click', saveTask);
      deleteTaskBtn.addEventListener('click', ()=> window.deleteTask && window.deleteTask());
      taskModal.addEventListener('click', (e)=>{ if (e.target===taskModal) closeModal(); });
    }

    // ----- 달력 렌더링 -----
    function renderCalendar(){
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      document.getElementById('currentMonthYear').textContent = `${year}년 ${month+1}월`;

      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month+1, 0).getDate();

      // 앞쪽 공백
      for (let i=0;i<firstDay;i++){
        const empty = document.createElement('div');
        empty.className = 'calendar-day';
        grid.appendChild(empty);
      }

      // 실제 날짜
      for (let day=1; day<=daysInMonth; day++){
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day relative';

        const fullDate = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;

        // 오늘 표시
        const today = new Date();
        if (year===today.getFullYear() && month===today.getMonth() && day===today.getDate()){
          dayDiv.classList.add('today');
        }

        const num = document.createElement('span');
        num.className = 'day-number';
        num.textContent = day;
        dayDiv.appendChild(num);

        const dayOfWeek = new Date(year, month, day).getDay();

        // 평일 에피소드 번호
        if (dayOfWeek >= 0 && dayOfWeek <= 4){
          const milestoneDate = new Date('2025-09-01');
          const milestoneEpisode = 2014;
          const cur = new Date(year, month, day);
          const weekdaysBetween = countWeekdaysBetween(milestoneDate.getTime(), cur.getTime());
          const episodeNumber = (cur >= milestoneDate)
              ? milestoneEpisode + weekdaysBetween - 1
              : milestoneEpisode - (weekdaysBetween - 1);

          const ep = document.createElement('div');
          ep.className = 'task-item episode-task';
          ep.textContent = `${episodeNumber}화`;
          const key = `${fullDate}_바퀴멘터리 ${episodeNumber}화`;
          if (taskStatus[key]) ep.classList.add('complete');
          ep.addEventListener('click', async (e)=>{
            e.stopPropagation();
            if (!window.ensureLogin || !window.ensureLogin()) return;
            taskStatus[key] = !taskStatus[key];
            await window.cloudSaveStateOnly && window.cloudSaveStateOnly();
            renderCalendar();
          });
          dayDiv.appendChild(ep);
        }

        // 고정 스케줄
        fixedSchedules.forEach(s=>{
          if (s.daysOfWeek.includes(dayOfWeek)){
            const el = document.createElement('div');
            el.className = `task-item ${s.colorClass}`;
            el.textContent = s.title;
            const key = `${fullDate}_${s.title}`;
            if (taskStatus[key]) el.classList.add('complete');
            el.addEventListener('click', async (e)=>{
              e.stopPropagation();
              if (!window.ensureLogin || !window.ensureLogin()) return;
              taskStatus[key] = !taskStatus[key];
              await window.cloudSaveStateOnly && window.cloudSaveStateOnly();
              renderCalendar();
            });
            dayDiv.appendChild(el);
          }
        });

        // 사용자 작업
        customTasks.filter(t=>t.date===fullDate).forEach(task=>{
          const el = document.createElement('div');
          el.className = 'task-item custom-task';
          el.textContent = task.title;
          if (task.complete) el.classList.add('complete');
          el.addEventListener('click', async (e)=>{
            e.stopPropagation();
            if (e.detail===1){
              if (!window.ensureLogin || !window.ensureLogin()) return;
              task.complete = !task.complete;
              await window.cloudSaveAll && window.cloudSaveAll();
              renderCalendar();
            } else if (e.detail===2){
              openModal(task);
            }
          });
          dayDiv.appendChild(el);
        });

        dayDiv.addEventListener('click', (e)=>{
          if (e.target.classList.contains('calendar-day') || e.target.classList.contains('day-number')){
            openModal({ date: fullDate });
          }
        });

        grid.appendChild(dayDiv);
      }
    }

    // ----- 모달 열고/닫기 -----
    function openModal(task=null){
      currentTask = task;
      if (task && task.id){
        document.getElementById('modalTitle').textContent = '작업 수정';
        taskTitleInput.value = task.title;
        taskDescriptionInput.value = task.description || '';
        taskDateInput.value = task.date || '';
        deleteTaskBtn.classList.remove('hidden');
      } else if (task && task.date){
        document.getElementById('modalTitle').textContent = '새 작업';
        taskTitleInput.value = '';
        taskDescriptionInput.value = '';
        taskDateInput.value = task.date;
        deleteTaskBtn.classList.add('hidden');
      } else {
        document.getElementById('modalTitle').textContent = '새 작업';
        taskTitleInput.value = '';
        taskDescriptionInput.value = '';
        taskDateInput.value = '';
        deleteTaskBtn.classList.add('hidden');
      }
      taskModal.style.display = 'flex';
    }
    function closeModal(){ taskModal.style.display = 'none'; }

    // ----- 작업 저장 -----
    async function saveTask(){
      if (!window.ensureLogin || !window.ensureLogin()) return;
      const title = taskTitleInput.value.trim();
      const description = taskDescriptionInput.value.trim();
      const date = taskDateInput.value;
      if (!title){ showFeedbackMessage('제목을 입력해주세요.'); return; }

      const data = {
        id: currentTask && currentTask.id ? currentTask.id : Date.now(),
        title, description, date,
        complete: currentTask?.complete ?? false,
      };

      const idx = customTasks.findIndex(t=>t.id===data.id);
      if (idx>-1) customTasks[idx]=data; else customTasks.push(data);

      await window.cloudSaveAll && window.cloudSaveAll();
      closeModal();
      renderCalendar();
    }

    // ----- 초기 실행 -----
    (function init(){
      attachEventListeners();
      renderCalendar();
    })();
  </script>

  <!-- ================== Firebase 연동 (모듈) ================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // 🔧 여기 본인 Firebase 설정으로 교체하세요 (콘솔의 웹앱 구성 그대로 복사)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "comicschedule-dfec7.firebaseapp.com",
      projectId: "comicschedule-dfec7",
      storageBucket: "comicschedule-dfec7.appspot.com",
      messagingSenderId: "1084611276816",
      appId: "1:1084611276816:web:aca83237bafa971ed1fa95",
      measurementId: "G-ZNZZQRJZF9"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const signInBtn  = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const userInfoEl = document.getElementById('userInfo');

    const provider = new GoogleAuthProvider();
    async function doSignIn(){
      try{ await signInWithPopup(auth, provider); }
      catch(e){
        if (e.code==='auth/popup-blocked' || e.code==='auth/unauthorized-domain'){
          await signInWithRedirect(auth, provider);
        } else { alert('로그인 오류: '+(e.message||e.code)); }
      }
    }
    getRedirectResult(auth).catch(()=>{});

    signInBtn.onclick  = () => doSignIn();
    signOutBtn.onclick = () => signOut(auth);

    // ---- Firestore 경로/도움 함수 (전역에 노출) ----
    window.cloudRefs = async () => {
      const uid = auth.currentUser.uid;
      return {
        tasksCol: collection(db, `users/${uid}/customTasks`),
        stateDoc: doc(db, `users/${uid}/meta/appState`)
      };
    };

    window.ensureLogin = () => {
      if (!auth.currentUser){ alert('로그인 후 이용해주세요.'); return false; }
      return true;
    };

    window.cloudLoadAll = async () => {
      if (!ensureLogin()) return;
      const { tasksCol, stateDoc } = await cloudRefs();

      const tasksSnap = await getDocs(tasksCol);
      window.customTasks = tasksSnap.docs.map(d => ({ id:d.id, ...d.data() }));

      const st = await getDoc(stateDoc);
      if (st.exists()){
        const data = st.data() || {};
        window.taskStatus = data.taskStatus || {};
        const el = document.getElementById('notesArea');
        const allNotes = data.notesTabs || {};
        if (el) el.value = allNotes[window.activeTab] || '';
      }
      if (typeof renderCalendar==='function') renderCalendar();
    };

    window.cloudLoadNotes = async () => {
      if (!ensureLogin()) return;
      const { stateDoc } = await cloudRefs();
      const st = await getDoc(stateDoc);
      const data = st.exists() ? (st.data()||{}) : {};
      const notesTabs = data.notesTabs || {};
      const el = document.getElementById('notesArea');
      if (el) el.value = notesTabs[window.activeTab] || '';
    };

    window.cloudSaveAll = async () => {
      if (!ensureLogin()) return;
      const { tasksCol, stateDoc } = await cloudRefs();
      // 상태 저장
      await setDoc(stateDoc, { taskStatus: window.taskStatus }, { merge:true });
      // 모든 사용자 작업 저장
      const ops = (window.customTasks||[]).map(t=> setDoc(doc(tasksCol, String(t.id)), t, { merge:true }));
      await Promise.all(ops);
    };

    window.cloudSaveStateOnly = async () => {
      if (!ensureLogin()) return;
      const { stateDoc } = await cloudRefs();
      await setDoc(stateDoc, { taskStatus: window.taskStatus }, { merge:true });
    };

    window.cloudSaveNotes = async () => {
      if (!ensureLogin()) return;
      const { stateDoc } = await cloudRefs();
      const el = document.getElementById('notesArea');
      const st = await getDoc(stateDoc);
      const prev = st.exists() ? (st.data()||{}) : {};
      const notesTabs = prev.notesTabs || {};
      notesTabs[window.activeTab] = el.value;
      await setDoc(stateDoc, { notesTabs }, { merge:true });
    };

    window.deleteTask = async () => {
      if (!ensureLogin() || !window.currentTask?.id) { if (typeof closeModal==='function') closeModal(); return; }
      const { tasksCol } = await cloudRefs();
      await deleteDoc(doc(tasksCol, String(window.currentTask.id)));
      window.customTasks = (window.customTasks||[]).filter(t=>t.id!==window.currentTask.id);
      await window.cloudSaveAll();
      if (typeof closeModal==='function') closeModal();
      if (typeof renderCalendar==='function') renderCalendar();
    };

    // ---- 로그인 상태 변화 ----
    onAuthStateChanged(auth, async (user)=>{
      if (user){
        userInfoEl.textContent = user.email || '로그인됨';
        signInBtn.classList.add('hidden');
        signOutBtn.classList.remove('hidden');
        await window.cloudLoadAll();
      } else {
        userInfoEl.textContent='';
        signOutBtn.classList.add('hidden');
        signInBtn.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
