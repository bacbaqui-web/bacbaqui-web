<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë§Œí™” ì¼ì • ê´€ë¦¬</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    /* CSS: ì›ë³¸ index.htmlì˜ ëª¨ë“  ìŠ¤íƒ€ì¼ ìœ ì§€ ë° ë³´ì • */
    body{font-family:'Noto Sans KR',sans-serif;background:#000;color:#fff;display:flex;justify-content:flex-start;align-items:center;min-height:100vh;padding:16px;flex-direction:column;gap:0}
    .tab-content{display:none}.tab-content.active{display:flex;flex-direction:column;flex-grow:1}
    .section-card{background:#2a2a2a;border-radius:12px;padding:20px;box-shadow:inset 0 0 10px rgba(0,0,0,.3);text-align:center;width:100%;max-width:800px}
    .notepad-tabs{display:flex;justify-content:center;align-items:center;gap:1rem;width:100%;max-width:800px}
    .notepad-tab{background:#1a1a1a;padding:8px 16px;border-radius:8px 8px 0 0;cursor:pointer;transition:.2s;font-weight:700;color:#737373;font-size:.85rem}
    .notepad-tab.active,.notepad-tab:hover{background:#2a2a2a;color:#fff}
    
    /* ë©”ëª¨ íƒ­ ìŠ¤íƒ€ì¼ */
    #notesHeaderRow{margin-top:8px;margin-bottom:8px}
    #notesTabsContainer{justify-content:flex-start;align-items:center;gap:8px;padding-left:10px;margin-top:0;}
    .notes-tab{background:#3a3a3a;padding:8px 16px;border-radius:12px;cursor:pointer;transition:background .2s,color .2s,transform .15s ease;font-weight:700;color:#ddd;font-size:.85rem;position:relative;z-index:1;border:1px solid transparent;user-select:none;}
    .notes-tab:hover{background:#4a4a4a}
    .notes-tab.active{background:#111;color:#fff;border-color:#2a2a2a;z-index:2;}
    .notes-tab.dragging{opacity:.3}
    .notes-tab.placeholder{opacity:1; background:transparent; border:1px dashed rgba(255,255,255,.25); border-radius:10px 10px 0 0; height:32px;}
    #notesArea{margin-top:10px}
    .notes-tab .tab-del{margin-left:8px;display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:999px;background:#555;color:#fff;font-size:12px;line-height:1}

    .icon-btn{background:transparent;border:none;padding:6px;display:inline-flex;align-items:center;justify-content:center;border-radius:10px;cursor:pointer}
    .icon-btn:hover{background:rgba(255,255,255,.08)}
    .icon-btn svg{width:18px;height:18px;display:block}
    .notes-area{flex-grow:1;resize:vertical}
    textarea#notesArea::-webkit-scrollbar{width:8px;background-color:#2a2a2a;border-radius:10px}
    textarea#notesArea::-webkit-scrollbar-thumb{background-color:#555;border-radius:10px}

    /* ë‹¬ë ¥ ìŠ¤íƒ€ì¼ */
    .calendar-header{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:4px}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
    .day-label,.calendar-day{text-align:center;padding:8px 2px;border-radius:8px;background:#2a2a2a;position:relative;overflow:hidden;word-wrap:break-word}
    .day-label{background:#444;font-weight:700;color:#fff;font-size:.8rem;padding:8px 0}
    .calendar-day{min-height:160px;padding-top:16px;padding-left:2px;padding-right:2px;display:flex;flex-direction:column;gap:2px}
    .calendar-day.today{border:2px solid #ccc}
    .day-number{position:absolute;top:8px;left:8px;font-size:.85rem;font-weight:700;color:#aaa;z-index:10}
    .day-divider{height:1px;background:#3a3a3a;margin:18px 6px 2px;border-radius:999px;opacity:.95}
    
    .task-item{font-size:.85rem;padding:5px 6px;border-radius:8px;margin-top:4px;word-wrap:break-word;cursor:pointer;text-align:left}
    .task-item.custom-task{background:#4c78a8}
    .task-item.custom-task.custom-important{background:#dc2626;color:#fff}
    .task-item.custom-task.custom-family{background:#2563eb;color:#fff}
    .task-item.custom-task.custom-special{background:#16a34a;color:#fff}
    .task-item.episode-task{background:#444;color:#ddd}
    .task-item.complete{background:#888;text-decoration:line-through;color:#ccc}
    .task-item.custom-task.complete{background:#666 !important;color:#bdbdbd !important;text-decoration:line-through;opacity:.95}

    .daily-check-group {display: flex;width: 100%;gap: 2px;margin-top: 2px;}
    .daily-check-btn {flex: 1;text-align: center;font-size: 0.75rem;padding: 4px 0;border-radius: 4px;background: #444;color: #ccc;cursor: pointer;transition: background 0.2s, color 0.2s;font-weight: 500;}
    .daily-check-btn.shorts.active {background: #7c3aed; color: white;font-weight: 700;}
    .daily-check-btn.webtoon.active {background: #f59e0b; color: white;font-weight: 700;}

    .agenda-item{display:flex;align-items:center;gap:10px;background:#2a2a2a;border-radius:10px;padding:10px 10px}
    .agenda-dot{width:10px;height:10px;border-radius:999px;flex:0 0 10px}
    .agenda-date{font-size:.8rem;color:#bbb;min-width:92px}
    .agenda-text{flex:1 1 auto;word-break:break-word}
    .agenda-actions{display:flex;gap:6px;flex:0 0 auto}
    .agenda-settings-btn{display:inline-flex;align-items:center;justify-content:center;width:34px;height:30px;background:#3a3a3a;border-radius:10px;color:#fff;border:none;cursor:pointer;user-select:none}
    .agenda-item.complete{opacity:.9;background:#242424}
    .agenda-item.complete .agenda-text{color:#7a7a7a !important;text-decoration:line-through}

    /* ë¶ë§ˆí¬Masonry ë ˆì´ì•„ì›ƒ */
    #image-grid {column-count: 2; column-gap: 1rem; margin-top: 1.5rem; display: block;}
    @media (min-width: 640px) { #image-grid { column-count: 3; } }
    @media (min-width: 1024px) { #image-grid { column-count: 4; } }
    .bookmark-card{position: relative; transition: transform .2s ease-in-out; background: #333; border-radius: 8px; overflow: hidden; margin-bottom: 1rem; break-inside: avoid; width: 100%; display: block;}
    .bookmark-card:hover{transform:translateY(-5px)}
    .bookmark-card .content {display: block; width: 100%; height: auto; overflow: hidden; background-color: #1a1a1a; min-height: 80px; position: relative;}
    .bookmark-card img {width: 100%; height: auto; display: block; object-fit: contain;}
    .bookmark-card .img-fit-cover {object-fit: cover; height: 100%;}
    .bookmark-card .icon-overlay {position: absolute; inset: 0; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; color: white; font-size: 3rem;}
    .bookmark-card .video-title-overlay {position: absolute; inset: 0; background: rgba(80, 0, 0, 0.7); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; padding: 10px; text-align: center;}
    .bookmark-card .video-title-text {font-size: 1rem; font-weight: 700; margin-bottom: 5px; word-break: break-all;}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:1000}
    .modal-content{background:#1a1a1a;border-radius:12px;padding:24px;width:90%;max-width:500px;box-shadow:0 10px 30px rgba(0,0,0,.5);position:relative}
    #imageModal.modal .modal-content {background-color: transparent; padding: 0; box-shadow: none; max-width: 90vw; max-height: 90vh; width: auto; height: auto; display: flex; justify-content: center; align-items: center; cursor: pointer;}
    #modalImage {max-width: 100%; max-height: 100%; object-fit: contain;}
    .drag-area{border:2px dashed #4b4b4b;transition:all .3s ease;padding:24px}
    .drag-area.active{border-color:#6b6b6b;background-color:#2a2a2a}
  </style>
</head>
<body class="text-white">
  <div id="authBar" class="w-full max-w-2xl mx-auto flex items-center justify-end gap-2 mb-4">
    <span id="userInfo" class="text-sm opacity-80"></span>
    <button id="signInBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Google ë¡œê·¸ì¸</button>
    <button id="signOutBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded hidden">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <div id="main-tabs" class="notepad-tabs mx-auto">
    <button class="notepad-tab active" data-tab="calendar">ë‹¬ë ¥</button>
    <button class="notepad-tab" data-tab="notes">ë©”ëª¨</button>
    <button class="notepad-tab" data-tab="bookmarks">ë¶ë§ˆí¬</button>
  </div>

  <!-- ë‹¬ë ¥ ì„¹ì…˜ -->
  <div id="calendar-section" class="section-card tab-content active">
    <div class="flex justify-between items-center mb-4">
      <button id="prevMonthBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">&lt; ì´ì „ ë‹¬</button>
      <h2 id="currentMonthYear" class="text-lg font-bold"></h2>
      <button id="nextMonthBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">ë‹¤ìŒ ë‹¬ &gt;</button>
    </div>
    <div class="calendar-header mb-2">
      <div class="day-label">ì›”</div><div class="day-label">í™”</div><div class="day-label">ìˆ˜</div><div class="day-label">ëª©</div><div class="day-label">ê¸ˆ</div><div class="day-label">í† </div><div class="day-label">ì¼</div>
    </div>
    <div id="calendarGrid" class="calendar-grid"></div>
    <div id="agendaPanel" class="mt-6 text-left" style="background:#1f1f1f;border-radius:12px;padding:14px;box-shadow:inset 0 0 10px rgba(0,0,0,.25)">
      <div id="agendaList" class="space-y-2"></div>
    </div>
  </div>

  <!-- ë©”ëª¨ ì„¹ì…˜ -->
  <div id="notes-section" class="section-card tab-content">
    <div class="flex items-center justify-between mb-2" id="notesHeaderRow">
      <div id="notesTabsContainer" class="notepad-tabs flex flex-wrap gap-2"></div>
      <div class="flex items-center gap-2">
        <button id="addNotesTabBtn" class="icon-btn" title="ìƒˆ íƒ­">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
        </button>
        <button id="toggleNotesEditBtn" class="icon-btn" title="íƒ­ í¸ì§‘">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
        </button>
      </div>
    </div>
    <textarea id="notesArea" class="w-full notes-area p-4 bg-black text-white border border-gray-700 focus:outline-none rounded-lg"></textarea>
  </div>

  <!-- ë¶ë§ˆí¬ ì„¹ì…˜ -->
  <div id="bookmarks-section" class="section-card tab-content text-left">
    <section id="drag-area" class="drag-area rounded-lg p-6 flex items-center justify-center text-center text-[#999] font-medium cursor-pointer" title="ë¶™ì—¬ë„£ê¸°(Ctrl+V)">
      <div class="text-4xl font-bold select-none">+</div>
    </section>
    <section id="image-grid"></section>
  </div>

  <!-- ëª¨ë‹¬ë“¤ -->
  <div id="taskModal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle" class="text-2xl font-bold mb-4">ì‘ì—…</h2>
      <input type="text" id="taskTitle" placeholder="ì œëª©" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 mb-4 text-white">
      <textarea id="taskDescription" placeholder="ì„¤ëª…" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 mb-4 h-24 text-white"></textarea>
      <input type="date" id="taskDate" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 mb-4 text-white">
      <select id="taskCategory" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 mb-4 text-white">
        <option value="">(ê¸°ë³¸)</option>
        <option value="important">ì¤‘ìš”í•œì¼ (ë¹¨ê°•)</option>
        <option value="family">ê°€ì¡±í–‰ì‚¬ (íŒŒë‘)</option>
        <option value="special">íŠ¹ë³„í•œë‚  (ì´ˆë¡)</option>
      </select>
      <label class="flex items-center gap-2 mb-4 text-sm opacity-90"><input type="checkbox" id="todoOnly" /> ë‹¬ë ¥ í‘œì‹œ ì•ˆ í•¨</label>
      <div class="flex justify-end gap-2">
        <button id="saveTaskBtn" class="bg-blue-600 px-4 py-2 rounded">ì €ì¥</button>
        <button id="cancelBtn" class="bg-gray-500 px-4 py-2 rounded">ì·¨ì†Œ</button>
        <button id="deleteTaskBtn" class="bg-red-600 px-4 py-2 rounded hidden">ì‚­ì œ</button>
      </div>
    </div>
  </div>

  <div id="imageModal" class="modal">
    <div class="modal-content relative">
      <button id="closeImageModalBtn" class="absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full p-1 z-50">&times;</button>
      <img id="modalImage" src="" />
      <button id="goToPageBtn" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded-lg z-50">ì›ë³¸ ì´ë™</button>
    </div>
  </div>

  <div id="editTitleModal" class="modal">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4">ë¶ë§ˆí¬ ì œëª© ìˆ˜ì •</h2>
      <label class="block mb-2 text-sm opacity-80" id="currentUrlDisplay"></label>
      <input type="text" id="editTitleInput" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 mb-4 text-white">
      <div class="flex justify-end gap-2">
        <button id="saveTitleBtn" class="bg-blue-600 px-4 py-2 rounded">ì €ì¥</button>
        <button id="cancelTitleBtn" class="bg-gray-500 px-4 py-2 rounded">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <div id="previewUploadModal" class="modal">
    <div class="modal-content" style="background:#2a2a2a;max-width:420px;">
      <h2 class="text-xl font-bold mb-3">ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€</h2>
      <div id="previewPasteArea" class="drag-area rounded-lg p-10 flex items-center justify-center text-center cursor-default" style="border-style:dashed;">
        <div class="text-5xl font-bold select-none">+</div>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="closePreviewUploadBtn" class="bg-gray-500 px-4 py-2 rounded">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-[#242424] rounded-lg p-6 shadow-xl max-w-sm mx-auto">
      <p id="modal-message" class="text-white text-center"></p>
      <div class="mt-4 flex justify-center"><button id="modal-close-btn" class="px-4 py-2 bg-gray-600 rounded">í™•ì¸</button></div>
    </div>
  </div>

  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-70 z-[1001] flex items-center justify-center hidden">
    <div class="text-white">ë¡œë”© ì¤‘...</div>
  </div>

  <!-- UI & Common Logic (ui.js ê¸°ë°˜) -->
  <script>
    // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
    window.customTasks = []; window.taskStatus = {}; window.__notesTabs = {}; window.imageBookmarks = [];
    window.currentTask = null; let currentDate = new Date(); window.isAuthReady = false;

    // ìœ í‹¸ë¦¬í‹°
    const showFeedbackMessage = (msg) => {
      const el = document.createElement('div'); el.textContent = msg;
      el.style.cssText="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.8);color:#fff;padding:16px 20px;border-radius:10px;z-index:2000;";
      document.body.appendChild(el); setTimeout(()=>el.remove(), 2000);
    };
    const showAlert = (msg) => { document.getElementById('modal-message').textContent = msg; document.getElementById('alert-modal').classList.remove('hidden'); };
    document.getElementById('modal-close-btn').addEventListener('click', () => document.getElementById('alert-modal').classList.add('hidden'));

    // ë‚ ì§œ í—¬í¼ (KST ê¸°ì¤€)
    const TZ='Asia/Seoul';
    function ymdKST(date){ return new Intl.DateTimeFormat('en-CA',{timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit'}).format(date); }
    function toKST(date){ return new Date(date.toLocaleString('en-US',{timeZone:TZ})); }
    function isEpisodeDay(d){ return d.getDay() >= 1 && d.getDay() <= 5; }
    
    function countEpisodeDaysExclusiveStartInclusiveEnd(startDateObj, endDateObj){
      let count = 0; const cur = new Date(startDateObj.getFullYear(), startDateObj.getMonth(), startDateObj.getDate());
      const end = new Date(endDateObj.getFullYear(), endDateObj.getMonth(), endDateObj.getDate());
      cur.setDate(cur.getDate() + 1);
      while(cur <= end){ if(isEpisodeDay(cur)) count++; cur.setDate(cur.getDate() + 1); }
      return count;
    }
    function episodeNumberForDate(targetDateObj){
      const baseDate = new Date(2026, 1, 2); const baseEpisode = 2123;
      const t = new Date(targetDateObj.getFullYear(), targetDateObj.getMonth(), targetDateObj.getDate());
      if(t.getTime() === baseDate.getTime()) return baseEpisode;
      if(t > baseDate){ return baseEpisode + countEpisodeDaysExclusiveStartInclusiveEnd(baseDate, t); }
      else { return baseEpisode - countEpisodeDaysExclusiveStartInclusiveEnd(t, baseDate); }
    }

    // ë‹¬ë ¥ ë Œë”ë§
    window.renderCalendar = function() {
      const year=currentDate.getFullYear(), month=currentDate.getMonth();
      document.getElementById('currentMonthYear').textContent=`${year}ë…„ ${month+1}ì›”`;
      const grid = document.getElementById('calendarGrid'); grid.innerHTML='';
      const firstDay=new Date(year,month,1).getDay(); const daysInMonth=new Date(year,month+1,0).getDate();
      const leadingBlanks=(firstDay+6)%7;
      for(let i=0;i<leadingBlanks;i++) grid.appendChild(document.createElement('div')).className='calendar-day';
      for(let day=1;day<=daysInMonth;day++){
        const thisDate=new Date(year,month,day); const fullDate=ymdKST(thisDate);
        const dayDiv=document.createElement('div'); dayDiv.className='calendar-day relative';
        if(fullDate===ymdKST(new Date())) dayDiv.classList.add('today');
        dayDiv.innerHTML = `<span class="day-number">${day}</span><div class="day-divider"></div>`;
        
        const checkGroup = document.createElement('div'); checkGroup.className='daily-check-group';
        ['shorts','webtoon'].forEach(type=>{
          const btn=document.createElement('div'); btn.className=`daily-check-btn ${type}`; btn.textContent=type==='shorts'?'ì‡¼ì¸ ':'ì›¹íˆ°';
          if(window.taskStatus[`${fullDate}_daily_${type}`]) btn.classList.add('active');
          btn.onclick=(e)=>{
            e.stopPropagation(); if(!window.ensureLogin()) return;
            window.taskStatus[`${fullDate}_daily_${type}`] = !window.taskStatus[`${fullDate}_daily_${type}`];
            window.cloudSaveStateOnly && window.cloudSaveStateOnly(); window.renderCalendar();
          };
          checkGroup.appendChild(btn);
        });
        dayDiv.appendChild(checkGroup);

        if(isEpisodeDay(thisDate)){
          const epNum = episodeNumberForDate(thisDate);
          const epEl=document.createElement('div'); epEl.className='task-item episode-task'; epEl.textContent=`${epNum}í™”`;
          if(window.taskStatus[`${fullDate}_ë°”í€´ë©˜í„°ë¦¬ ${epNum}í™”`]) epEl.classList.add('complete');
          epEl.onclick=(e)=>{
            e.stopPropagation(); if(!window.ensureLogin()) return;
            window.taskStatus[`${fullDate}_ë°”í€´ë©˜í„°ë¦¬ ${epNum}í™”`] = !window.taskStatus[`${fullDate}_ë°”í€´ë©˜í„°ë¦¬ ${epNum}í™”`];
            window.cloudSaveStateOnly && window.cloudSaveStateOnly(); window.renderCalendar();
          };
          dayDiv.appendChild(epEl);
        }

        (window.customTasks||[]).filter(t=>t.date===fullDate).forEach(task=>{
          const el=document.createElement('div'); el.className=`task-item custom-task custom-${task.category}`;
          el.textContent=task.title; if(task.complete) el.classList.add('complete');
          el.onclick=(e)=>{ e.stopPropagation(); if(!window.ensureLogin()) return; task.complete=!task.complete; window.cloudSaveAll && window.cloudSaveAll(); window.renderCalendar(); };
          el.ondblclick=(e)=>{ e.stopPropagation(); openTaskModal(task); };
          dayDiv.appendChild(el);
        });
        dayDiv.onclick=()=>openTaskModal({date:fullDate});
        grid.appendChild(dayDiv);
      }
      renderAgendaList();
    };

    function renderAgendaList(){
      const list = document.getElementById('agendaList'); if(!list) return; list.innerHTML='';
      const sorted = (window.customTasks||[]).sort((a,b) => {
        if(a.complete !== b.complete) return a.complete ? 1 : -1;
        return (a.date||'').localeCompare(b.date||'');
      });
      sorted.forEach(t=>{
        const item=document.createElement('div'); item.className=`agenda-item ${t.complete?'complete':''}`;
        const dotCol = t.category==='important'?'#dc2626':(t.category==='family'?'#2563eb':(t.category==='special'?'#16a34a':'#9ca3af'));
        item.innerHTML=`<div class="agenda-dot" style="background:${dotCol}"></div><div class="agenda-date">${t.date||''}</div><div class="agenda-text">${t.title}</div><div class="agenda-actions"><button class="agenda-settings-btn">âš™ï¸</button></div>`;
        item.onclick=()=>{ if(!window.ensureLogin()) return; t.complete=!t.complete; window.cloudSaveAll(); window.renderCalendar(); };
        item.querySelector('.agenda-settings-btn').onclick=(e)=>{ e.stopPropagation(); openTaskModal(t); };
        list.appendChild(item);
      });
    }

    function openTaskModal(task){
      window.currentTask = task;
      document.getElementById('taskTitle').value = task.title || '';
      document.getElementById('taskDescription').value = task.description || '';
      document.getElementById('taskDate').value = task.date || '';
      document.getElementById('taskCategory').value = task.category || '';
      document.getElementById('todoOnly').checked = !!task.todoOnly;
      document.getElementById('deleteTaskBtn').classList.toggle('hidden', !task.id);
      document.getElementById('taskModal').style.display='flex';
    }

    // ë¶ë§ˆí¬ UI ë Œë”ë§
    function getYoutubeThumbnail(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? `https://img.youtube.com/vi/${match[2]}/hqdefault.jpg` : null;
    }

    window.renderImageBookmarks = function() {
      const grid = document.getElementById('image-grid'); if(!grid) return; grid.innerHTML = '';
      (window.imageBookmarks || []).sort((a,b)=>(b.timestamp?.toMillis()||0)-(a.timestamp?.toMillis()||0)).forEach(d => {
        const card = document.createElement('div'); card.className = 'bookmark-card group cursor-pointer';
        let iconHtml = '';
        if (d.type === 'link') {
            iconHtml = d.previewImageUrl ? `<img src="${d.previewImageUrl}" class="img-fit-cover"/>` : `<div class="icon-overlay">ğŸ”—</div>`;
        } else if (d.type === 'video') {
            const thumb = getYoutubeThumbnail(d.pageUrl);
            iconHtml = thumb ? `<img src="${thumb}" class="img-fit-cover"/><div class="icon-overlay">â–¶</div>` : `<div class="video-title-overlay"><span class="video-title-text">${d.title||'Video'}</span></div>`;
        } else if (d.type === 'instagram') {
            iconHtml = `<div class="video-title-overlay" style="background:rgba(80,0,80,0.7)"><span class="video-title-text">Instagram</span></div>`;
        } else {
            iconHtml = `<img src="${d.url}" />`;
        }
        card.innerHTML = `<div class="content">${iconHtml}</div><div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-[10px] px-2 py-1 truncate z-10 opacity-70">${d.sourceDomain || 'Source'}</div><button class="absolute top-1 right-1 bg-red-600 rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity z-20">Ã—</button>`;
        card.onclick = () => { if(d.type==='firebase_storage'||d.type==='remote') { document.getElementById('modalImage').src=d.url; document.getElementById('imageModal').style.display='flex'; } else { window.open(d.pageUrl, '_blank'); } };
        card.querySelector('button').onclick = (e) => { e.stopPropagation(); if(window.deleteImage) window.deleteImage(d.id); };
        grid.appendChild(card);
      });
    };
  </script>

  <!-- Module Script (Firebase & Notes & Bookmarks Logic) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, onSnapshot, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCiwzde40jsz17CEz-rrMmmBrn-S6brdlE",
      authDomain: "comicschedule-dfec7.firebaseapp.com",
      projectId: "comicschedule-dfec7",
      storageBucket: "comicschedule-dfec7.firebasestorage.app",
      messagingSenderId: "1004611276816",
      appId: "1:1004611276816:web:aca83237bafa971ed1fa95"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();

    // 1. ì¸ì¦ ë° ìƒíƒœ ê°ì§€
    onAuthStateChanged(auth, async (user) => {
      const loading = document.getElementById('loading-overlay'); loading.classList.remove('hidden');
      if (user) {
        document.getElementById('userInfo').textContent = `${user.displayName || 'User'}`;
        document.getElementById('signInBtn').classList.add('hidden'); document.getElementById('signOutBtn').classList.remove('hidden');
        
        // ì‹¤ì‹œê°„ ë™ê¸°í™”
        const userPath = `users/${user.uid}`;
        onSnapshot(doc(db, `${userPath}/meta/appState`), (ds) => {
          const data = ds.data() || {};
          window.taskStatus = data.taskStatus || {};
          window.__notesTabs = data.notesTabs || {};
          window.__notesTabList = data.notesTabList || [{id:'memo', name:'ë©”ëª¨', order:0}];
          window.__notesActiveTabId = data.notesActiveTabId || 'memo';
          window.renderCalendar(); window.renderNotesUI();
        });
        onSnapshot(collection(db, `${userPath}/customTasks`), (snap) => {
          window.customTasks = snap.docs.map(d => ({id:d.id, ...d.data()}));
          window.renderCalendar();
        });
        onSnapshot(collection(db, `${userPath}/images`), (snap) => {
          window.imageBookmarks = snap.docs.map(d => ({id:d.id, ...d.data()}));
          window.renderImageBookmarks();
        });
      } else {
        document.getElementById('signInBtn').classList.remove('hidden'); document.getElementById('signOutBtn').classList.add('hidden');
        window.customTasks = []; window.taskStatus = {}; window.imageBookmarks = [];
        window.renderCalendar(); window.renderImageBookmarks();
      }
      loading.classList.add('hidden'); window.isAuthReady = true;
    });

    // 2. ì „ì—­ ë…¸ì¶œ í•¨ìˆ˜ (Firebase ì—°ë™)
    window.ensureLogin = () => { if(!auth.currentUser) { showAlert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return false; } return true; };
    window.cloudSaveStateOnly = async () => { if(!window.ensureLogin()) return; await setDoc(doc(db, `users/${auth.currentUser.uid}/meta/appState`), {taskStatus: window.taskStatus}, {merge:true}); };
    window.cloudSaveAll = async () => { if(!window.ensureLogin()) return; await setDoc(doc(db, `users/${auth.currentUser.uid}/meta/appState`), {taskStatus: window.taskStatus}, {merge:true}); };
    
    // 3. ë©”ëª¨ ë¡œì§ (notes.js í†µí•©)
    let editMode = false;
    window.renderNotesUI = function() {
      const container = document.getElementById('notesTabsContainer'); if(!container) return;
      const sorted = [...(window.__notesTabList || [])].sort((a,b)=>(a.order||0)-(b.order||0));
      container.innerHTML = '';
      sorted.forEach(t => {
        const btn = document.createElement('button');
        btn.className = `notes-tab ${t.id === window.__notesActiveTabId ? 'active' : ''}`;
        btn.draggable = editMode;
        btn.innerHTML = `<span class="tab-label">${t.name}</span>${editMode ? `<span class="tab-del">Ã—</span>` : ''}`;
        btn.onclick = async () => {
            if(editMode) {
                if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    const nextList = window.__notesTabList.filter(item=>item.id!==t.id);
                    await setDoc(doc(db, `users/${auth.currentUser.uid}/meta/appState`), {notesTabList: nextList}, {merge:true});
                }
            } else {
                window.__notesActiveTabId = t.id;
                document.getElementById('notesArea').value = window.__notesTabs[t.id] || '';
                window.renderNotesUI();
                await setDoc(doc(db, `users/${auth.currentUser.uid}/meta/appState`), {notesActiveTabId: t.id}, {merge:true});
            }
        };
        btn.ondblclick = async () => {
            const newName = prompt('ìƒˆ íƒ­ ì´ë¦„', t.name);
            if(newName) {
                const nextList = window.__notesTabList.map(item => item.id === t.id ? {...item, name: newName} : item);
                await setDoc(doc(db, `users/${auth.currentUser.uid}/meta/appState`), {notesTabList: nextList}, {merge:true});
            }
        };
        container.appendChild(btn);
      });
      document.getElementById('notesArea').value = window.__notesTabs[window.__notesActiveTabId] || '';
    };

    document.getElementById('addNotesTabBtn').onclick = async () => {
        if(!window.ensureLogin()) return;
        const name = prompt('ìƒˆ íƒ­ ì´ë¦„', 'ìƒˆ ë©”ëª¨');
        if(!name) return;
        const id = 'tab_' + Date.now();
        const nextList = [...(window.__notesTabList || []), {id, name, order: (window.__notesTabList||[]).length * 10}];
        await setDoc(doc(db, `users/${auth.currentUser.uid}/meta/appState`), {notesTabList: nextList, notesActiveTabId: id}, {merge:true});
    };
    document.getElementById('toggleNotesEditBtn').onclick = () => { editMode = !editMode; window.renderNotesUI(); };
    
    let saveTimer = null;
    document.getElementById('notesArea').oninput = () => {
        clearTimeout(saveTimer);
        saveTimer = setTimeout(async () => {
            if(!window.ensureLogin()) return;
            const updatedNotes = {...window.__notesTabs, [window.__notesActiveTabId]: document.getElementById('notesArea').value};
            await setDoc(doc(db, `users/${auth.currentUser.uid}/meta/appState`), {notesTabs: updatedNotes}, {merge:true});
        }, 800);
    };

    // 4. ë¶ë§ˆí¬ ì €ì¥ ë¡œì§
    window.deleteImage = async (id) => {
        if(!window.ensureLogin()) return;
        const item = window.imageBookmarks.find(i=>i.id===id);
        if(item.storagePath) try { await deleteObject(ref(storage, item.storagePath)); } catch(e){}
        await deleteDoc(doc(db, `users/${auth.currentUser.uid}/images/${id}`));
    };

    const extractDomain = (u) => { try { const d = new URL(u).hostname; return d.startsWith('www.') ? d.slice(4) : d; } catch(e) { return 'Unknown'; } };
    const isVideo = (u) => /youtu\.be|youtube\.com|vimeo\.com/i.test(u);
    const isInsta = (u) => /instagram\.com/i.test(u);
    const isImg = (u) => /\.(jpe?g|png|gif|webp|svg)/i.test(u);

    async function processText(text) {
        if(!window.ensureLogin()) return;
        const urlMatch = text.match(/https?:\/\/[^\s]+/);
        if(!urlMatch) return;
        const url = urlMatch[0];
        let type = 'link';
        if(isImg(url)) type = 'remote';
        else if(isVideo(url)) type = 'video';
        else if(isInsta(url)) type = 'instagram';
        
        await addDoc(collection(db, `users/${auth.currentUser.uid}/images`), {
            pageUrl: url, url: type==='remote'?url:null, type, sourceDomain: extractDomain(url), timestamp: new Date()
        });
        showFeedbackMessage('ë¶ë§ˆí¬ ì™„ë£Œ');
    }

    // ë“œë˜ê·¸ & ë¶™ì—¬ë„£ê¸°
    document.getElementById('drag-area').onclick = async () => { try { const t = await navigator.clipboard.readText(); processText(t); } catch(e) { showAlert('ê¶Œí•œ ë¶€ì¡±'); } };
    document.addEventListener('paste', async (e) => {
        if(document.activeElement.tagName==='TEXTAREA'||document.activeElement.tagName==='INPUT') return;
        const items = e.clipboardData.items;
        for(let item of items) {
            if(item.type.indexOf('image') !== -1) {
                if(!window.ensureLogin()) return;
                const file = item.getAsFile();
                const path = `users/${auth.currentUser.uid}/uploads/${Date.now()}_${file.name}`;
                const sRef = ref(storage, path);
                const res = await uploadBytes(sRef, file);
                const dUrl = await getDownloadURL(res.ref);
                await addDoc(collection(db, `users/${auth.currentUser.uid}/images`), { url: dUrl, type:'firebase_storage', storagePath: path, timestamp: new Date() });
                showFeedbackMessage('ì´ë¯¸ì§€ ì—…ë¡œë“œë¨');
                return;
            }
        }
        processText(e.clipboardData.getData('text'));
    });

    // 5. ê¸°íƒ€ ë²„íŠ¼
    document.getElementById('signInBtn').onclick = () => signInWithPopup(auth, provider);
    document.getElementById('signOutBtn').onclick = () => signOut(auth);
    document.getElementById('saveTaskBtn').onclick = async () => {
        if(!window.ensureLogin()) return;
        const id = window.currentTask?.id || Date.now().toString();
        const task = {
            id, title: document.getElementById('taskTitle').value,
            description: document.getElementById('taskDescription').value,
            date: document.getElementById('taskDate').value,
            category: document.getElementById('taskCategory').value,
            todoOnly: document.getElementById('todoOnly').checked,
            complete: window.currentTask?.complete || false
        };
        await setDoc(doc(db, `users/${auth.currentUser.uid}/customTasks/${id}`), task);
        closeModal();
    };
    document.getElementById('deleteTaskBtn').onclick = async () => {
        if(!window.currentTask?.id || !window.ensureLogin()) return;
        await deleteDoc(doc(db, `users/${auth.currentUser.uid}/customTasks/${window.currentTask.id}`));
        closeModal();
    };
    document.getElementById('prevMonthBtn').onclick = () => { currentDate.setMonth(currentDate.getMonth()-1); window.renderCalendar(); };
    document.getElementById('nextMonthBtn').onclick = () => { currentDate.setMonth(currentDate.getMonth()+1); window.renderCalendar(); };
    document.getElementById('closeImageModalBtn').onclick = () => document.getElementById('imageModal').style.display='none';
    
    // ì´ˆê¸°í™”
    window.renderCalendar();
  </script>
</body>
</html>
