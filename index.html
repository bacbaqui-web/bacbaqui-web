<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>만화 일정 관리</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:'Noto Sans KR',sans-serif;background:#000;color:#fff;padding:16px;display:flex;flex-direction:column;gap:0}
    .tab-content{display:none}.tab-content.active{display:flex;flex-direction:column;flex-grow:1}
    .section-card{background:#2a2a2a;border-radius:12px;padding:20px;box-shadow:inset 0 0 10px rgba(0,0,0,.3);text-align:center;width:100%;max-width:800px}
    .notepad-tabs{display:flex;justify-content:center;align-items:center;gap:1rem;width:100%;max-width:800px}
    .notepad-tab{background:#1a1a1a;padding:8px 16px;border-radius:8px 8px 0 0;cursor:pointer;transition:.2s;font-weight:700;color:#737373;font-size:.85rem}
    .notepad-tab.active,.notepad-tab:hover{background:#2a2a2a;color:#fff}
    .drag-area{border:2px dashed #4b4b4b;padding:24px;cursor:pointer}
    .drag-area.active{border-color:#6b6b6b;background-color:#2a2a2a}
    .image-card img{border-radius:8px}
    #imageModal .modal-content{
      background-color:transparent;
      padding:0;
      max-width:95vw;
      max-height:95vh;
      width:95vw;
      height:95vh;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    #modalImage{
      width:95vw;
      height:95vh;
      object-fit:contain;
    }
  </style>
</head>
<body>
  <div id="authBar" class="flex justify-end gap-2 mb-4">
    <span id="userInfo" class="text-sm opacity-80"></span>
    <button id="signInBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Google 로그인</button>
    <button id="signOutBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded hidden">로그아웃</button>
  </div>

  <div class="notepad-tabs mb-3">
    <button class="notepad-tab active" data-tab="calendar">달력</button>
    <button class="notepad-tab" data-tab="notes">메모</button>
    <button class="notepad-tab" data-tab="bookmarks">북마크</button>
  </div>

  <section id="calendar-section" class="section-card tab-content active">
    <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
  </section>

  <section id="notes-section" class="section-card tab-content">
    <textarea id="notesArea" class="w-full h-40 p-2 bg-black border border-gray-600 rounded"></textarea>
  </section>

  <section id="bookmarks-section" class="section-card tab-content">
    <div id="drag-area" class="drag-area">이미지 URL을 드래그하거나 붙여넣으세요 (Ctrl/Cmd+V)</div>
    <div id="image-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mt-4"></div>
  </section>

  <!-- 이미지 모달 -->
  <div id="imageModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
    <div class="modal-content relative">
      <button id="closeImageModalBtn" class="absolute top-2 right-2 text-white">X</button>
      <img id="modalImage" src="" alt="확대 이미지"/>
      <button id="goToPageBtn" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded">원본 페이지로 이동</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase 초기화
    const firebaseConfig = {
      apiKey: "AIzaSyCiwzde40jsz17CEz-rrMmmBrn-S6brdlE",
      authDomain: "comicschedule-dfec7.firebaseapp.com",
      projectId: "comicschedule-dfec7",
      storageBucket: "comicschedule-dfec7.appspot.com",
      messagingSenderId: "1084611276816",
      appId: "1:1084611276816:web:aca83237bafa971ed1fa95"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    const IMGBB_API_KEY = "f64175972f4e4178332db9ae8559969b";

    const signInBtn=document.getElementById("signInBtn");
    const signOutBtn=document.getElementById("signOutBtn");
    const userInfo=document.getElementById("userInfo");
    const dragArea=document.getElementById("drag-area");
    const imageGrid=document.getElementById("image-grid");
    const imageModal=document.getElementById("imageModal");
    const modalImage=document.getElementById("modalImage");
    const closeImageModalBtn=document.getElementById("closeImageModalBtn");
    const goToPageBtn=document.getElementById("goToPageBtn");

    function ensureLogin(){
      if(!auth.currentUser){ alert("로그인 필요"); return false; }
      return true;
    }
    async function cloudRefs(){
      const uid=auth.currentUser.uid;
      return { imagesCol: collection(db, `users/${uid}/images`) };
    }

    // ---- 이미지 추가 ----
    async function addUrlImage(url,pageUrl){
      if(!ensureLogin()) return;
      const { imagesCol } = await cloudRefs();
      await addDoc(imagesCol,{ url, pageUrl:pageUrl||null, type:"url", timestamp:new Date() });
    }
    async function addClipboardImage(file,pageUrl){
      if(!ensureLogin()) return;
      const form=new FormData();
      form.append("image",file);
      const res=await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{method:"POST",body:form});
      const json=await res.json();
      if(!json.success) throw new Error("imgbb 업로드 실패");
      const link=json.data.url;
      const { imagesCol }=await cloudRefs();
      await addDoc(imagesCol,{ url:link,pageUrl:pageUrl||null,type:"imgbb",timestamp:new Date() });
    }
    async function deleteImage(id){
      if(!ensureLogin()) return;
      const { imagesCol } = await cloudRefs();
      await deleteDoc(doc(imagesCol,id));
    }

    function renderImageBookmarks(){
      imageGrid.innerHTML="";
      (window.imageBookmarks||[]).forEach(d=>{
        const card=document.createElement("div");
        card.className="image-card relative";
        card.innerHTML=`<img src="${d.url}" class="w-full h-40 object-cover"/><button data-id="${d.id}" class="absolute top-2 right-2 bg-black/60 text-white px-2 py-1 rounded">삭제</button>`;
        card.querySelector("img").onclick=()=>{ modalImage.src=d.url; goToPageBtn.onclick=()=>{ if(d.pageUrl) window.open(d.pageUrl,"_blank"); }; imageModal.classList.remove("hidden"); imageModal.classList.add("flex");};
        card.querySelector("button").onclick=()=>deleteImage(d.id);
        imageGrid.appendChild(card);
      });
    }

    // ---- 이벤트 ----
    dragArea.addEventListener("dragover",e=>{ e.preventDefault(); dragArea.classList.add("active"); });
    dragArea.addEventListener("dragleave",()=>dragArea.classList.remove("active"));
    dragArea.addEventListener("drop",async e=>{
      e.preventDefault(); dragArea.classList.remove("active");
      if(!ensureLogin()) return;
      const url=e.dataTransfer.getData("URL");
      const html=e.dataTransfer.getData("text/html");
      const parsed=new DOMParser().parseFromString(html||"","text/html");
      const img=parsed.querySelector("img");
      if(img?.src){ await addUrlImage(img.src,img.src); return; }
      if(url && /\.(jpe?g|png|gif|webp|svg)$/i.test(url)){ await addUrlImage(url,url); return; }
      alert("유효한 이미지 URL을 드롭하세요.");
    });
    dragArea.addEventListener("paste",async e=>{
      e.preventDefault();
      if(!ensureLogin()) return;
      const items=[...(e.clipboardData?.items||[])];
      for(const it of items){
        if(it.kind==="file" && it.type.startsWith("image/")){
          const file=it.getAsFile();
          await addClipboardImage(file,null);
          return;
        }
      }
      alert("클립보드에 이미지가 없습니다.");
    });
    closeImageModalBtn.onclick=()=>imageModal.classList.add("hidden");

    // ---- 로그인 ----
    signInBtn.onclick=()=>signInWithPopup(auth,provider);
    signOutBtn.onclick=()=>signOut(auth);

    onAuthStateChanged(auth,async user=>{
      if(user){
        userInfo.textContent=user.email;
        signInBtn.classList.add("hidden"); signOutBtn.classList.remove("hidden");
        const { imagesCol }=await cloudRefs();
        onSnapshot(imagesCol,snap=>{ window.imageBookmarks=snap.docs.map(d=>({id:d.id,...d.data()})); renderImageBookmarks(); });
      }else{
        userInfo.textContent=""; signInBtn.classList.remove("hidden"); signOutBtn.classList.add("hidden");
        window.imageBookmarks=[]; renderImageBookmarks();
      }
    });
  </script>
</body>
</html>
